<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs, deleteDoc, addDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO ---
        const firebaseConfig = { apiKey: "AIzaSyBgKe2n4c6vL4-B0hSAGT16ELDUQLW0OTQ", authDomain: "atuacao2026.firebaseapp.com", projectId: "atuacao2026", storageBucket: "atuacao2026.firebasestorage.app", messagingSenderId: "563632231622", appId: "1:563632231622:web:ce3e04e43cc647614214f5" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const COLLECTIONS = {
            LOGS: `artifacts/atuacao2026/public/data/scooteiras_atividades`,
            AGENTS: `artifacts/atuacao2026/public/data/scooteiras_cadastro`
        };

        const SQUADS_CONFIG = [
            { id: "SC", color: "emerald", label: "SC" },
            { id: "CB", color: "indigo", label: "CB" },
            { id: "Rec. Crédito", color: "amber", label: "Rec. Crédito" },
            { id: "OJR", color: "purple", label: "OJR" },
            { id: "Monitoria", color: "cyan", label: "Monitoria" }
        ];

        const METAS_SQUAD = {
            "SC": { 1: 54, 2: 60, 3: 60, 4: 54, 5: 54, 6: 18, 0: 18 },
            "CB": { 1: 54, 2: 54, 3: 54, 4: 54, 5: 42, 6: 12, 0: 12 },
            "Rec. Crédito": { 1: 5, 2: 5, 3: 5, 4: 5, 5: 4, 6: 0, 0: 0 },
            "OJR": { 1: 5, 2: 5, 3: 5, 4: 5, 5: 4, 6: 0, 0: 0 }
        };

        let state = {
            agents: [],
            history: [],
            unsubscribeHistory: null
        };

        // --- UX HELPERS ---
        const showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type === 'error' ? 'bg-red-500' : 'bg-emerald-600'}`;
            el.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="${type === 'error' ? 'alert-circle' : 'check'}"></i> ${msg}</div>`;
            container.appendChild(el);
            lucide.createIcons();
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
        };

        const setLoading = (isLoading) => {
            const el = document.getElementById('loading-indicator');
            if(el) isLoading ? el.classList.remove('hidden') : el.classList.add('hidden');
        };

        const normalizarSquad = (s) => {
            if (!s) return "Outro";
            const val = s.toUpperCase().trim();
            if (val.includes("REC") || val.includes("CRED")) return "Rec. Crédito";
            if (val.includes("SC") || val.includes("SPECIAL")) return "SC";
            if (val.includes("CB") || val.includes("BLOQUEADO")) return "CB";
            if (val.includes("OJR") || val.includes("JURIDICO")) return "OJR";
            return s;
        };

        const getSquadColor = (squadName) => {
            const sq = SQUADS_CONFIG.find(s => s.id === squadName);
            return sq ? sq.color : "slate";
        };

        // --- INIT ---
        signInAnonymously(auth).then(() => {
            document.getElementById('auth-status').innerText = "ONLINE";
            document.getElementById('auth-status').classList.replace('bg-indigo-800/50', 'bg-emerald-600');
            loadInitialData();
        }).catch(err => {
            console.error(err);
            showToast("Erro ao conectar no Firebase", "error");
        });

        async function loadInitialData() {
            const d = new Date();
            const mesAtual = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('mes-select').value = mesAtual;
            document.getElementById('relatorio-mes-select').value = mesAtual;
            document.getElementById('data-atuacao').valueAsDate = new Date(); 
            
            document.getElementById('new-squad').innerHTML = SQUADS_CONFIG.map(s => `<option value="${s.id}">${s.label}</option>`).join('');
            
            await loadAgents(); 
            loadHistorico(); 
        }

        const loadAgents = async () => {
            setLoading(true);
            try {
                const snap = await getDocs(collection(db, COLLECTIONS.AGENTS));
                state.agents = [];
                snap.forEach(d => {
                    const a = d.data();
                    a.squadPadrao = normalizarSquad(a.squadPadrao);
                    a.status = a.status || 'Ativa';
                    state.agents.push(a);
                });
                renderAgentsTable();
                renderSelectionList();
                renderRelatorioSelect();
            } catch (e) {
                console.error(e);
                showToast("Erro ao carregar equipe.", "error");
            } finally {
                setLoading(false);
            }
        };

        // --- IMPORTAÇÃO EXCEL ---
        window.processarExcel = async (input) => {
            const file = input.files[0];
            if (!file) return;

            setLoading(true);
            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false });

                    if (jsonData.length === 0) throw new Error("Planilha vazia");

                    const batchPromises = [];
                    const duplicados = [];
                    let salvos = 0;
                    
                    const datasNoExcel = [...new Set(jsonData.map(row => formatarDataExcel(row['Data'])))];
                    
                    const registrosExistentes = new Set();
                    for(const d of datasNoExcel) {
                        if(!d) continue;
                        const q = query(collection(db, COLLECTIONS.LOGS), where("data", "==", d));
                        const snap = await getDocs(q);
                        snap.forEach(doc => registrosExistentes.add(`${doc.data().scooteira}_${d}`));
                    }

                    for (const row of jsonData) {
                        const nome = row['Nome'] || row['Scooteira'] || row['Agente'];
                        const dataBr = row['Data']; 
                        const entrada = row['Entrada'] || row['Inicio'];
                        const saida = row['Saida'] || row['Fim'];
                        const squad = row['Squad'] || 'Outro';

                        if (!nome || !dataBr || !entrada || !saida) continue;

                        const dataIso = formatarDataExcel(dataBr);
                        
                        if (registrosExistentes.has(`${nome}_${dataIso}`)) {
                            duplicados.push(`${nome} (${dataIso})`);
                            continue;
                        }

                        const d1 = new Date(`2000-01-01T${entrada}`);
                        const d2 = new Date(`2000-01-01T${saida}`);
                        let horas = (d2 - d1) / 3600000;
                        if (horas < 0) horas += 24;

                        batchPromises.push(addDoc(collection(db, COLLECTIONS.LOGS), {
                            data: dataIso,
                            mes: dataIso.substring(0, 7),
                            scooteira: nome,
                            squad: normalizarSquad(squad),
                            entrada: entrada,
                            saida: saida,
                            horas: parseFloat(horas.toFixed(2)),
                            timestamp: new Date()
                        }));
                        salvos++;
                        registrosExistentes.add(`${nome}_${dataIso}`);
                    }

                    await Promise.all(batchPromises);
                    
                    let msg = `${salvos} registros importados!`;
                    if(duplicados.length > 0) msg += ` ${duplicados.length} duplicados ignorados.`;
                    
                    alert(msg);
                    input.value = ""; 
                    
                } catch (err) {
                    console.error(err);
                    alert("Erro ao ler Excel. Verifique o formato (Colunas: Data, Nome, Squad, Entrada, Saida)");
                } finally {
                    setLoading(false);
                }
            };
            reader.readAsArrayBuffer(file);
        };

        function formatarDataExcel(val) {
            if(!val) return null;
            if(val.includes('/')) {
                const parts = val.split('/');
                if(parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return val;
        }

        // --- RENDERIZAÇÃO ---
        const renderAgentsTable = () => {
            const tbody = document.getElementById('cadastro-list-body');
            tbody.innerHTML = state.agents.sort((a,b) => a.nome.localeCompare(b.nome)).map(a => `
                <tr class="hover:bg-gray-50 border-b group transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-800">${a.nome}</div>
                        <div class="text-xs text-gray-400">Pseudo: ${a.pseudo} • ${a.squadPadrao}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <select onchange="window.toggleStatus('${a.nome}', this.value)" class="text-xs font-bold uppercase rounded-full px-2 py-1 border-0 cursor-pointer focus:ring-2 ${a.status === 'Ativa' ? 'bg-emerald-100 text-emerald-800' : 'bg-red-100 text-red-800'}">
                            <option value="Ativa" ${a.status === 'Ativa' ? 'selected' : ''}>Ativa</option>
                            <option value="Distrato" ${a.status === 'Distrato' ? 'selected' : ''}>Distrato</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="window.deleteAgent('${a.nome}')" class="text-gray-300 hover:text-red-500 transition-colors p-2 rounded hover:bg-red-50">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>`).join('');
            lucide.createIcons();
        };

        window.toggleStatus = async (nome, novoStatus) => {
            try {
                await updateDoc(doc(db, COLLECTIONS.AGENTS, nome), { status: novoStatus });
                showToast("Status atualizado!");
                loadAgents(); 
            } catch(e) { showToast("Erro ao atualizar.", "error"); }
        };

        window.loadHistorico = () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;

            setLoading(true);
            if(state.unsubscribeHistory) state.unsubscribeHistory(); 

            const q = query(collection(db, COLLECTIONS.LOGS), where("mes", "==", mes));
            
            state.unsubscribeHistory = onSnapshot(q, (snapshot) => {
                state.history = [];
                snapshot.forEach(d => {
                    const item = { id: d.id, ...d.data() };
                    item.squad = normalizarSquad(item.squad);
                    state.history.push(item);
                });
                
                state.history.sort((a,b) => 
                    b.data.localeCompare(a.data) ||       
                    b.entrada.localeCompare(a.entrada) || 
                    a.squad.localeCompare(b.squad) ||     
                    a.scooteira.localeCompare(b.scooteira)
                );
                
                renderHistoricoTable();
                updateStats();
                setLoading(false);
                
                const activeTab = document.querySelector('.tab-active').id;
                if(activeTab === 'tab-capacidade') window.renderCapacityAccordion();
                if(activeTab === 'tab-trocas') window.renderTrocasAccordion();

            }, (error) => {
                console.error(error);
                showToast("Erro ao sincronizar histórico.", "error");
                setLoading(false);
            });
        };

        const renderHistoricoTable = () => {
            const tbody = document.getElementById('historico-body');
            if(state.history.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-400 italic">Nenhum registro encontrado neste mês.</td></tr>`;
                return;
            }

            tbody.innerHTML = state.history.map(item => {
                const agente = state.agents.find(a => a.nome === item.scooteira || a.pseudo === item.scooteira);
                let contratado = 0;
                
                const nomeExibicao = agente ? agente.nome : item.scooteira;
                const pseudoExibicao = (agente && agente.pseudo && agente.pseudo !== agente.nome) ? agente.pseudo : "";

                if (agente) {
                    const h1 = new Date(`2000-01-01T${agente.entradaPadrao}`);
                    const h2 = new Date(`2000-01-01T${agente.saidaPadrao}`);
                    contratado = (h2 - h1) / 3600000;
                    if (contratado < 0) contratado += 24;
                }
                
                const diff = Math.abs(item.horas - contratado);
                let corBadge = "bg-emerald-100 text-emerald-800"; 
                if (diff > 0.1) { 
                    corBadge = item.horas < contratado ? "bg-red-100 text-red-800" : "bg-amber-100 text-amber-800";
                }
                const colorName = getSquadColor(item.squad);

                return `
                <tr class="hover:bg-gray-50 border-b transition-colors">
                    <td class="px-6 py-4 text-gray-600 font-mono text-xs">${item.data.split('-').reverse().join('/')}</td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-700">${nomeExibicao}</div>
                        ${pseudoExibicao ? `<div class="text-xs text-gray-400 font-normal">${pseudoExibicao}</div>` : ''}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider bg-${colorName}-100 text-${colorName}-700 border border-${colorName}-200">
                            ${item.squad}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-xs text-center font-mono text-gray-500">${item.entrada} - ${item.saida}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-block px-2 py-1 rounded text-xs font-bold ${corBadge}">
                            ${item.horas.toFixed(2)}h
                        </span>
                        <span class="text-[10px] text-gray-400 ml-1">/ ${contratado.toFixed(1)}h</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="window.deleteLog('${item.id}')" class="text-gray-300 hover:text-red-500 p-2 hover:bg-red-50 rounded transition-all" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        };

        const updateStats = () => {
            const totals = {};
            state.history.forEach(i => { totals[i.squad] = (totals[i.squad] || 0) + i.horas; });
            document.getElementById('resumo-squads').innerHTML = SQUADS_CONFIG.map(s => {
                const val = (totals[s.id] || 0);
                return `
                <div class="bg-white p-4 rounded-xl border-l-4 border-${s.color}-500 shadow-sm flex flex-col justify-between">
                    <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">${s.id}</div>
                    <div class="text-2xl font-bold text-gray-700">${val.toFixed(1)}<span class="text-sm font-normal text-gray-400 ml-1">h</span></div>
                </div>`
            }).join('');
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.renderSelectionList = () => {
            const ativas = state.agents.filter(a => a.status === 'Ativa');
            const container = document.getElementById('agentes-checkbox-list');
            container.innerHTML = ativas.map(a => `
                <label class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer border border-transparent hover:border-gray-200 transition-all">
                    <input type="checkbox" value="${a.nome}" class="agent-checkbox w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                    <div>
                        <span class="text-sm font-bold text-gray-700 block">${a.nome}</span>
                        <span class="text-xs text-gray-400">${a.squadPadrao}</span>
                    </div>
                </label>`).join('');
        };

        window.filterSelectionList = () => {
            const term = document.getElementById('search-agent').value.toLowerCase();
            const labels = document.querySelectorAll('#agentes-checkbox-list label');
            labels.forEach(lbl => {
                const txt = lbl.innerText.toLowerCase();
                lbl.style.display = txt.includes(term) ? 'flex' : 'none';
            });
        };

        window.handleEntrySubmission = () => {
            const data = document.getElementById('data-atuacao').value;
            const checkboxes = document.querySelectorAll('.agent-checkbox:checked');
            
            if (!data) return showToast("Selecione a data de atuação.", "error");
            if (checkboxes.length === 0) return showToast("Selecione pelo menos uma pessoa.", "error");

            const selectedNames = Array.from(checkboxes).map(cb => cb.value);
            
            document.getElementById('agentes-detalhes-container').innerHTML = selectedNames.map(nome => {
                const a = state.agents.find(x => x.nome === nome);
                const color = getSquadColor(a.squadPadrao);
                return `
                <div class="confirm-row p-4 border rounded-xl bg-white shadow-sm relative flex flex-col gap-3" data-nome="${a.nome}">
                    <button type="button" onclick="this.parentElement.remove()" class="absolute top-3 right-3 text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <div class="flex items-center gap-2">
                         <div class="font-bold text-gray-800">${a.nome}</div>
                         <span class="text-[10px] bg-gray-100 px-2 rounded text-gray-500">${a.squadPadrao}</span>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-400">Entrada</label>
                            <input type="time" value="${a.entradaPadrao}" class="confirm-ent w-full border border-gray-300 p-2 rounded-lg text-sm focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-400">Saída</label>
                            <input type="time" value="${a.saidaPadrao}" class="confirm-sai w-full border border-gray-300 p-2 rounded-lg text-sm focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-400">Squad Real</label>
                            <select class="confirm-squad w-full border border-gray-300 p-2 rounded-lg text-sm bg-white">
                                ${SQUADS_CONFIG.map(s => `<option value="${s.id}" ${s.id === a.squadPadrao ? 'selected' : ''}>${s.label}</option>`).join('')}
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            lucide.createIcons();
            window.openModal('details-modal');
            
            const btnLabel = document.getElementById('selected-count-label');
            btnLabel.innerText = `${selectedNames.length} Selecionada(s)`;
            btnLabel.classList.add('text-indigo-600', 'font-bold');
        };

        // --- SALVAMENTO MANUAL ---
        document.getElementById('details-form').onsubmit = async (e) => {
            e.preventDefault();
            const dataStr = document.getElementById('data-atuacao').value;
            const rows = document.querySelectorAll('.confirm-row');
            
            if(rows.length === 0) return window.closeModal('details-modal');

            setLoading(true);

            try {
                const qCheck = query(collection(db, COLLECTIONS.LOGS), where("data", "==", dataStr));
                const snapCheck = await getDocs(qCheck);
                
                const nomesJaRegistrados = new Set();
                snapCheck.forEach(doc => {
                    const d = doc.data();
                    nomesJaRegistrados.add(d.scooteira);
                });

                const duplicados = [];
                const paraSalvar = [];

                for (const row of rows) {
                    const nome = row.dataset.nome;
                    if (nomesJaRegistrados.has(nome)) {
                        duplicados.push(nome); 
                        continue; 
                    }

                    const ent = row.querySelector('.confirm-ent').value;
                    const sai = row.querySelector('.confirm-sai').value;
                    const sq = row.querySelector('.confirm-squad').value;
                    
                    const d1 = new Date(`2000-01-01T${ent}`);
                    const d2 = new Date(`2000-01-01T${sai}`);
                    let diff = (d2 - d1) / 3600000;
                    if (diff < 0) diff += 24; 

                    if(isNaN(diff)) continue;

                    paraSalvar.push({ 
                        data: dataStr, 
                        mes: dataStr.substring(0, 7), 
                        scooteira: nome, 
                        squad: sq, 
                        entrada: ent, 
                        saida: sai, 
                        horas: parseFloat(diff.toFixed(2)), 
                        timestamp: new Date() 
                    });
                }
                
                if (duplicados.length > 0) {
                    alert(`⚠️ ATENÇÃO: Os seguintes nomes JÁ TÊM registro no dia ${dataStr.split('-').reverse().join('/')}:\n\n${duplicados.join(', ')}\n\nNenhum registro foi salvo.`);
                    setLoading(false);
                    return; 
                }

                if (paraSalvar.length > 0) {
                    await Promise.all(paraSalvar.map(dados => addDoc(collection(db, COLLECTIONS.LOGS), dados)));
                    showToast(`${paraSalvar.length} registros salvos com sucesso!`);
                } else {
                    showToast("Nenhum dado válido para salvar.", "error");
                }
                
                document.getElementById('selected-count-label').innerText = "Selecionar Scooteiras...";
                document.getElementById('selected-count-label').classList.remove('text-indigo-600', 'font-bold');
                document.querySelectorAll('.agent-checkbox').forEach(cb => cb.checked = false);
                window.closeModal('details-modal');

            } catch(error) {
                console.error(error);
                showToast("Erro ao processar dados.", "error");
            } finally {
                setLoading(false);
            }
        };

        window.deleteLog = async (id) => { 
            if(confirm("Tem certeza que deseja excluir este registro?")) { 
                try {
                    await deleteDoc(doc(db, COLLECTIONS.LOGS, id)); 
                    showToast("Registro excluído.");
                } catch(e) { showToast("Erro ao excluir.", "error"); }
            } 
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.className = "flex-1 py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap focus:outline-none";
            });
            const content = document.getElementById(`content-${tabId}`);
            const btn = document.getElementById(`tab-${tabId}`);
            content.classList.remove('hidden');
            btn.className = "flex-1 py-4 px-6 text-sm font-semibold transition-all tab-active whitespace-nowrap focus:outline-none";
            if (tabId === 'capacidade') window.renderCapacityAccordion();
            if (tabId === 'trocas') window.renderTrocasAccordion();
            lucide.createIcons();
        };

        window.renderRelatorioSelect = () => {
             document.getElementById('relatorio-agente-select').innerHTML = '<option value="" disabled selected>Escolher...</option>' + 
                state.agents.sort((a,b) => a.nome.localeCompare(b.nome)).map(a => `<option value="${a.nome}">${a.nome}</option>`).join('');
        };

        function getISOWeek(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        window.renderCapacityAccordion = () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;
            const [ano, mesNum] = mes.split('-').map(Number);
            const container = document.getElementById('capacity-accordion-container');
            container.innerHTML = "";
            if (state.history.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8 italic">Sem dados neste mês para calcular a capacidade.</div>';
                return;
            }
            const dataMap = {};
            state.history.forEach(log => {
                if(!dataMap[log.data]) dataMap[log.data] = {};
                dataMap[log.data][log.squad] = (dataMap[log.data][log.squad] || 0) + log.horas;
            });
            const weeks = {};
            const first = new Date(ano, mesNum - 1, 1);
            const last = new Date(ano, mesNum, 0);
            for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
                const w = getISOWeek(new Date(d));
                if (!weeks[w]) weeks[w] = [];
                weeks[w].push(new Date(d));
            }
            Object.keys(weeks).forEach(wNum => {
                const days = weeks[wNum];
                const weekId = `week-${wNum}`;
                const header = document.createElement('div');
                header.className = "cursor-pointer bg-white border border-gray-200 p-4 rounded-lg mb-2 hover:border-indigo-500 hover:shadow-md transition-all flex justify-between items-center";
                header.innerHTML = `<div><span class="font-bold text-indigo-700">Semana ${wNum}</span></div><i data-lucide="chevron-down" class="text-gray-400 w-4 h-4"></i>`;
                header.onclick = () => {
                    const content = document.getElementById(weekId);
                    content.classList.toggle('hidden');
                    lucide.createIcons();
                };
                const content = document.createElement('div');
                content.id = weekId;
                content.className = "hidden mb-6 border border-gray-200 border-t-0 rounded-b-lg overflow-x-auto bg-white p-2 shadow-inner";
                let tableHtml = `<table class="w-full text-xs"><thead><tr><th class="p-2 text-left bg-gray-50 border">Dia</th>`;
                SQUADS_CONFIG.forEach(s => tableHtml += `<th class="p-2 text-center bg-gray-50 border font-bold text-${s.color}-700">${s.id}</th>`);
                tableHtml += `</tr></thead><tbody>`;
                days.forEach(dateObj => {
                    const dateKey = dateObj.toISOString().split('T')[0];
                    const dow = dateObj.getDay(); 
                    tableHtml += `<tr><td class="p-2 border font-bold bg-gray-50 text-gray-600">${dateObj.toLocaleDateString('pt-BR', {day:'2-digit', weekday:'short'})}</td>`;
                    SQUADS_CONFIG.forEach(sq => {
                        const squadName = sq.id;
                        const actual = (dataMap[dateKey] && dataMap[dateKey][squadName]) ? dataMap[dateKey][squadName] : 0;
                        const target = (METAS_SQUAD[squadName] && METAS_SQUAD[squadName][dow] !== undefined) ? METAS_SQUAD[squadName][dow] : 0;
                        let cellClass = "p-2 border text-center";
                        let badgeClass = "text-gray-400";
                        if (target > 0) {
                            if (actual < target) {
                                cellClass += " bg-red-50 text-red-800";
                                badgeClass = "text-red-300";
                            } else if (actual > target) {
                                cellClass += " bg-amber-50 text-amber-800";
                                badgeClass = "text-amber-300";
                            } else {
                                cellClass += " bg-emerald-50 text-emerald-800";
                                badgeClass = "text-emerald-300";
                            }
                        }
                        tableHtml += `<td class="${cellClass}"><div class="font-bold">${actual.toFixed(1)}h</div><div class="text-[9px] ${badgeClass}">Meta: ${target}</div></td>`;
                    });
                    tableHtml += `</tr>`;
                });
                content.innerHTML = tableHtml + `</tbody></table>`;
                container.appendChild(header);
                container.appendChild(content);
            });
            lucide.createIcons();
        };

        // --- ATUALIZAÇÃO DA LÓGICA DE TROCAS ---
        window.renderTrocasAccordion = () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;
            const [ano, mesNum] = mes.split('-').map(Number);
            const container = document.getElementById('trocas-accordion-container');
            container.innerHTML = "";
            const dailyLogs = {};
            state.history.forEach(log => { if(!dailyLogs[log.data]) dailyLogs[log.data] = []; dailyLogs[log.data].push(log); });
            const weeks = {};
            const first = new Date(ano, mesNum - 1, 1);
            const last = new Date(ano, mesNum, 0);
            for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
                const w = getISOWeek(new Date(d));
                if (!weeks[w]) weeks[w] = [];
                weeks[w].push(new Date(d));
            }
            Object.keys(weeks).forEach(wNum => {
                const days = weeks[wNum];
                const weekId = `trocas-week-${wNum}`;
                const header = document.createElement('div');
                header.className = "cursor-pointer bg-white border border-gray-200 p-4 rounded-lg mb-2 hover:border-indigo-500 hover:shadow-md transition-all flex justify-between items-center";
                header.innerHTML = `<div><span class="font-bold text-indigo-700">Trocas Semana ${wNum}</span></div><i data-lucide="chevron-down" class="text-gray-400 w-4 h-4"></i>`;
                header.onclick = () => {
                    document.getElementById(weekId).classList.toggle('hidden');
                    lucide.createIcons();
                };
                const content = document.createElement('div');
                content.id = weekId;
                content.className = "hidden mb-4 p-4 bg-white border border-t-0 rounded-b-lg shadow-inner";
                let trocasHtml = "";
                
                days.forEach(dateObj => {
                    const dateKey = dateObj.toISOString().split('T')[0];
                    const logsDia = dailyLogs[dateKey] || [];
                    const diaSeman = dateObj.toLocaleDateString('pt-BR', { weekday: 'short' }).toLowerCase().replace('.',''); 
                    
                    // LÓGICA DE "EXTRA":
                    // 1. Trabalha em dia diferente do turno padrão
                    // 2. OU Trabalha no dia certo, mas em horário muito diferente (> 2h de diferença no início)
                    const extras = logsDia.filter(l => {
                        const a = state.agents.find(ag => ag.nome === l.scooteira || ag.pseudo === l.scooteira);
                        if (!a) return false;
                        
                        const turno = a.turnoPadrao.toLowerCase();
                        const ehDiaDeTrabalho = turno.includes(diaSeman) || turno.includes("seg-sex");
                        
                        // Verifica se o horário é diferente
                        let horarioDiferente = false;
                        if(ehDiaDeTrabalho) {
                            const entradaPadrao = parseInt(a.entradaPadrao.split(':')[0]);
                            const entradaReal = parseInt(l.entrada.split(':')[0]);
                            // Se a diferença for maior que 2 horas, considera cobertura de outro turno
                            if(Math.abs(entradaReal - entradaPadrao) > 2) {
                                horarioDiferente = true;
                            }
                        }

                        // É Extra se: NÃO é dia de trabalho OU (É dia de trabalho MAS horário é diferente)
                        return !ehDiaDeTrabalho || horarioDiferente;
                    });
                    
                    // LÓGICA DE "AUSENTE":
                    // Deveria trabalhar hoje mas não tem registro
                    const ausentes = state.agents.filter(a => {
                        if (a.status === 'Distrato') return false;
                        const turno = a.turnoPadrao.toLowerCase();
                        const ehDiaDeTrabalho = turno.includes(diaSeman) || turno.includes("seg-sex");
                        const trabalhou = logsDia.some(l => l.scooteira === a.nome || l.scooteira === a.pseudo);
                        
                        // Se deveria trabalhar e não trabalhou, está ausente
                        return ehDiaDeTrabalho && !trabalhou;
                    });

                    if(extras.length > 0 && ausentes.length > 0) {
                        let diaHtml = "";
                        
                        extras.forEach(ex => {
                            const exSq = normalizarSquad(ex.squad);
                            
                            // Procura alguém ausente DO MESMO SQUAD
                            const indexPar = ausentes.findIndex(au => normalizarSquad(au.squadPadrao) === exSq);
                            
                            const agentEx = state.agents.find(ag => ag.nome === ex.scooteira || ag.pseudo === ex.scooteira);
                            const nomeEx = agentEx ? agentEx.nome.split(' ')[0] : ex.scooteira.split(' ')[0];

                            if(indexPar !== -1) {
                                const par = ausentes[indexPar]; // Pega a pessoa
                                const nomePar = par.nome.split(' ')[0];

                                diaHtml += `
                                <div class="flex items-center gap-3 p-3 bg-indigo-50 rounded-lg mb-2 border-l-4 border-indigo-500">
                                    <i data-lucide="arrow-right-left" class="text-indigo-400 w-4 h-4"></i>
                                    <div class="text-sm">
                                        <strong class="text-indigo-800">${nomeEx}</strong> cobriu 
                                        <strong class="text-gray-600">${nomePar}</strong> 
                                        <span class="text-xs text-gray-500 bg-gray-100 px-1 rounded ml-1">(${par.entradaPadrao} - ${par.saidaPadrao})</span>
                                        no squad ${exSq}.
                                    </div>
                                </div>`;
                                
                                // REMOVE A PESSOA DA LISTA DE AUSENTES PARA NÃO SER COBERTA DE NOVO
                                ausentes.splice(indexPar, 1);
                            }
                        });
                        
                        if(diaHtml) trocasHtml += `<div class="mb-4"><h4 class="font-bold text-xs text-gray-400 uppercase mb-2 border-b pb-1">${dateObj.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'})} - ${dateObj.toLocaleDateString('pt-BR', {weekday:'long'})}</h4>${diaHtml}</div>`;
                    }
                });
                content.innerHTML = trocasHtml || `<p class="text-xs text-gray-400 italic text-center py-2">Nenhuma troca óbvia detectada nesta semana.</p>`;
                container.appendChild(header);
                container.appendChild(content);
            });
            lucide.createIcons();
        };

        window.loadRelatorioIndividual = async () => {
            const nome = document.getElementById('relatorio-agente-select').value;
            const mes = document.getElementById('relatorio-mes-select').value;
            const table = document.getElementById('relatorio-body');
            const cards = document.getElementById('relatorio-resumo-cards');
            if(!nome || !mes) return;
            table.innerHTML = '<tr><td colspan="5" class="text-center py-8"><div class="loader mx-auto"></div></td></tr>';
            cards.classList.add('hidden');
            try {
                const q = query(collection(db, COLLECTIONS.LOGS), where("mes", "==", mes));
                const snap = await getDocs(q);
                const agente = state.agents.find(a => a.nome === nome);
                const pseudo = agente ? agente.pseudo : "";
                const list = [];
                let total = 0;
                const sqTotal = {};
                snap.forEach(d => {
                    const data = d.data();
                    if(data.scooteira === nome || data.scooteira === pseudo) {
                        const sq = normalizarSquad(data.squad);
                        list.push({ ...data, squad: sq });
                        total += data.horas;
                        sqTotal[sq] = (sqTotal[sq] || 0) + data.horas;
                    }
                });
                list.sort((a,b) => b.data.localeCompare(a.data));
                cards.classList.remove('hidden');
                let sqHtml = "";
                Object.keys(sqTotal).forEach(s => { 
                    const color = getSquadColor(s);
                    sqHtml += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-${color}-500">
                        <div class="text-xs text-gray-400 uppercase font-bold">${s}</div>
                        <div class="text-xl font-bold text-gray-700">${sqTotal[s].toFixed(1)}h</div>
                    </div>`; 
                });
                cards.innerHTML = `
                <div class="bg-indigo-600 p-4 rounded-xl shadow-md text-white">
                    <div class="text-xs opacity-80 uppercase font-bold">Total Mês</div>
                    <div class="text-3xl font-bold">${total.toFixed(1)}h</div>
                </div>${sqHtml}`;
                if(list.length === 0) {
                    table.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400 italic">Nenhum registro encontrado para esta scooteira neste mês.</td></tr>';
                } else {
                    table.innerHTML = list.map(i => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4">${i.data.split('-').reverse().join('/')}</td>
                            <td class="px-6 py-4"><span class="text-xs font-bold bg-gray-100 px-2 py-1 rounded text-gray-600">${i.squad}</span></td>
                            <td class="px-6 py-4 text-center text-gray-500 font-mono text-xs">${i.entrada}</td>
                            <td class="px-6 py-4 text-center text-gray-500 font-mono text-xs">${i.saida}</td>
                            <td class="px-6 py-4 font-bold text-center text-indigo-600">${i.horas.toFixed(2)}h</td>
                        </tr>`).join('');
                }
            } catch (e) {
                console.error(e);
                showToast("Erro ao gerar relatório.", "error");
                table.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Erro ao buscar dados.</td></tr>';
            }
        };

        document.getElementById('add-agent-form').onsubmit = async (e) => {
            e.preventDefault();
            const nome = document.getElementById('new-nome').value.trim();
            if(!nome) return;
            setLoading(true);
            try {
                await setDoc(doc(db, COLLECTIONS.AGENTS, nome), {
                    nome: nome, 
                    pseudo: document.getElementById('new-pseudo').value,
                    squadPadrao: document.getElementById('new-squad').value, 
                    turnoPadrao: document.getElementById('new-turno').value,
                    entradaPadrao: document.getElementById('new-entrada').value, 
                    saidaPadrao: document.getElementById('new-saida').value,
                    status: 'Ativa'
                });
                showToast("Scooteira cadastrada com sucesso!");
                document.getElementById('add-agent-form').reset();
                loadAgents(); 
            } catch(e) {
                console.error(e);
                showToast("Erro ao cadastrar.", "error");
            } finally {
                setLoading(false);
            }
        };

        window.deleteAgent = async (id) => { 
            if(confirm(`Excluir ${id} do cadastro permanentemente?`)) { 
                try {
                    await deleteDoc(doc(db, COLLECTIONS.AGENTS, id)); 
                    showToast("Cadastro removido.");
                    loadAgents();
                } catch(e) { showToast("Erro ao excluir.", "error"); }
            } 
        };

        lucide.createIcons();
    </script>
