     <!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Atuação - Scooto</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚜️</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }

        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #4f46e5; background-color: #f8fafc; }

        /* Status Colors */
        .cap-warn-low { background-color: #fee2e2; color: #991b1b; }
        .cap-warn-high { background-color: #ffedd5; color: #9a3412; }
        .cap-ok { background-color: #dcfce7; color: #166534; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #4f46e5; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-size: 0.85rem; font-weight: 600; min-width: 250px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8 pb-24">

    <div id="toast-container"></div>

    <div id="app" class="w-full max-w-full sm:max-w-7xl bg-white rounded-2xl shadow-xl overflow-hidden relative fade-in">
        
        <header class="bg-indigo-600 p-6 sm:p-8 text-white shadow-md relative z-10">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <div class="flex items-center gap-3">
                        <span class="text-3xl filter drop-shadow-md">⚜️</span>
                        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-white">Dash Atuação - Scooto</h1>
                    </div>
                    <p class="text-indigo-100 text-xs sm:text-sm mt-1 ml-11 opacity-90">Gestão de Horas x Squads</p>
                </div>
                <div class="flex items-center gap-3">
                    <div id="loading-indicator" class="hidden"><div class="loader"></div></div>
                    <div id="auth-status" class="bg-indigo-800/50 border border-indigo-500 py-1 px-3 rounded text-xs font-mono backdrop-blur-sm">Conectando...</div>
                </div>
            </div>
        </header>

        <nav class="flex border-b border-gray-200 bg-gray-50 overflow-x-auto sticky top-0 z-10 scrollbar-hide">
            <button id="tab-registro" class="flex-1 py-4 px-6 text-sm font-semibold transition-all tab-active whitespace-nowrap focus:outline-none" onclick="window.switchTab('registro')">Registro Diário</button>
            <button id="tab-capacidade" class="flex-1 py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap focus:outline-none" onclick="window.switchTab('capacidade')">Capacidade & Metas</button>
            <button id="tab-trocas" class="flex-1 py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap focus:outline-none" onclick="window.switchTab('trocas')">Trocas</button>
            <button id="tab-relatorio" class="flex-1 py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap focus:outline-none" onclick="window.switchTab('relatorio')">Relatórios</button>
            <button id="tab-cadastro" class="flex-1 py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap focus:outline-none" onclick="window.switchTab('cadastro')">Equipe</button>
        </nav>

        <div class="p-6 sm:p-8 min-h-[500px] bg-white">

            <div id="content-registro" class="fade-in">
                <div class="bg-indigo-50/50 border border-indigo-100 rounded-xl p-6 mb-8 shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-3">
                            <label class="block text-xs font-bold text-gray-600 mb-1 uppercase tracking-wide">Data Atuação</label>
                            <input type="date" id="data-atuacao" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all shadow-sm">
                        </div>
                        <div class="md:col-span-6">
                            <label class="block text-xs font-bold text-gray-600 mb-1 uppercase tracking-wide">Quem trabalhou?</label>
                            <button onclick="window.openModal('selection-modal')" class="w-full p-2.5 bg-white border border-gray-300 hover:border-indigo-400 rounded-lg text-left text-sm flex justify-between items-center shadow-sm transition-colors group">
                                <span id="selected-count-label" class="text-gray-700 group-hover:text-indigo-700">Selecionar Scooteiras...</span>
                                <i data-lucide="users" class="w-4 h-4 text-gray-400 group-hover:text-indigo-500"></i>
                            </button>
                        </div>
                        <div class="md:col-span-3">
                            <button onclick="window.handleEntrySubmission()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg font-bold shadow-md transition-all active:scale-95 flex justify-center items-center gap-2">
                                <i data-lucide="clock" class="w-4 h-4"></i> Lançar Horas
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="history" class="w-5 h-5 text-indigo-500"></i> Histórico</h2>
                    <input type="month" id="mes-select" onchange="window.loadHistorico()" class="border border-gray-300 rounded-lg p-2 text-sm shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                
                <div id="resumo-squads" class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-8"></div>

                <div class="overflow-hidden bg-white rounded-xl shadow border border-gray-200">
                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="w-full text-sm text-left relative">
                            <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-6 py-3 font-semibold">Data</th>
                                    <th class="px-6 py-3 font-semibold">Nome / Pseudo</th>
                                    <th class="px-6 py-3 font-semibold">Squad</th>
                                    <th class="px-6 py-3 text-center font-semibold">Horário</th>
                                    <th class="px-6 py-3 font-bold text-center font-semibold">Total / Contratado</th>
                                    <th class="px-6 py-3 text-right font-semibold">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="historico-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-capacidade" class="hidden fade-in">
                <div class="bg-blue-50 border border-blue-100 p-4 rounded-lg mb-6 flex items-start gap-3">
                    <i data-lucide="info" class="w-5 h-5 text-blue-500 mt-0.5"></i>
                    <p class="text-sm text-blue-800">Visualização de metas semanais vs horas realizadas por Squad. Clique nas semanas para expandir.</p>
                </div>
                <div id="capacity-accordion-container" class="space-y-4"></div>
            </div>

            <div id="content-trocas" class="hidden fade-in">
                <div id="trocas-accordion-container" class="space-y-4"></div>
            </div>

            <div id="content-relatorio" class="hidden fade-in">
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Scooteira</label>
                            <select id="relatorio-agente-select" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-sm shadow-sm" onchange="window.loadRelatorioIndividual()"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Mês</label>
                            <input type="month" id="relatorio-mes-select" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-sm shadow-sm" onchange="window.loadRelatorioIndividual()">
                        </div>
                    </div>
                </div>
                <div id="relatorio-resumo-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 hidden"></div>
                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                            <tr><th class="px-6 py-3">Data</th><th class="px-6 py-3">Squad</th><th class="px-6 py-3 text-center">Entrada</th><th class="px-6 py-3 text-center">Saída</th><th class="px-6 py-3 font-bold text-center">Total</th></tr>
                        </thead>
                        <tbody id="relatorio-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-cadastro" class="hidden fade-in">
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-8">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">Adicionar Nova Scooteira</h3>
                    <form id="add-agent-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <input type="text" id="new-nome" placeholder="Nome Completo" class="p-2 border rounded text-sm w-full" required>
                        <input type="text" id="new-pseudo" placeholder="Pseudo (Ex: Ana S)" class="p-2 border rounded text-sm w-full" required>
                        <select id="new-squad" class="p-2 border rounded text-sm w-full bg-white"></select>
                        <input type="text" id="new-turno" placeholder="Ex: Seg-Sex" class="p-2 border rounded text-sm w-full">
                        <input type="time" id="new-entrada" value="08:00" class="p-2 border rounded text-sm w-full">
                        <input type="time" id="new-saida" value="14:00" class="p-2 border rounded text-sm w-full">
                        <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 transition-colors text-white py-2 rounded font-bold lg:col-span-6 shadow-sm flex justify-center items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Salvar Cadastro
                        </button>
                    </form>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200 max-h-[600px]">
                    <table class="w-full text-sm text-left relative">
                        <thead class="bg-gray-50 text-xs text-gray-500 uppercase sticky top-0 z-10 shadow-sm">
                            <tr><th class="px-6 py-3">Nome / Pseudo</th><th class="px-6 py-3 text-center">Status</th><th class="px-6 py-3 text-right">Ações</th></tr>
                        </thead>
                        <tbody id="cadastro-list-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="selection-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 transition-opacity">
        <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-2xl transform scale-100 transition-transform">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-gray-800">Selecionar Equipe</h3>
                <button onclick="window.closeModal('selection-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <input type="text" id="search-agent" placeholder="Buscar nome..." class="w-full p-2 mb-3 border rounded text-sm" onkeyup="window.filterSelectionList()">
            <div id="agentes-checkbox-list" class="space-y-1 max-h-80 overflow-y-auto mb-6 pr-2"></div>
            <button onclick="window.closeModal('selection-modal')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold transition-colors">Confirmar Seleção</button>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-6 bg-indigo-600 text-white font-bold flex justify-between items-center">
                <span class="text-lg flex items-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i> Confirmar Lançamentos</span>
                <button onclick="window.closeModal('details-modal')" class="hover:bg-indigo-700 p-1 rounded"><i data-lucide="x"></i></button>
            </div>
            <form id="details-form" class="overflow-y-auto p-6 space-y-4 flex-1 bg-gray-50">
                <div class="text-xs uppercase font-bold text-gray-500 mb-2">Ajuste os horários individuais se necessário:</div>
                <div id="agentes-detalhes-container" class="grid grid-cols-1 gap-4"></div>
            </form>
            <div class="p-4 bg-white border-t flex justify-end gap-3">
                <button onclick="window.closeModal('details-modal')" class="px-6 py-2 text-gray-600 font-semibold hover:bg-gray-100 rounded-lg">Cancelar</button>
                <button type="submit" form="details-form" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-2 rounded-lg font-bold shadow-lg transition-transform active:scale-95 flex items-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i> Salvar Tudo
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs, deleteDoc, addDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO ---
        const firebaseConfig = { apiKey: "AIzaSyBgKe2n4c6vL4-B0hSAGT16ELDUQLW0OTQ", authDomain: "atuacao2026.firebaseapp.com", projectId: "atuacao2026", storageBucket: "atuacao2026.firebasestorage.app", messagingSenderId: "563632231622", appId: "1:563632231622:web:ce3e04e43cc647614214f5" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const COLLECTIONS = {
            LOGS: `artifacts/atuacao2026/public/data/scooteiras_atividades`,
            AGENTS: `artifacts/atuacao2026/public/data/scooteiras_cadastro`
        };

        const SQUADS_CONFIG = [
            { id: "SC", color: "emerald", label: "SC" },
            { id: "CB", color: "indigo", label: "CB" },
            { id: "Rec. Crédito", color: "amber", label: "Rec. Crédito" },
            { id: "OJR", color: "purple", label: "OJR" },
            { id: "Monitoria", color: "cyan", label: "Monitoria" }
        ];

        const METAS_SQUAD = {
            "SC": { 1: 54, 2: 60, 3: 60, 4: 54, 5: 54, 6: 18, 0: 18 },
            "CB": { 1: 54, 2: 54, 3: 54, 4: 54, 5: 42, 6: 12, 0: 12 },
            "Rec. Crédito": { 1: 5, 2: 5, 3: 5, 4: 5, 5: 4, 6: 0, 0: 0 },
            "OJR": { 1: 5, 2: 5, 3: 5, 4: 5, 5: 4, 6: 0, 0: 0 }
        };

        let state = {
            agents: [],
            history: [],
            unsubscribeHistory: null
        };

        const showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type === 'error' ? 'bg-red-500' : 'bg-emerald-600'}`;
            el.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="${type === 'error' ? 'alert-circle' : 'check'}"></i> ${msg}</div>`;
            container.appendChild(el);
            lucide.createIcons();
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
        };

        const setLoading = (isLoading) => {
            const el = document.getElementById('loading-indicator');
            if(el) isLoading ? el.classList.remove('hidden') : el.classList.add('hidden');
        };

        const normalizarSquad = (s) => {
            if (!s) return "Outro";
            const val = s.toUpperCase().trim();
            if (val.includes("REC") || val.includes("CRED")) return "Rec. Crédito";
            if (val.includes("SC") || val.includes("SPECIAL")) return "SC";
            if (val.includes("CB") || val.includes("BLOQUEADO")) return "CB";
            if (val.includes("OJR") || val.includes("JURIDICO")) return "OJR";
            return s;
        };

        const getSquadColor = (squadName) => {
            const sq = SQUADS_CONFIG.find(s => s.id === squadName);
            return sq ? sq.color : "slate";
        };

        signInAnonymously(auth).then(() => {
            document.getElementById('auth-status').innerText = "ONLINE";
            document.getElementById('auth-status').classList.replace('bg-indigo-800/50', 'bg-emerald-600');
            loadInitialData();
        }).catch(err => {
            console.error(err);
            showToast("Erro ao conectar no Firebase", "error");
        });

        async function loadInitialData() {
            const d = new Date();
            const mesAtual = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('mes-select').value = mesAtual;
            document.getElementById('relatorio-mes-select').value = mesAtual;
            document.getElementById('data-atuacao').valueAsDate = new Date(); 
            
            document.getElementById('new-squad').innerHTML = SQUADS_CONFIG.map(s => `<option value="${s.id}">${s.label}</option>`).join('');
            
            await loadAgents(); 
            loadHistorico(); 
        }

        const loadAgents = async () => {
            setLoading(true);
            try {
                const snap = await getDocs(collection(db, COLLECTIONS.AGENTS));
                state.agents = [];
                snap.forEach(d => {
                    const a = d.data();
                    a.squadPadrao = normalizarSquad(a.squadPadrao);
                    a.status = a.status || 'Ativa';
                    state.agents.push(a);
                });
                renderAgentsTable();
                renderSelectionList();
                renderRelatorioSelect();
            } catch (e) {
                console.error(e);
                showToast("Erro ao carregar equipe.", "error");
            } finally {
                setLoading(false);
            }
        };

        const renderAgentsTable = () => {
            const tbody = document.getElementById('cadastro-list-body');
            tbody.innerHTML = state.agents.sort((a,b) => a.nome.localeCompare(b.nome)).map(a => `
                <tr class="hover:bg-gray-50 border-b group transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-800">${a.nome}</div>
                        <div class="text-xs text-gray-400">Pseudo: ${a.pseudo} • ${a.squadPadrao}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <select onchange="window.toggleStatus('${a.nome}', this.value)" class="text-xs font-bold uppercase rounded-full px-2 py-1 border-0 cursor-pointer focus:ring-2 ${a.status === 'Ativa' ? 'bg-emerald-100 text-emerald-800' : 'bg-red-100 text-red-800'}">
                            <option value="Ativa" ${a.status === 'Ativa' ? 'selected' : ''}>Ativa</option>
                            <option value="Distrato" ${a.status === 'Distrato' ? 'selected' : ''}>Distrato</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="window.deleteAgent('${a.nome}')" class="text-gray-300 hover:text-red-500 transition-colors p-2 rounded hover:bg-red-50">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>`).join('');
            lucide.createIcons();
        };

        window.toggleStatus = async (nome, novoStatus) => {
            try {
                await updateDoc(doc(db, COLLECTIONS.AGENTS, nome), { status: novoStatus });
                showToast("Status atualizado!");
                loadAgents(); 
            } catch(e) { showToast("Erro ao atualizar.", "error"); }
        };

        window.loadHistorico = () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;

            setLoading(true);
            if(state.unsubscribeHistory) state.unsubscribeHistory(); 

            const q = query(collection(db, COLLECTIONS.LOGS), where("mes", "==", mes));
            
            state.unsubscribeHistory = onSnapshot(q, (snapshot) => {
                state.history = [];
                snapshot.forEach(d => {
                    const item = { id: d.id, ...d.data() };
                    item.squad = normalizarSquad(item.squad);
                    state.history.push(item);
                });
                
                state.history.sort((a,b) => 
                    b.data.localeCompare(a.data) || 
                    a.entrada.localeCompare(b.entrada) ||
                    a.scooteira.localeCompare(b.scooteira)
                );
                
                renderHistoricoTable();
                updateStats();
                setLoading(false);
                
                const activeTab = document.querySelector('.tab-active').id;
                if(activeTab === 'tab-capacidade') window.renderCapacityAccordion();
                if(activeTab === 'tab-trocas') window.renderTrocasAccordion();

            }, (error) => {
                console.error(error);
                showToast("Erro ao sincronizar histórico.", "error");
                setLoading(false);
            });
        };

        const renderHistoricoTable = () => {
            const tbody = document.getElementById('historico-body');
            if(state.history.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-400 italic">Nenhum registro encontrado neste mês.</td></tr>`;
                return;
            }

            tbody.innerHTML = state.history.map(item => {
                const agente = state.agents.find(a => a.nome === item.scooteira || a.pseudo === item.scooteira);
                let contratado = 0;
                
                const nomeExibicao = agente ? agente.nome : item.scooteira;
                const pseudoExibicao = (agente && agente.pseudo && agente.pseudo !== agente.nome) ? agente.pseudo : "";

                if (agente) {
                    const h1 = new Date(`2000-01-01T${agente.entradaPadrao}`);
                    const h2 = new Date(`2000-01-01T${agente.saidaPadrao}`);
                    contratado = (h2 - h1) / 3600000;
                    if (contratado < 0) contratado += 24;
                }
                
                const diff = Math.abs(item.horas - contratado);
                let corBadge = "bg-emerald-100 text-emerald-800"; 
                if (diff > 0.1) { 
                    corBadge = item.horas < contratado ? "bg-red-100 text-red-800" : "bg-amber-100 text-amber-800";
                }
                const colorName = getSquadColor(item.squad);

                return `
                <tr class="hover:bg-gray-50 border-b transition-colors">
                    <td class="px-6 py-4 text-gray-600 font-mono text-xs">${item.data.split('-').reverse().join('/')}</td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-700">${nomeExibicao}</div>
                        ${pseudoExibicao ? `<div class="text-xs text-gray-400 font-normal">${pseudoExibicao}</div>` : ''}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider bg-${colorName}-100 text-${colorName}-700 border border-${colorName}-200">
                            ${item.squad}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-xs text-center font-mono text-gray-500">${item.entrada} - ${item.saida}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-block px-2 py-1 rounded text-xs font-bold ${corBadge}">
                            ${item.horas.toFixed(2)}h
                        </span>
                        <span class="text-[10px] text-gray-400 ml-1">/ ${contratado.toFixed(1)}h</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="window.deleteLog('${item.id}')" class="text-gray-300 hover:text-red-500 p-2 hover:bg-red-50 rounded transition-all" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        };

        const updateStats = () => {
            const totals = {};
            state.history.forEach(i => { totals[i.squad] = (totals[i.squad] || 0) + i.horas; });
            document.getElementById('resumo-squads').innerHTML = SQUADS_CONFIG.map(s => {
                const val = (totals[s.id] || 0);
                return `
                <div class="bg-white p-4 rounded-xl border-l-4 border-${s.color}-500 shadow-sm flex flex-col justify-between">
                    <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">${s.id}</div>
                    <div class="text-2xl font-bold text-gray-700">${val.toFixed(1)}<span class="text-sm font-normal text-gray-400 ml-1">h</span></div>
                </div>`
            }).join('');
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.renderSelectionList = () => {
            const ativas = state.agents.filter(a => a.status === 'Ativa');
            const container = document.getElementById('agentes-checkbox-list');
            container.innerHTML = ativas.map(a => `
                <label class="flex items-center space-x-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer border border-transparent hover:border-gray-200 transition-all">
                    <input type="checkbox" value="${a.nome}" class="agent-checkbox w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                    <div>
                        <span class="text-sm font-bold text-gray-700 block">${a.nome}</span>
                        <span class="text-xs text-gray-400">${a.squadPadrao}</span>
                    </div>
                </label>`).join('');
        };

        window.filterSelectionList = () => {
            const term = document.getElementById('search-agent').value.toLowerCase();
            const labels = document.querySelectorAll('#agentes-checkbox-list label');
            labels.forEach(lbl => {
                const txt = lbl.innerText.toLowerCase();
                lbl.style.display = txt.includes(term) ? 'flex' : 'none';
            });
        };

        window.handleEntrySubmission = () => {
            const data = document.getElementById('data-atuacao').value;
            const checkboxes = document.querySelectorAll('.agent-checkbox:checked');
            
            if (!data) return showToast("Selecione a data de atuação.", "error");
            if (checkboxes.length === 0) return showToast("Selecione pelo menos uma pessoa.", "error");

            const selectedNames = Array.from(checkboxes).map(cb => cb.value);
            
            document.getElementById('agentes-detalhes-container').innerHTML = selectedNames.map(nome => {
                const a = state.agents.find(x => x.nome === nome);
                const color = getSquadColor(a.squadPadrao);
                return `
                <div class="confirm-row p-4 border rounded-xl bg-white shadow-sm relative flex flex-col gap-3" data-nome="${a.nome}">
                    <button type="button" onclick="this.parentElement.remove()" class="absolute top-3 right-3 text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <div class="flex items-center gap-2">
                         <div class="font-bold text-gray-800">${a.nome}</div>
                         <span class="text-[10px] bg-gray-100 px-2 rounded text-gray-500">${a.squadPadrao}</span>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-400">Entrada</label>
                            <input type="time" value="${a.entradaPadrao}" class="confirm-ent w-full border border-gray-300 p-2 rounded-lg text-sm focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-400">Saída</label>
                            <input type="time" value="${a.saidaPadrao}" class="confirm-sai w-full border border-gray-300 p-2 rounded-lg text-sm focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-gray-400">Squad Real</label>
                            <select class="confirm-squad w-full border border-gray-300 p-2 rounded-lg text-sm bg-white">
                                ${SQUADS_CONFIG.map(s => `<option value="${s.id}" ${s.id === a.squadPadrao ? 'selected' : ''}>${s.label}</option>`).join('')}
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            lucide.createIcons();
            window.openModal('details-modal');
            
            const btnLabel = document.getElementById('selected-count-label');
            btnLabel.innerText = `${selectedNames.length} Selecionada(s)`;
            btnLabel.classList.add('text-indigo-600', 'font-bold');
        };

        // --- SALVAMENTO COM TRAVA DE DUPLICIDADE ---
        document.getElementById('details-form').onsubmit = async (e) => {
            e.preventDefault();
            const dataStr = document.getElementById('data-atuacao').value;
            const rows = document.querySelectorAll('.confirm-row');
            
            if(rows.length === 0) return window.closeModal('details-modal');

            setLoading(true);

            try {
                // 1. PRIMEIRO: Busca todos os registros QUE JÁ EXISTEM para essa data no banco
                // Isso evita fazer 50 consultas separadas (N+1)
                const qCheck = query(collection(db, COLLECTIONS.LOGS), where("data", "==", dataStr));
                const snapCheck = await getDocs(qCheck);
                
                // Cria um conjunto (Set) com os nomes de quem já trabalhou nesse dia
                const nomesJaRegistrados = new Set();
                snapCheck.forEach(doc => {
                    const d = doc.data();
                    nomesJaRegistrados.add(d.scooteira);
                });

                // 2. SEGUNDO: Prepara as listas de "Quem salva" e "Quem é duplicado"
                const duplicados = [];
                const paraSalvar = [];

                for (const row of rows) {
                    const nome = row.dataset.nome;
                    
                    // A MÁGICA DA VERIFICAÇÃO:
                    if (nomesJaRegistrados.has(nome)) {
                        duplicados.push(nome); // Caiu na malha fina!
                        continue; // Pula essa pessoa
                    }

                    // Se não for duplicado, prepara os dados
                    const ent = row.querySelector('.confirm-ent').value;
                    const sai = row.querySelector('.confirm-sai').value;
                    const sq = row.querySelector('.confirm-squad').value;
                    
                    const d1 = new Date(`2000-01-01T${ent}`);
                    const d2 = new Date(`2000-01-01T${sai}`);
                    let diff = (d2 - d1) / 3600000;
                    if (diff < 0) diff += 24; 

                    if(isNaN(diff)) continue;

                    paraSalvar.push({ 
                        data: dataStr, 
                        mes: dataStr.substring(0, 7), 
                        scooteira: nome, 
                        squad: sq, 
                        entrada: ent, 
                        saida: sai, 
                        horas: parseFloat(diff.toFixed(2)), 
                        timestamp: new Date() 
                    });
                }
                
                // 3. TERCEIRO: Se tiver duplicados, avisa e NÃO salva ninguém (para o usuário decidir)
                if (duplicados.length > 0) {
                    alert(`⚠️ ATENÇÃO: Os seguintes nomes JÁ TÊM registro no dia ${dataStr.split('-').reverse().join('/')}:\n\n${duplicados.join(', ')}\n\nNenhum registro foi salvo. Remova as duplicatas da lista e tente novamente.`);
                    setLoading(false);
                    return; // PARE TUDO AQUI
                }

                // 4. QUARTO: Se não houver duplicados, salva tudo em lote
                if (paraSalvar.length > 0) {
                    await Promise.all(paraSalvar.map(dados => addDoc(collection(db, COLLECTIONS.LOGS), dados)));
                    showToast(`${paraSalvar.length} registros salvos com sucesso!`);
                } else {
                    showToast("Nenhum dado válido para salvar.", "error");
                }
                
                // Reset da UI
                document.getElementById('selected-count-label').innerText = "Selecionar Scooteiras...";
                document.getElementById('selected-count-label').classList.remove('text-indigo-600', 'font-bold');
                document.querySelectorAll('.agent-checkbox').forEach(cb => cb.checked = false);
                
                window.closeModal('details-modal');

            } catch(error) {
                console.error(error);
                showToast("Erro ao processar dados.", "error");
                
                // Dica caso falte índice no Firestore (embora a query 'data' seja simples)
                if(error.message && error.message.includes("index")) {
                    alert("Atenção Dev: Verifique o Console (F12) e crie o índice no Firebase!");
                }
            } finally {
                setLoading(false);
            }
        };

        window.deleteLog = async (id) => { 
            if(confirm("Tem certeza que deseja excluir este registro?")) { 
                try {
                    await deleteDoc(doc(db, COLLECTIONS.LOGS, id)); 
                    showToast("Registro excluído.");
                } catch(e) { showToast("Erro ao excluir.", "error"); }
            } 
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.className = "flex-1 py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap focus:outline-none";
            });
            
            const content = document.getElementById(`content-${tabId}`);
            const btn = document.getElementById(`tab-${tabId}`);
            
            content.classList.remove('hidden');
            btn.className = "flex-1 py-4 px-6 text-sm font-semibold transition-all tab-active whitespace-nowrap focus:outline-none";
            
            if (tabId === 'capacidade') window.renderCapacityAccordion();
            if (tabId === 'trocas') window.renderTrocasAccordion();
            lucide.createIcons();
        };

        window.renderRelatorioSelect = () => {
             document.getElementById('relatorio-agente-select').innerHTML = '<option value="" disabled selected>Escolher...</option>' + 
                state.agents.sort((a,b) => a.nome.localeCompare(b.nome)).map(a => `<option value="${a.nome}">${a.nome}</option>`).join('');
        };

        function getISOWeek(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        window.renderCapacityAccordion = () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;
            const [ano, mesNum] = mes.split('-').map(Number);
            const container = document.getElementById('capacity-accordion-container');
            
            container.innerHTML = "";
            
            if (state.history.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8 italic">Sem dados neste mês para calcular a capacidade.</div>';
                return;
            }

            const dataMap = {};
            state.history.forEach(log => {
                if(!dataMap[log.data]) dataMap[log.data] = {};
                dataMap[log.data][log.squad] = (dataMap[log.data][log.squad] || 0) + log.horas;
            });

            const weeks = {};
            const first = new Date(ano, mesNum - 1, 1);
            const last = new Date(ano, mesNum, 0);
            
            for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
                const w = getISOWeek(new Date(d));
                if (!weeks[w]) weeks[w] = [];
                weeks[w].push(new Date(d));
            }

            Object.keys(weeks).forEach(wNum => {
                const days = weeks[wNum];
                const weekId = `week-${wNum}`;
                
                const header = document.createElement('div');
                header.className = "cursor-pointer bg-white border border-gray-200 p-4 rounded-lg mb-2 hover:border-indigo-500 hover:shadow-md transition-all flex justify-between items-center";
                header.innerHTML = `<div><span class="font-bold text-indigo-700">Semana ${wNum}</span></div><i data-lucide="chevron-down" class="text-gray-400 w-4 h-4"></i>`;
                header.onclick = () => {
                    const content = document.getElementById(weekId);
                    content.classList.toggle('hidden');
                    lucide.createIcons();
                };

                const content = document.createElement('div');
                content.id = weekId;
                content.className = "hidden mb-6 border border-gray-200 border-t-0 rounded-b-lg overflow-x-auto bg-white p-2 shadow-inner";

                let tableHtml = `<table class="w-full text-xs"><thead><tr><th class="p-2 text-left bg-gray-50 border">Dia</th>`;
                SQUADS_CONFIG.forEach(s => tableHtml += `<th class="p-2 text-center bg-gray-50 border font-bold text-${s.color}-700">${s.id}</th>`);
                tableHtml += `</tr></thead><tbody>`;

                days.forEach(dateObj => {
                    const dateKey = dateObj.toISOString().split('T')[0];
                    const dow = dateObj.getDay(); 
                    tableHtml += `<tr><td class="p-2 border font-bold bg-gray-50 text-gray-600">${dateObj.toLocaleDateString('pt-BR', {day:'2-digit', weekday:'short'})}</td>`;
                    
                    SQUADS_CONFIG.forEach(sq => {
                        const squadName = sq.id;
                        const actual = (dataMap[dateKey] && dataMap[dateKey][squadName]) ? dataMap[dateKey][squadName] : 0;
                        
                        const target = (METAS_SQUAD[squadName] && METAS_SQUAD[squadName][dow] !== undefined) ? METAS_SQUAD[squadName][dow] : 0;
                        
                        let cellClass = "p-2 border text-center";
                        let badgeClass = "text-gray-400";
                        
                        if (target > 0) {
                            if (actual < target) {
                                cellClass += " bg-red-50 text-red-800";
                                badgeClass = "text-red-300";
                            } else if (actual > target) {
                                cellClass += " bg-amber-50 text-amber-800";
                                badgeClass = "text-amber-300";
                            } else {
                                cellClass += " bg-emerald-50 text-emerald-800";
                                badgeClass = "text-emerald-300";
                            }
                        }

                        tableHtml += `<td class="${cellClass}">
                            <div class="font-bold">${actual.toFixed(1)}h</div>
                            <div class="text-[9px] ${badgeClass}">Meta: ${target}</div>
                        </td>`;
                    });
                    tableHtml += `</tr>`;
                });

                content.innerHTML = tableHtml + `</tbody></table>`;
                container.appendChild(header);
                container.appendChild(content);
            });
            lucide.createIcons();
        };

        window.renderTrocasAccordion = () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;
            const [ano, mesNum] = mes.split('-').map(Number);
            const container = document.getElementById('trocas-accordion-container');
            container.innerHTML = "";

            const dailyLogs = {};
            state.history.forEach(log => { if(!dailyLogs[log.data]) dailyLogs[log.data] = []; dailyLogs[log.data].push(log); });

            const weeks = {};
            const first = new Date(ano, mesNum - 1, 1);
            const last = new Date(ano, mesNum, 0);
            for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
                const w = getISOWeek(new Date(d));
                if (!weeks[w]) weeks[w] = [];
                weeks[w].push(new Date(d));
            }

            Object.keys(weeks).forEach(wNum => {
                const days = weeks[wNum];
                const weekId = `trocas-week-${wNum}`;
                
                const header = document.createElement('div');
                header.className = "cursor-pointer bg-white border border-gray-200 p-4 rounded-lg mb-2 hover:border-indigo-500 hover:shadow-md transition-all flex justify-between items-center";
                header.innerHTML = `<div><span class="font-bold text-indigo-700">Trocas Semana ${wNum}</span></div><i data-lucide="chevron-down" class="text-gray-400 w-4 h-4"></i>`;
                header.onclick = () => {
                    document.getElementById(weekId).classList.toggle('hidden');
                    lucide.createIcons();
                };

                const content = document.createElement('div');
                content.id = weekId;
                content.className = "hidden mb-4 p-4 bg-white border border-t-0 rounded-b-lg shadow-inner";

                let trocasHtml = "";
                days.forEach(dateObj => {
                    const dateKey = dateObj.toISOString().split('T')[0];
                    const logsDia = dailyLogs[dateKey] || [];
                    const diaSeman = dateObj.toLocaleDateString('pt-BR', { weekday: 'short' }).toLowerCase().replace('.',''); 
                    
                    const extras = logsDia.filter(l => {
                        const a = state.agents.find(ag => ag.nome === l.scooteira || ag.pseudo === l.scooteira);
                        if (!a) return false;
                        const turno = a.turnoPadrao.toLowerCase();
                        const ehDiaDeTrabalho = turno.includes(diaSeman) || turno.includes("seg-sex");
                        return !ehDiaDeTrabalho;
                    });

                    const ausentes = state.agents.filter(a => {
                        if (a.status === 'Distrato') return false;
                        const turno = a.turnoPadrao.toLowerCase();
                        const ehDiaDeTrabalho = turno.includes(diaSeman) || turno.includes("seg-sex");
                        const trabalhou = logsDia.some(l => l.scooteira === a.nome || l.scooteira === a.pseudo);
                        return ehDiaDeTrabalho && !trabalhou;
                    });

                    if(extras.length > 0 && ausentes.length > 0) {
                        let diaHtml = "";
                        extras.forEach(ex => {
                            const exSq = normalizarSquad(ex.squad);
                            const par = ausentes.find(au => normalizarSquad(au.squadPadrao) === exSq);
                            const agentEx = state.agents.find(ag => ag.nome === ex.scooteira || ag.pseudo === ex.scooteira);
                            const nomeEx = agentEx ? agentEx.nome.split(' ')[0] : ex.scooteira.split(' ')[0];
                            const nomePar = par ? par.nome.split(' ')[0] : 'Alguém';
                            
                            if(par) {
                                diaHtml += `
                                <div class="flex items-center gap-3 p-3 bg-indigo-50 rounded-lg mb-2 border-l-4 border-indigo-500">
                                    <i data-lucide="arrow-right-left" class="text-indigo-400 w-4 h-4"></i>
                                    <div class="text-sm">
                                        <strong class="text-indigo-800">${nomeEx}</strong> cobriu 
                                        <strong class="text-gray-600">${nomePar}</strong> 
                                        <span class="text-xs text-gray-500 bg-gray-100 px-1 rounded ml-1">(${par.entradaPadrao} - ${par.saidaPadrao})</span>
                                        no squad ${exSq}.
                                    </div>
                                </div>`;
                            }
                        });
                        if(diaHtml) trocasHtml += `<div class="mb-4"><h4 class="font-bold text-xs text-gray-400 uppercase mb-2 border-b pb-1">${dateObj.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'})} - ${dateObj.toLocaleDateString('pt-BR', {weekday:'long'})}</h4>${diaHtml}</div>`;
                    }
                });

                content.innerHTML = trocasHtml || `<p class="text-xs text-gray-400 italic text-center py-2">Nenhuma troca óbvia detectada nesta semana.</p>`;
                container.appendChild(header);
                container.appendChild(content);
            });
            lucide.createIcons();
        };

        window.loadRelatorioIndividual = async () => {
            const nome = document.getElementById('relatorio-agente-select').value;
            const mes = document.getElementById('relatorio-mes-select').value;
            const table = document.getElementById('relatorio-body');
            const cards = document.getElementById('relatorio-resumo-cards');
            
            if(!nome || !mes) return;
            
            table.innerHTML = '<tr><td colspan="5" class="text-center py-8"><div class="loader mx-auto"></div></td></tr>';
            cards.classList.add('hidden');

            try {
                const q = query(collection(db, COLLECTIONS.LOGS), where("mes", "==", mes));
                const snap = await getDocs(q);
                
                const agente = state.agents.find(a => a.nome === nome);
                const pseudo = agente ? agente.pseudo : "";
                
                const list = [];
                let total = 0;
                const sqTotal = {};
                
                snap.forEach(d => {
                    const data = d.data();
                    if(data.scooteira === nome || data.scooteira === pseudo) {
                        const sq = normalizarSquad(data.squad);
                        list.push({ ...data, squad: sq });
                        total += data.horas;
                        sqTotal[sq] = (sqTotal[sq] || 0) + data.horas;
                    }
                });
                
                list.sort((a,b) => b.data.localeCompare(a.data));
                
                cards.classList.remove('hidden');
                let sqHtml = "";
                Object.keys(sqTotal).forEach(s => { 
                    const color = getSquadColor(s);
                    sqHtml += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-${color}-500">
                        <div class="text-xs text-gray-400 uppercase font-bold">${s}</div>
                        <div class="text-xl font-bold text-gray-700">${sqTotal[s].toFixed(1)}h</div>
                    </div>`; 
                });
                
                cards.innerHTML = `
                <div class="bg-indigo-600 p-4 rounded-xl shadow-md text-white">
                    <div class="text-xs opacity-80 uppercase font-bold">Total Mês</div>
                    <div class="text-3xl font-bold">${total.toFixed(1)}h</div>
                </div>${sqHtml}`;
                
                if(list.length === 0) {
                    table.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400 italic">Nenhum registro encontrado para esta scooteira neste mês.</td></tr>';
                } else {
                    table.innerHTML = list.map(i => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4">${i.data.split('-').reverse().join('/')}</td>
                            <td class="px-6 py-4"><span class="text-xs font-bold bg-gray-100 px-2 py-1 rounded text-gray-600">${i.squad}</span></td>
                            <td class="px-6 py-4 text-center text-gray-500 font-mono text-xs">${i.entrada}</td>
                            <td class="px-6 py-4 text-center text-gray-500 font-mono text-xs">${i.saida}</td>
                            <td class="px-6 py-4 font-bold text-center text-indigo-600">${i.horas.toFixed(2)}h</td>
                        </tr>`).join('');
                }
            } catch (e) {
                console.error(e);
                showToast("Erro ao gerar relatório.", "error");
                table.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Erro ao buscar dados.</td></tr>';
            }
        };

        document.getElementById('add-agent-form').onsubmit = async (e) => {
            e.preventDefault();
            const nome = document.getElementById('new-nome').value.trim();
            if(!nome) return;
            
            setLoading(true);
            try {
                await setDoc(doc(db, COLLECTIONS.AGENTS, nome), {
                    nome: nome, 
                    pseudo: document.getElementById('new-pseudo').value,
                    squadPadrao: document.getElementById('new-squad').value, 
                    turnoPadrao: document.getElementById('new-turno').value,
                    entradaPadrao: document.getElementById('new-entrada').value, 
                    saidaPadrao: document.getElementById('new-saida').value,
                    status: 'Ativa'
                });
                showToast("Scooteira cadastrada com sucesso!");
                document.getElementById('add-agent-form').reset();
                loadAgents(); 
            } catch(e) {
                console.error(e);
                showToast("Erro ao cadastrar.", "error");
            } finally {
                setLoading(false);
            }
        };

        window.deleteAgent = async (id) => { 
            if(confirm(`Excluir ${id} do cadastro permanentemente?`)) { 
                try {
                    await deleteDoc(doc(db, COLLECTIONS.AGENTS, id)); 
                    showToast("Cadastro removido.");
                    loadAgents();
                } catch(e) { showToast("Erro ao excluir.", "error"); }
            } 
        };

        lucide.createIcons();
    </script>
</body>
</html>
