<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- NOME UNIFICADO NA ABA - ATUALIZADO -->
    <title>Dash Atua√ß√£o - Scooto</title>
    
    <!-- Favicon de Scooter -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõµ</text></svg>">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FONTE ALTERADA PARA MONTSERRAT -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked para Markdown da IA -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* FONTE APLICADA AQUI */
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; color: #334155; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #334155; border-bottom: 2px solid #cbd5e1; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .prose h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose p { margin-bottom: 0.8em; line-height: 1.5; }
        .prose strong { color: #4f46e5; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">

    <div id="app" class="w-full max-w-6xl bg-white rounded-2xl shadow-xl overflow-hidden">
        
        <!-- Header Moderno -->
        <header class="bg-indigo-600 p-6 sm:p-10 text-white">
            <div class="flex justify-between items-center">
                <div>
                    <!-- NOME UNIFICADO NO CABE√áALHO - ATUALIZADO -->
                    <h1 class="text-3xl font-bold tracking-tight">Dash Atua√ß√£o - Scooto</h1>
                    <p class="text-indigo-100 text-sm mt-1">Controle de Squads e Scooteiras</p>
                </div>
                <div class="hidden md:block text-right">
                    <p id="auth-status" class="text-xs text-indigo-200 font-mono bg-indigo-800 py-1 px-2 rounded">Conectando...</p>
                </div>
            </div>
        </header>
        
        <!-- Navega√ß√£o (Tabs) -->
        <div class="flex border-b border-gray-200 bg-gray-50 px-6 overflow-x-auto">
            <button id="tab-registro" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-active whitespace-nowrap" onclick="switchTab('registro')">
                <span class="flex items-center"><i data-lucide="calendar-check" class="w-4 h-4 mr-2"></i> Registro Di√°rio</span>
            </button>
            <button id="tab-relatorio" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-inactive whitespace-nowrap" onclick="switchTab('relatorio')">
                <span class="flex items-center"><i data-lucide="bar-chart-3" class="w-4 h-4 mr-2"></i> Relat√≥rios</span>
            </button>
            <button id="tab-cadastro" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-inactive whitespace-nowrap" onclick="switchTab('cadastro')">
                <span class="flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i> Equipe</span>
            </button>
        </div>
        
        <!-- √Årea de Mensagens -->
        <div id="message-box" class="hidden mx-6 mt-6 p-4 text-sm rounded-lg shadow-sm border-l-4 transition-all" role="alert"></div>

        <div class="p-6 sm:p-8 min-h-[500px]">
            
            <!-- CONTE√öDO DA ABA 1: Registro Di√°rio e Hist√≥rico -->
            <div id="content-registro" class="animate-fade-in">
                <!-- Card de Registro -->
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6 mb-8 shadow-sm">
                    <h2 class="text-lg font-semibold text-indigo-900 mb-4 flex items-center">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Novo Lan√ßamento
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-3">
                            <label class="block text-xs font-medium text-gray-600 mb-1 uppercase tracking-wide">Data</label>
                            <input type="date" id="data-atuacao" class="w-full p-2.5 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        </div>
                        <div class="md:col-span-6">
                            <label class="block text-xs font-medium text-gray-600 mb-1 uppercase tracking-wide">Scooteira(s)</label>
                            <input type="hidden" id="selected-agents-input"> 
                            <button type="button" id="agentes-selection-display" onclick="showSelectionModal()" 
                                    class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-left text-gray-500 hover:border-indigo-400 transition shadow-sm flex items-center justify-between text-sm">
                                <span>Clique para selecionar...</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="md:col-span-3">
                            <button id="btn-registrar" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 px-4 rounded-lg font-medium shadow-md transition flex items-center justify-center" onclick="handleEntrySubmission()">
                                <span>Registrar</span>
                                <div id="loading-spinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o de Hist√≥rico -->
                <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-800">Hist√≥rico Mensal</h2>
                    <div class="flex items-center space-x-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <label for="mes-select" class="text-sm font-medium text-gray-600">M√™s:</label>
                        <input type="month" id="mes-select" class="bg-white border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500 py-1" onchange="loadHistorico()">
                        <div class="h-4 w-px bg-gray-300 mx-2"></div>
                        <button class="text-gray-600 hover:text-indigo-600 text-sm font-medium flex items-center transition" onclick="exportToCsv()">
                             <i data-lucide="download" class="w-4 h-4 mr-1"></i> CSV
                        </button>
                        <button class="text-gray-600 hover:text-blue-600 text-sm font-medium flex items-center transition ml-3" onclick="showImportModal()">
                             <i data-lucide="upload" class="w-4 h-4 mr-1"></i> Importar
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-end mb-4">
                      <button onclick="analyzeMonthlyData()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition flex items-center">
                        <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i> Analisar M√™s com IA
                    </button>
                </div>

                <div id="resumo-squads" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>

                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-3 font-medium">Data</th>
                                <th class="px-6 py-3 font-medium">Scooteira</th>
                                <th class="px-6 py-3 font-medium">Squad</th>
                                <th class="px-6 py-3 font-medium">Entrada</th>
                                <th class="px-6 py-3 font-medium">Sa√≠da</th>
                                <th class="px-6 py-3 font-medium">Dura√ß√£o</th>
                                <th class="px-6 py-3 font-medium">Turno</th>
                                <th class="px-6 py-3 font-medium text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="historico-body" class="divide-y divide-gray-100">
                            <tr><td colspan="8" class="text-center py-8 text-gray-400">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            // CONTE√öDO DA ABA 2: Relat√≥rio Individual
            <div id="content-relatorio" class="hidden animate-fade-in">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Relat√≥rio Individual</h2>
                
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Scooteira</label>
                            <select id="relatorio-agente-select" class="w-full p-2.5 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="loadRelatorioIndividual()">
                                <option value="" disabled selected>Selecione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">M√™s</label>
                            <input type="month" id="relatorio-mes-select" class="w-full p-2.5 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="loadRelatorioIndividual()">
                        </div>
                        <div class="flex items-end space-x-2">
                             <button class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 px-4 rounded-lg font-medium shadow-sm transition flex items-center justify-center" onclick="exportIndividualCsv()">
                                 <i data-lucide="file-down" class="w-4 h-4 mr-2"></i> CSV
                             </button>
                             <button onclick="analyzeIndividualData()" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white py-2.5 px-4 rounded-lg font-medium shadow-sm transition flex items-center justify-center">
                                <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i> Insights
                            </button>
                        </div>
                    </div>
                </div>

                <div id="relatorio-resumo-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 hidden">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                        <span class="text-xs text-gray-500 uppercase font-medium">Dias Trabalhados</span>
                        <span class="text-3xl font-bold text-gray-800 mt-1" id="resumo-total-dias">-</span>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                        <span class="text-xs text-gray-500 uppercase font-medium">Total de Horas Geral</span>
                        <span class="text-3xl font-bold text-indigo-600 mt-1" id="resumo-total-horas">-</span>
                    </div>
                    <!-- Nova √°rea para Squads - ocupa 2 colunas no LG -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col lg:col-span-2">
                        <span class="text-xs text-gray-500 uppercase font-medium mb-2">Horas por Squad</span>
                        <div id="resumo-squads-list" class="flex flex-wrap gap-2 mt-auto">
                            <!-- Inserido via JS -->
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-3 font-medium">Data</th>
                                <th class="px-6 py-3 font-medium">Dia</th>
                                <th class="px-6 py-3 font-medium">Squad</th>
                                <th class="px-6 py-3 font-medium">Entrada</th>
                                <th class="px-6 py-3 font-medium">Sa√≠da</th>
                                <th class="px-6 py-3 font-medium">Dura√ß√£o</th>
                                <th class="px-6 py-3 font-medium">Turno</th>
                            </tr>
                        </thead>
                        <tbody id="relatorio-body" class="divide-y divide-gray-100">
                            <tr><td colspan="7" class="text-center py-8 text-gray-400">Selecione os filtros acima.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CONTE√öDO DA ABA 3: Gest√£o de Cadastros -->
            <div id="content-cadastro" class="hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Equipe Cadastrada</h2>
                    <button onclick="forceResetDefaults()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 py-2 px-4 rounded border border-gray-300 flex items-center transition">
                        <i data-lucide="refresh-cw" class="w-3 h-3 mr-2"></i> Restaurar Padr√µes
                    </button>
                </div>

                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-8">
                    <h3 class="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wide border-b pb-2">Adicionar Nova Agente</h3>
                    <form id="add-agent-form" class="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Nome Completo</label>
                            <input type="text" id="new-nome" placeholder="Nome da Scooteira" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Pseudo</label>
                            <input type="text" id="new-pseudo" placeholder="Ex: Diana C." class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Squad Padr√£o</label>
                            <select id="new-squad" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                <option value="CB">CB</option>
                                <option value="SC">SC</option>
                                <option value="Rec Cred">Rec Cred</option>
                                <option value="Monitoria">Monitoria</option>
                                <option value="OJR">OJR</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Dias Padr√£o</label>
                            <input type="text" id="new-turno" placeholder="Ex: Seg. √† Sex." class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Entrada</label>
                            <input type="time" id="new-entrada" value="08:00" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Sa√≠da</label>
                            <input type="time" id="new-saida" value="14:00" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" required>
                        </div>
                        <div class="md:col-span-6 flex justify-end mt-2">
                            <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-6 rounded-lg font-medium shadow-sm transition text-sm">
                                 + Adicionar
                            </button>
                        </div>
                    </form>
                </div>

                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-3 font-medium">Nome (Pseudo)</th>
                                <th class="px-6 py-3 font-medium">Squad</th>
                                <th class="px-6 py-3 font-medium">Dias</th>
                                <th class="px-6 py-3 font-medium">Hor√°rio</th>
                                <th class="px-6 py-3 font-medium text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="cadastro-list-body" class="divide-y divide-gray-100">
                            <tr><td colspan="5" class="text-center py-8 text-gray-400">Carregando equipe...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAIS -->
    <!-- Modal Sele√ß√£o, Detalhes, Importa√ß√£o, An√°lise e Confirma√ß√£o... (Mantidos) -->
    
    <div id="selection-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800">Selecionar Scooteiras</h3>
                <button onclick="closeModal('selection-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="agentes-checkbox-list" class="p-4 space-y-2 max-h-[60vh] overflow-y-auto"></div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end">
                <button class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg font-medium text-sm" onclick="closeModal('selection-modal')">Conclu√≠do</button>
            </div>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="bg-indigo-600 px-6 py-4 text-white">
                <h3 class="text-lg font-bold" id="details-modal-title">Ajuste de Detalhes</h3>
                <p class="text-indigo-100 text-xs mt-1" id="modal-instructions"></p>
            </div>
            <form id="details-form" class="flex-1 overflow-hidden flex flex-col">
                <input type="hidden" id="recordIdToEdit" value=""> 
                <div id="agentes-detalhes-container" class="p-6 space-y-6 overflow-y-auto flex-1"></div>
                <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                    <button type="button" class="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition" onclick="closeModal('details-modal')">Cancelar</button>
                    <button type="submit" id="btn-modal-submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-sm transition">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 flex items-center"><i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2 text-blue-600"></i> Importar Hist√≥rico</h3>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-4">
                    Cole os dados (Excel/CSV) <strong>OU</strong> um texto simples (E-mail/Whatsapp).
                    <br><span class="text-xs text-gray-400">Use "Importar com IA ‚ú®" para textos desorganizados.</span>
                </p>
                <textarea id="import-data-json" rows="10" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 font-mono text-xs bg-gray-50" placeholder="Exemplo CSV:
Scooteira	Data	Entrada	Sa√≠da	Squad
Maria	15/11/2025	08:00	14:00	CB

Exemplo Texto (Use IA ‚ú®):
'A Maria trabalhou ontem das 8h √†s 14h no squad CB e a Joana fez das 10 √†s 16h.'"></textarea>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                <button type="button" class="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition" onclick="closeModal('import-modal')">Cancelar</button>
                <div class="relative group">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-pink-600 to-purple-600 rounded-lg blur opacity-40 group-hover:opacity-100 transition duration-200"></div>
                    <button class="relative bg-white hover:bg-gray-50 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium border border-gray-200 shadow-sm flex items-center" onclick="handleSmartImport()">
                        <i data-lucide="sparkles" class="w-4 h-4 mr-2 text-purple-600"></i> Importar com IA
                    </button>
                </div>
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-sm transition" onclick="handleImport()">Importar CSV</button>
            </div>
            <div id="ai-loading-overlay" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center flex-col z-10">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600 mb-3"></div>
                <p class="text-purple-800 font-medium text-sm animate-pulse">A Intelig√™ncia Artificial est√° a ler os seus dados...</p>
            </div>
        </div>
    </div>

    <div id="ai-analysis-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[80vh] flex flex-col">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold flex items-center"><i data-lucide="bot" class="w-5 h-5 mr-2"></i> An√°lise Inteligente</h3>
                <button onclick="closeModal('ai-analysis-modal')" class="text-purple-100 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 overflow-y-auto flex-1 prose prose-sm max-w-none text-gray-700 leading-relaxed" id="ai-analysis-content"></div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end">
                <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium" onclick="closeModal('ai-analysis-modal')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-2" id="confirm-title">Confirmar</h3>
            <p class="text-sm text-gray-500 mb-6" id="confirm-message">Tem certeza?</p>
            <div class="flex justify-center space-x-3">
                <button class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition" onclick="window.resolveConfirmation(false)">Cancelar</button>
                <button id="confirm-yes-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition shadow-sm" onclick="window.resolveConfirmation(true)">Sim, Confirmar</button>
            </div>
        </div>
    </div>

    <div id="edit-agent-modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs, onSnapshot, runTransaction, deleteDoc, setLogLevel, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================================
        // CONFIGURA√á√ÉO PARA GITHUB PAGES - PREENCHA AQUI!
        // =========================================================================================
        
        // 1. Obtenha estes dados no Console do Firebase (Configura√ß√µes do Projeto > Geral > Seus aplicativos)
        // Para usar no GitHub Pages, substitua os valores abaixo.
        // Para testar no Preview, o sistema usar√° automaticamente a vari√°vel __firebase_config se dispon√≠vel.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBgKe2n4c6vL4-B0hSAGT16ELDUQLW0OTQ",
  authDomain: "atuacao2026.firebaseapp.com",
  projectId: "atuacao2026",
  storageBucket: "atuacao2026.firebasestorage.app",
  messagingSenderId: "862692587738",
  appId: "1:862692587738:web:f8cbedfd0951a4632b8de3",
  measurementId: "G-GYBGDY5L14"
        };
        // 2. Chave de API do Gemini (Google AI Studio)
        // IMPORTANTE: Em um site p√∫blico (GitHub Pages), esta chave ficar√° vis√≠vel.
        // Restrinja o uso desta chave apenas para o dom√≠nio do seu GitHub Pages no console da Google Cloud.
        const geminiApiKey = "AIzaSyDoGeOheMsmmsEQiirykFHI_Y3XMhcSoFA"; 

        // 3. ID √∫nico para o armazenamento de dados. Pode ser o nome do seu projeto.
        const appId = "scooto-gestao-v1"; 

        // =========================================================================================

        let db, auth, userId = null;
        let scooteirasCadastro = [], allRegistros = [], selectedAgentsNames = [];
        let isAuthReady = false;
        let agentesByPseudo = {};
        
        const SQUADS_OPCOES = ["CB", "SC", "Rec Cred", "Monitoria", "OJR"];
        const TURNOS_OPCOES = ["Di√°ria Extra", "Troca", "Freela", "Monitora", "Meu Turno"];
        
        const MOCK_CADASTROS = [
            { nome: "J√©ssica Zanquettin", pseudo: "Celina Z", squadPadrao: "CB", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
            { nome: "Juliana da Silva Sfair", pseudo: "L√≥ri S", squadPadrao: "CB", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "10:00", saidaPadrao: "16:00", cargaPadrao: 6 },
            { nome: "Raylla Caroline Fernandes Santos", pseudo: "Teresa S.", squadPadrao: "CB", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "10:00", saidaPadrao: "16:00", cargaPadrao: 6 },
            { nome: "Barbara Santos De Souza Moreira", pseudo: "Nara M", squadPadrao: "CB", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
            { nome: "Viviane Santiago de Oliveira", pseudo: "Menna S.", squadPadrao: "CB", turnoPadrao: "Seg √† Qui. e Dom.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
            { nome: "Janaina Gonzaga Fioravante", pseudo: "Solar F.", squadPadrao: "CB", turnoPadrao: "Quin. √† S√°b.", entradaPadrao: "16:00", saidaPadrao: "22:00", cargaPadrao: 6 },
            { nome: "Gizele Uglar Leite Lima", pseudo: "Mari U", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
            { nome: "Gleici√©le Nogueira", pseudo: "Mariana N.", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
            { nome: "Lindisen Guiomar Lemos dos Santos", pseudo: "Ruama S.", squadPadrao: "SC", turnoPadrao: "Dom. √† Quar.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
            { nome: "Maria Eduarda Ferreira Gusm√£o", pseudo: "Ruth G.", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
            { nome: "Tha√≠s Hayelen", pseudo: "Raquel H.", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
            { nome: "Rafaela Lins da Costa", pseudo: "Leila C.", squadPadrao: "SC", turnoPadrao: "FDS", entradaPadrao: "10:00", saidaPadrao: "16:00", cargaPadrao: 6 },
            { nome: "Ana Claudia Ferreira de Souza", pseudo: "Ravena F.", squadPadrao: "SC", turnoPadrao: "Ter. √† S√°b.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
            { nome: "Crislaine Gomes da Silva", pseudo: "Izabel G.", squadPadrao: "SC", turnoPadrao: "Dom. √† Quar.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
            { nome: "Ilanna Rodrigues Nascimento", pseudo: "Noelle R.", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
            { nome: "Isabelle Cristine Marques", pseudo: "√çsis M.", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
            { nome: "Lidia Lorraine Silva Cruz", pseudo: "Alba C.", squadPadrao: "SC", turnoPadrao: "Quin. √† S√°b.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
            { nome: "Thain√° Jaqueline Batista Ferreira", pseudo: "C√≠ntia B", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
            { nome: "Elice Pisciotta", pseudo: "Yarin P.", squadPadrao: "Monitoria", turnoPadrao: "Semanal", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
            { nome: "D√©bora da Silva Lima de Jesus", pseudo: "Serena L", squadPadrao: "Monitoria", turnoPadrao: "Semanal", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 }
        ];

        // === Gemini API Helper ===
        async function callGemini(prompt) {
            // Verifica se a chave foi configurada
            // Se estivermos no preview, __gemini_api_key pode ser usado, ou a chave colada manualmente.
            let key = geminiApiKey;
            if (key.includes("COLE_SUA")) {
                 // Fallback para vari√°vel de ambiente se dispon√≠vel
                 if (typeof apiKey !== 'undefined' && apiKey) key = apiKey; 
                 else if (typeof __gemini_api_key !== 'undefined') key = __gemini_api_key;
            }

            if (!key || key.includes("COLE_SUA")) {
                throw new Error("Chave da API Gemini n√£o configurada no c√≥digo.");
            }

            // MUDAN√áA: Usando modelo est√°vel 1.5-flash para garantir compatibilidade com API Keys pessoais
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
            const delays = [1000, 2000, 4000];
            
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        if (response.status === 400 || response.status === 403) {
                            throw new Error(`Erro de Permiss√£o/Requisi√ß√£o (${response.status}): Verifique sua API Key.`);
                        }
                        throw new Error(`Erro Gemini (${response.status}): ${errText}`);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sem resposta.";
                } catch (error) {
                    if (i === delays.length) throw error;
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        // === AI Features, UI Logic, CSV Export, etc. ===
        // (Mant√©m a l√≥gica original, apenas referenciando as novas vari√°veis)

        window.handleSmartImport = async () => {
            const text = document.getElementById('import-data-json').value.trim();
            if (!text) return showMessage("Por favor, cole algum texto para importar.", 'warning');
            document.getElementById('ai-loading-overlay').classList.remove('hidden');

            const prompt = `
                Voc√™ √© um assistente de extra√ß√£o de dados de RH.
                Extraia os dados de turnos do seguinte texto (que pode ser informal, email, whatsapp, etc).
                O contexto √©: Ano atual 2025.
                Texto: "${text}"
                Retorne APENAS um JSON v√°lido (array de objetos com nome, data DD/MM/YYYY, entrada HH:MM, saida HH:MM, squadReal).
            `;

            try {
                const result = await callGemini(prompt);
                const cleanResult = result.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsedData = JSON.parse(cleanResult);
                if (!Array.isArray(parsedData) || parsedData.length === 0) throw new Error("Dados n√£o identificados.");
                await processImportedData(parsedData);
                document.getElementById('import-data-json').value = '';
            } catch (error) {
                console.error(error);
                showMessage("Erro na IA: " + error.message, 'error');
            } finally {
                document.getElementById('ai-loading-overlay').classList.add('hidden');
            }
        };

        window.analyzeMonthlyData = async () => {
            const val = document.getElementById('mes-select').value;
            if(!val) return showMessage("Selecione um m√™s primeiro.", 'warning');
            
            const [y, m] = val.split('-').map(Number);
            const filtered = allRegistros.filter(r => {
                const d = parseDate(r.data);
                // FIX DATE: Usar UTC para evitar problema de fuso (dia 1 virar dia 30 anterior)
                return d && d.getUTCFullYear() === y && d.getUTCMonth() === (m-1);
            });

            if(filtered.length === 0) return showMessage("Sem dados para analisar neste m√™s.", 'warning');

            const modalContent = document.getElementById('ai-analysis-content');
            modalContent.innerHTML = '<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>';
            openModal('ai-analysis-modal');

            const summaryData = filtered.map(r => `${r.nome} (${r.squadReal}): ${r.data} ${r.entrada}-${r.saida}`).join('\n');
            const prompt = `Analise estes dados de turnos (Scooto) para o m√™s ${val}. Dados: ${summaryData}. Forne√ßa um relat√≥rio executivo em Markdown com Resumo, Distribui√ß√£o por Squad e Alertas.`;

            try {
                const analysis = await callGemini(prompt);
                modalContent.innerHTML = marked.parse(analysis);
            } catch (e) {
                modalContent.textContent = "Erro ao gerar an√°lise: " + e.message;
            }
        };

        window.analyzeIndividualData = async () => {
            const nome = document.getElementById('relatorio-agente-select').value;
            const mes = document.getElementById('relatorio-mes-select').value;
            if(!nome || !mes) return showMessage("Selecione scooteira e m√™s.", 'warning');

            const [y, m] = mes.split('-').map(Number);
            // FIX DATE: Usar UTC
            const filtered = allRegistros.filter(r => r.nome === nome && parseDate(r.data).getUTCMonth() === (m-1));

            if(filtered.length === 0) return showMessage("Sem dados para esta scooteira.", 'warning');

            const modalContent = document.getElementById('ai-analysis-content');
            modalContent.innerHTML = '<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>';
            openModal('ai-analysis-modal');

            const prompt = `Analise o desempenho de ${nome} em ${mes}. Registos: ${JSON.stringify(filtered.map(r => ({data: r.data, entrada: r.entrada, saida: r.saida})))}. D√™ feedback construtivo.`;

            try {
                const analysis = await callGemini(prompt);
                modalContent.innerHTML = marked.parse(analysis);
            } catch (e) {
                // MUDAN√áA: Mostrar a mensagem de erro real
                console.error(e);
                modalContent.textContent = "Erro ao gerar an√°lise: " + e.message;
            }
        }

        // Fun√ß√µes de UI, L√≥gica e Helpers
        window.loadRelatorioIndividual = () => {
            const nome = document.getElementById('relatorio-agente-select').value;
            const mes = document.getElementById('relatorio-mes-select').value;
            const tbody = document.getElementById('relatorio-body');

            if(!nome || !mes) {
                document.getElementById('relatorio-resumo-cards').classList.add('hidden');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">Selecione Scooteira e M√™s.</td></tr>';
                return;
            }

            const [y, m] = mes.split('-').map(Number);
            // FIX DATE: Usar getUTCMonth e getUTCFullYear para garantir precis√£o no m√™s
            const filtered = allRegistros.filter(r => r.nome === nome && parseDate(r.data).getUTCMonth() === (m-1) && parseDate(r.data).getUTCFullYear() === y).sort((a,b) => parseDate(a.data) - parseDate(b.data));

            if(filtered.length === 0) {
                 document.getElementById('relatorio-resumo-cards').classList.add('hidden');
                 tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">Nenhum registro encontrado.</td></tr>';
                 return;
            }

            let totalSegundos = 0;
            const squadsDuration = {}; // Mudado para somar dura√ß√£o
            
            tbody.innerHTML = '';
            filtered.forEach(r => {
                totalSegundos += r.duracaoSegundos;
                // Acumula segundos por squad
                squadsDuration[r.squadReal] = (squadsDuration[r.squadReal] || 0) + r.duracaoSegundos;
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition border-b border-gray-50";
                const dateObj = parseDate(r.data);
                const diaSemana = dateObj.toLocaleDateString('pt-BR', { weekday: 'short', timeZone: 'UTC' }); // For√ßar UTC no display do dia da semana tamb√©m
                tr.innerHTML = `<td class="px-6 py-3 font-medium text-gray-900">${r.data}</td><td class="px-6 py-3 text-xs text-gray-500 uppercase">${diaSemana}</td><td class="px-6 py-3">${getSquadBadge(r.squadReal)}</td><td class="px-6 py-3 font-mono text-xs">${r.entrada}</td><td class="px-6 py-3 font-mono text-xs">${r.saida}</td><td class="px-6 py-3 font-mono text-xs font-semibold text-gray-600">${formatDuration(r.duracaoSegundos)}</td><td class="px-6 py-3 text-xs text-gray-500">${r.turnoAtuado}</td>`;
                tbody.appendChild(tr);
            });

            // Resumo Geral
            document.getElementById('resumo-total-dias').textContent = filtered.length;
            const [h, min] = formatDuration(totalSegundos).split(':');
            document.getElementById('resumo-total-horas').innerHTML = `${h}<span class="text-sm font-normal text-gray-400">h</span> ${min}<span class="text-sm font-normal text-gray-400">m</span>`;
            
            // Resumo por Squad (Novo)
            const squadsListContainer = document.getElementById('resumo-squads-list');
            squadsListContainer.innerHTML = '';
            
            Object.entries(squadsDuration).sort((a,b) => b[1] - a[1]).forEach(([squad, duracao]) => {
                const [sqH, sqM] = formatDuration(duracao).split(':');
                
                // Pega cor baseada no badge existente
                let colorClass = "bg-gray-100 text-gray-700 border-gray-200";
                if(squad === 'CB') colorClass = "bg-indigo-50 text-indigo-700 border-indigo-200";
                else if(squad === 'SC') colorClass = "bg-purple-50 text-purple-700 border-purple-200";
                else if(squad.includes('Rec')) colorClass = "bg-red-50 text-red-700 border-red-200";
                else if(squad.includes('Monitoria')) colorClass = "bg-yellow-50 text-yellow-700 border-yellow-200";
                else if(squad === 'OJR') colorClass = "bg-orange-50 text-orange-700 border-orange-200";

                const pill = document.createElement('div');
                pill.className = `flex items-center px-3 py-2 rounded-lg border ${colorClass}`;
                pill.innerHTML = `
                    <span class="text-xs font-bold uppercase mr-2">${squad}</span>
                    <span class="text-sm font-mono font-semibold">${sqH}h${sqM}</span>
                `;
                squadsListContainer.appendChild(pill);
            });

            document.getElementById('relatorio-resumo-cards').classList.remove('hidden');
        };

        window.exportToCsv = () => {
            const val = document.getElementById('mes-select').value;
            if(!val) return showMessage("Selecione um m√™s.", 'warning');
            const [y, m] = val.split('-').map(Number);
            // FIX DATE
            const filtered = allRegistros.filter(r => { const d = parseDate(r.data); return d && d.getUTCFullYear() === y && d.getUTCMonth() === (m-1); }).sort((a,b) => parseDate(a.data) - parseDate(b.data));
            if(filtered.length === 0) return showMessage("Sem dados.", 'warning');
            const headers = ["Data", "Nome", "Pseudo", "Squad", "Entrada", "Sa√≠da", "Dura√ß√£o (h)", "Turno"];
            const rows = filtered.map(r => [r.data, r.nome, r.pseudo, r.squadReal, r.entrada, r.saida, (r.duracaoSegundos / 3600).toFixed(2).replace('.', ','), r.turnoAtuado]);
            downloadCSV([headers, ...rows], `Relatorio_Geral_${val}.csv`);
        };

        window.exportIndividualCsv = () => {
            const nome = document.getElementById('relatorio-agente-select').value;
            const mes = document.getElementById('relatorio-mes-select').value;
            if(!nome || !mes) return showMessage("Selecione dados.", 'warning');
            const [y, m] = mes.split('-').map(Number);
            // FIX DATE
            const filtered = allRegistros.filter(r => r.nome === nome && parseDate(r.data).getUTCMonth() === (m-1)).sort((a,b) => parseDate(a.data) - parseDate(b.data));
            if(filtered.length === 0) return showMessage("Sem dados.", 'warning');
            const headers = ["Data", "Nome", "Squad", "Entrada", "Sa√≠da", "Dura√ß√£o (h)", "Turno"];
            const rows = filtered.map(r => [r.data, r.nome, r.squadReal, r.entrada, r.saida, (r.duracaoSegundos / 3600).toFixed(2).replace('.', ','), r.turnoAtuado]);
            downloadCSV([headers, ...rows], `Relatorio_${nome.split(' ')[0]}_${mes}.csv`);
        };

        function downloadCSV(data, filename) {
            const csvContent = data.map(e => e.join(";")).join("\n");
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        window.switchTab = (tabName) => {
            ['registro', 'relatorio', 'cadastro'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const content = document.getElementById(`content-${t}`);
                if (btn && content) { btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); content.classList.add('hidden'); }
            });
            const activeBtn = document.getElementById(`tab-${tabName}`);
            const activeContent = document.getElementById(`content-${tabName}`);
            if (activeBtn && activeContent) { activeBtn.classList.add('tab-active'); activeBtn.classList.remove('tab-inactive'); activeContent.classList.remove('hidden'); }
            
            // For√ßar atualiza√ß√£o do relat√≥rio ao trocar de aba
            if (tabName === 'relatorio') {
                window.loadRelatorioIndividual();
            }

            hideMessage();
            refreshIcons();
        };

        window.showSelectionModal = () => openModal('selection-modal');
        window.showImportModal = () => openModal('import-modal');
        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); };
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex'); refreshIcons(); }
        function refreshIcons() { if (typeof lucide !== 'undefined') lucide.createIcons(); }
        function showMessage(text, type = 'info') {
            const box = document.getElementById('message-box');
            box.textContent = text;
            box.className = 'mx-6 mt-6 p-4 text-sm rounded-lg shadow-sm border-l-4 transition-all flex items-center';
            if (type === 'success') box.className += ' bg-emerald-50 text-emerald-800 border-emerald-500';
            else if (type === 'error') box.className += ' bg-red-50 text-red-800 border-red-500';
            else box.className += ' bg-amber-50 text-amber-800 border-amber-500';
            box.classList.remove('hidden');
            setTimeout(() => { if(!box.classList.contains('hidden')) hideMessage(); }, 5000);
        }
        function hideMessage() { document.getElementById('message-box').classList.add('hidden'); }
        function formatDate(date) { return date.toLocaleDateString('pt-BR', {timeZone: 'UTC'}); }
        function parseDate(dateStr) { if(!dateStr) return new Date(); const [day, m, y] = dateStr.split('/'); return new Date(Date.UTC(y, m-1, day)); }
        function formatDuration(sec) { const h = Math.floor(sec / 3600); const m = Math.floor((sec % 3600) / 60); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
        function calculateDuration(start, end) { const toSec = (t) => { const [h,m] = t.split(':').map(Number); return h*3600 + m*60; }; let diff = toSec(end) - toSec(start); if (diff <= 0) diff += 24*3600; return diff; }
        function checkDuplicate(nome, data, excludeId=null) { return allRegistros.some(r => r.nome === nome && r.data === data && r.id !== excludeId); }
        
        window.toggleAgentSelection = (nome) => {
            const idx = selectedAgentsNames.indexOf(nome);
            if (idx > -1) selectedAgentsNames.splice(idx, 1);
            else selectedAgentsNames.push(nome);
            updateSelectionDisplay();
        };

        function updateSelectionDisplay() {
            const btn = document.getElementById('agentes-selection-display');
            const count = selectedAgentsNames.length;
            const span = btn.querySelector('span');
            if (count === 0) { span.textContent = 'Clique para selecionar...'; btn.classList.remove('border-indigo-500', 'ring-1', 'ring-indigo-500'); }
            else { span.textContent = `${count} Agente(s) Selecionada(s)`; btn.classList.add('border-indigo-500', 'ring-1', 'ring-indigo-500'); }
        }

        // Firebase Init Logic Atualizada para GitHub Pages
        async function initApp() {
            // Verificar se o usu√°rio preencheu a config
            // No preview, usamos a l√≥gica "typeof" abaixo, ent√£o ele n√£o cair√° no erro se as chaves manuais estiverem vazias, desde que a var de ambiente exista.
            if (firebaseConfig.apiKey && firebaseConfig.apiKey.includes("COLE_SUA")) {
                showMessage("ATEN√á√ÉO: Configure as chaves do Firebase no arquivo index.html!", 'error');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, browserSessionPersistence);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('auth-status').textContent = 'Conectado';
                        document.getElementById('auth-status').className = 'text-xs text-emerald-200 font-mono bg-emerald-800 py-1 px-2 rounded';
                        loadData();
                    } else {
                        // Apenas login an√¥nimo suportado no modo GitHub Pages por padr√£o
                        await signInAnonymously(auth);
                    }
                });
            } catch (e) {
                console.error(e);
                showMessage("Erro de inicializa√ß√£o do Firebase: " + e.message, 'error');
            }
        }

        // L√ìGICA DE CARREGAMENTO ATUALIZADA
        function loadData() {
            const cadastroRef = collection(db, `artifacts/${appId}/public/data/scooteiras_cadastro`);
            
            // 1. Renderiza o MOCK localmente IMEDIATAMENTE para feedback visual
            // (Assim voc√™ v√™ a lista mesmo se o banco demorar para conectar)
            if (scooteirasCadastro.length === 0) {
                 scooteirasCadastro = [...MOCK_CADASTROS].sort((a,b) => a.nome.localeCompare(b.nome));
                 renderCheckboxes();
                 renderCadastro();
            }

            // 2. Conecta ao banco para pegar dados reais
            onSnapshot(cadastroRef, async (snap) => {
                if (snap.empty) {
                    // Se o banco est√° vazio, tenta salvar o Mock l√° silenciosamente
                    try {
                        const batch = writeBatch(db);
                        MOCK_CADASTROS.forEach(s => {
                            const ref = doc(cadastroRef, s.nome);
                            batch.set(ref, s);
                        });
                        await batch.commit();
                        console.log("Banco estava vazio. Padr√µes salvos automaticamente.");
                    } catch (e) {
                        console.error("Erro ao salvar padr√µes autom√°ticos:", e);
                    }
                } else {
                    // Se tem dados no banco, usa eles (sobrescreve o mock local)
                    scooteirasCadastro = snap.docs.map(d => d.data()).sort((a,b) => a.nome.localeCompare(b.nome));
                    agentesByPseudo = {};
                    scooteirasCadastro.forEach(a => { if(a.pseudo) agentesByPseudo[a.pseudo] = a; });
                    
                    renderCheckboxes();
                    renderCadastro();
                }
            }, (error) => {
                 console.error("Erro no Snapshot:", error);
                 // Se der erro de conex√£o, mant√©m o mock local que j√° carregamos no passo 1
                 showMessage("Usando dados locais (Modo Offline).", 'warning');
            });

            const monthInput = document.getElementById('mes-select');
            if(monthInput) loadHistorico();
        }
        function loadHistorico() {
            if(!db) return;
            const val = document.getElementById('mes-select').value;
            if(!val) return;
            const [y, m] = val.split('-').map(Number);
            onSnapshot(collection(db, `artifacts/${appId}/public/data/registros_diarios`), (snap) => {
                allRegistros = snap.docs.map(d => ({id: d.id, ...d.data()}));
                // FIX DATE: Usar getUTCMonth e getUTCFullYear
                const filtered = allRegistros.filter(r => { const d = parseDate(r.data); return d && d.getUTCFullYear() === y && d.getUTCMonth() === (m-1); }).sort((a,b) => parseDate(a.data) - parseDate(b.data));
                renderHistoryTable(filtered);
                renderSummary(filtered);
                if(!document.getElementById('content-relatorio').classList.contains('hidden')) { window.loadRelatorioIndividual(); }
            });
        };

        // Nova fun√ß√£o para for√ßar o reset
        window.forceResetDefaults = async () => {
            if(!confirm("Tem certeza? Isso vai apagar TODAS as agentes cadastradas e restaurar a lista padr√£o de 20 nomes.")) return;
            
            showMessage("Restaurando padr√µes...", 'info');
            try {
                // 1. Apagar tudo primeiro
                const cadastroRef = collection(db, `artifacts/${appId}/public/data/scooteiras_cadastro`);
                const snap = await getDocs(cadastroRef);
                const batchDel = writeBatch(db);
                snap.docs.forEach(d => batchDel.delete(d.ref));
                await batchDel.commit();

                // 2. Inserir Mock
                const batchAdd = writeBatch(db);
                MOCK_CADASTROS.forEach(s => {
                    const ref = doc(cadastroRef, s.nome);
                    batchAdd.set(ref, s);
                });
                await batchAdd.commit();
                
                showMessage("Lista padr√£o restaurada com sucesso!", 'success');
            } catch (e) {
                console.error(e);
                showMessage("Erro ao restaurar: " + e.message, 'error');
            }
        };

        function renderCadastro() {
            const tbody = document.getElementById('cadastro-list-body');
            tbody.innerHTML = '';
            if(scooteirasCadastro.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">Nenhuma scooteira cadastrada.</td></tr>';
                return;
            }
            scooteirasCadastro.forEach(a => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition border-b border-gray-50 last:border-0";
                tr.innerHTML = `<td class="px-6 py-3 font-medium text-gray-900">${a.nome} <span class="block text-xs text-gray-400 font-normal">${a.pseudo}</span></td><td class="px-6 py-3">${getSquadBadge(a.squadPadrao)}</td><td class="px-6 py-3 text-sm text-gray-600">${a.turnoPadrao}</td><td class="px-6 py-3 font-mono text-xs text-gray-500">${a.entradaPadrao} - ${a.saidaPadrao}</td><td class="px-6 py-3 text-right"><div class="flex justify-end space-x-2"><button onclick="editAgent('${a.nome}')" class="p-1 text-blue-600 hover:bg-blue-50 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteAgentConfirmation('${a.nome}')" class="p-1 text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td>`;
                tbody.appendChild(tr);
            });
            refreshIcons();
        }

        function renderCheckboxes() {
            const container = document.getElementById('agentes-checkbox-list');
            const reportSelect = document.getElementById('relatorio-agente-select');
            container.innerHTML = '';
            reportSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
            scooteirasCadastro.forEach(a => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-2 hover:bg-gray-50 rounded transition cursor-pointer';
                div.onclick = (e) => { if(e.target.type !== 'checkbox') { const cb = div.querySelector('input'); cb.checked = !cb.checked; window.toggleAgentSelection(a.nome); } };
                div.innerHTML = `<input type="checkbox" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${selectedAgentsNames.includes(a.nome) ? 'checked' : ''} onchange="window.toggleAgentSelection('${a.nome}')"><div class="ml-3 text-sm"><p class="font-medium text-gray-700">${a.nome}</p><p class="text-xs text-gray-500">${a.pseudo}</p></div>`;
                container.appendChild(div);
                const opt = document.createElement('option');
                opt.value = a.nome;
                opt.textContent = a.nome;
                reportSelect.appendChild(opt);
            });
        }

        function renderHistoryTable(data) {
            const tbody = document.getElementById('historico-body');
            tbody.innerHTML = '';
            if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">Nenhum registro encontrado.</td></tr>'; return; }
            data.forEach(r => {
                const badgeColor = getSquadBadge(r.squadReal);
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition border-b border-gray-50 last:border-0";
                tr.innerHTML = `<td class="px-6 py-3 font-medium text-gray-900 whitespace-nowrap">${r.data}</td><td class="px-6 py-3"><div class="flex flex-col"><span class="font-medium text-gray-700">${r.nome}</span><span class="text-xs text-gray-400">${r.pseudo || '-'}</span></div></td><td class="px-6 py-3">${badgeColor}</td><td class="px-6 py-3 font-mono text-xs">${r.entrada}</td><td class="px-6 py-3 font-mono text-xs">${r.saida}</td><td class="px-6 py-3 font-mono text-xs text-gray-500">${formatDuration(r.duracaoSegundos)}</td><td class="px-6 py-3 text-xs">${r.turnoAtuado}</td><td class="px-6 py-3 text-right"><div class="flex justify-end space-x-2"><button onclick="editRegistro('${r.id}')" class="p-1 text-blue-600 hover:bg-blue-50 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteRegistroConfirmation('${r.id}')" class="p-1 text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td>`;
                tbody.appendChild(tr);
            });
            refreshIcons();
        }

        function renderSummary(data) {
            const container = document.getElementById('resumo-squads');
            container.innerHTML = '';
            const totals = {};
            let grandTotal = 0;

            // 1. Agrega√ß√£o e Normaliza√ß√£o
            data.forEach(r => { 
                let s = r.squadReal ? r.squadReal.trim() : 'Outro';
                
                // Normaliza√ß√£o robusta para garantir agrupamento correto
                const lower = s.toLowerCase();
                if(lower.includes('rec') || lower.includes('cr√©dito') || lower.includes('credito')) {
                    s = 'Rec Cred';
                } else if(lower.includes('monitor')) {
                    s = 'Monitoria';
                }

                if(!totals[s]) totals[s] = 0; 
                totals[s] += r.duracaoSegundos; 
                grandTotal += r.duracaoSegundos;
            });
            
            // Helper para estilos
            const getCardStyle = (name) => {
                if (name === 'SC') return 'border-l-4 border-purple-500';
                if (name === 'Rec Cred' || name.toLowerCase().includes('rec')) return 'border-l-4 border-red-600'; // Vermelho aqui
                if (name.includes('Monitoria')) return 'border-l-4 border-yellow-500';
                if (name === 'OJR') return 'border-l-4 border-orange-500';
                if (name === 'CB') return 'border-l-4 border-indigo-500';
                return 'border-l-4 border-gray-500';
            };

            // Helper para style inline for√ßado (para garantir override)
            const getInlineStyle = (name) => {
                if (name === 'Rec Cred' || name.toLowerCase().includes('rec')) {
                    return 'style="border-left-color: #dc2626 !important;"'; // For√ßa vermelho
                }
                return '';
            };

            // 2. Renderiza Squads Fixos
            SQUADS_OPCOES.forEach(s => {
                const sec = totals[s] || 0;
                if (sec === 0) return;

                const [h, m] = formatDuration(sec).split(':');
                const borderClass = getCardStyle(s);
                const styleAttr = getInlineStyle(s);

                container.innerHTML += `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 ${borderClass}" ${styleAttr}>
                        <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">${s}</h3>
                        <p class="text-2xl font-bold text-gray-800">
                            ${h}<span class="text-sm text-gray-400 font-normal">h</span> 
                            ${m}<span class="text-sm text-gray-400 font-normal">m</span>
                        </p>
                    </div>`;
            });
            
            // 3. Renderiza Outros Squads
            Object.keys(totals).forEach(s => {
                if (!SQUADS_OPCOES.includes(s)) {
                    const sec = totals[s];
                    if (sec === 0) return;

                    const [h, m] = formatDuration(sec).split(':');
                    const borderClass = getCardStyle(s);
                    const styleAttr = getInlineStyle(s);

                    container.innerHTML += `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 ${borderClass}" ${styleAttr}>
                            <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">${s}</h3>
                            <p class="text-2xl font-bold text-gray-800">
                                ${h}<span class="text-sm text-gray-400 font-normal">h</span> 
                                ${m}<span class="text-sm text-gray-400 font-normal">m</span>
                            </p>
                        </div>`;
                }
            });

            // Total Geral
            const [gh, gm] = formatDuration(grandTotal).split(':');
             container.innerHTML += `
                <div class="bg-gradient-to-br from-indigo-600 to-blue-600 p-4 rounded-lg shadow-md text-white flex flex-col justify-between">
                    <h3 class="text-xs font-bold text-indigo-100 uppercase mb-1 flex items-center">
                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i> Total Geral
                    </h3>
                    <p class="text-3xl font-bold">${gh}<span class="text-sm text-indigo-200 font-normal">h</span> ${gm}<span class="text-sm text-indigo-200 font-normal">m</span></p>
                </div>`;

            refreshIcons();
        }

        function getSquadBadge(squad) {
            let classes = "bg-gray-100 text-gray-800";
            if(squad === 'CB') classes = "bg-indigo-100 text-indigo-800";
            else if(squad === 'SC') classes = "bg-purple-100 text-purple-800";
            else if(squad === 'Rec Cred') classes = "bg-pink-100 text-pink-800";
            else if(squad === 'Monitoria') classes = "bg-yellow-100 text-yellow-800";
            else if(squad === 'OJR') classes = "bg-orange-100 text-orange-800";
            return `<span class="px-2 py-1 rounded-full text-xs font-semibold ${classes}">${squad}</span>`;
        }

        // --- Eventos de Formul√°rios ---
        document.getElementById('add-agent-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('new-nome').value.trim();
            const pseudo = document.getElementById('new-pseudo').value.trim();
            const squad = document.getElementById('new-squad').value;
            const turno = document.getElementById('new-turno').value;
            const entrada = document.getElementById('new-entrada').value;
            const saida = document.getElementById('new-saida').value;
            if(!nome || !pseudo) { showMessage("Preencha nome e pseudo.", 'error'); return; }
            try {
                const newAgent = { nome, pseudo, squadPadrao: squad, turnoPadrao: turno, entradaPadrao: entrada, saidaPadrao: saida, cargaPadrao: 6 };
                await setDoc(doc(db, `artifacts/${appId}/public/data/scooteiras_cadastro`, nome), newAgent);
                showMessage("Agente adicionada!", 'success');
                e.target.reset(); document.getElementById('new-entrada').value = "08:00"; document.getElementById('new-saida').value = "14:00";
            } catch(err) { console.error(err); showMessage("Erro: " + err.message, 'error'); }
        });

        window.handleEntrySubmission = () => {
            const dateInput = document.getElementById('data-atuacao').value;
            if(!dateInput || selectedAgentsNames.length === 0) { showMessage("Selecione data e agentes.", 'error'); return; }
            const [y,m,d] = dateInput.split('-'); const dataFormatada = `${d}/${m}/${y}`;
            const agents = selectedAgentsNames.map(n => scooteirasCadastro.find(a => a.nome === n));
            if(agents.some(a => checkDuplicate(a.nome, dataFormatada))) { showMessage("Aten√ß√£o: Duplicidade detectada.", 'warning'); return; }
            document.getElementById('recordIdToEdit').value = '';
            document.getElementById('details-modal-title').textContent = 'Confirmar Lan√ßamentos';
            document.getElementById('modal-instructions').textContent = `Data: ${dataFormatada}`;
            const container = document.getElementById('agentes-detalhes-container'); container.innerHTML = '';
            agents.forEach((a, idx) => {
                let defTurno = "Meu Turno";
                const html = `<div class="bg-gray-50 p-4 rounded-lg border border-gray-200" data-agent-block="${idx}"><div class="flex justify-between mb-3"><h4 class="font-bold text-sm text-gray-800">${a.nome}</h4><span class="text-xs bg-white border px-2 py-0.5 rounded text-gray-500">${a.squadPadrao}</span></div><input type="hidden" name="nome_${idx}" value="${a.nome}"><input type="hidden" name="pseudo_${idx}" value="${a.pseudo}"><input type="hidden" name="data_${idx}" value="${dataFormatada}"><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Entrada</label><input type="time" name="entrada_${idx}" value="${a.entradaPadrao}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500"></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Sa√≠da</label><input type="time" name="saida_${idx}" value="${a.saidaPadrao}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500"></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Squad Real</label><select name="squad_${idx}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500">${SQUADS_OPCOES.map(s => `<option value="${s}" ${s===a.squadPadrao?'selected':''}>${s}</option>`).join('')}</select></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Turno</label><select name="turno_${idx}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500">${TURNOS_OPCOES.map(t => `<option value="${t}" ${t===defTurno?'selected':''}>${t}</option>`).join('')}</select></div></div></div>`;
                container.innerHTML += html;
            });
            openModal('details-modal');
        };

        document.getElementById('details-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const isUpdate = !!document.getElementById('recordIdToEdit').value;
            const entries = [];
            for(let i=0; i<100; i++) {
                const nome = formData.get(`nome_${i}`); if(!nome) break;
                const entrada = formData.get(`entrada_${i}`); const saida = formData.get(`saida_${i}`);
                const entry = { nome: nome, pseudo: formData.get(`pseudo_${i}`), data: formData.get(`data_${i}`), entrada: entrada, saida: saida, squadReal: formData.get(`squad_${i}`), turnoAtuado: formData.get(`turno_${i}`), duracaoSegundos: calculateDuration(entrada, saida), registradoEm: new Date().toISOString() };
                if(isUpdate) entry.id = document.getElementById('recordIdToEdit').value;
                entries.push(entry);
            }
            try {
                if(isUpdate) { const { id, ...data } = entries[0]; await updateDoc(doc(db, `artifacts/${appId}/public/data/registros_diarios`, id), data); showMessage("Atualizado!", 'success'); }
                else { await runTransaction(db, async (txn) => { const col = collection(db, `artifacts/${appId}/public/data/registros_diarios`); entries.forEach(ent => txn.set(doc(col), ent)); }); showMessage("Salvo!", 'success'); selectedAgentsNames = []; updateSelectionDisplay(); renderCheckboxes(); document.getElementById('data-atuacao').value = ''; }
                closeModal('details-modal');
            } catch(err) { console.error(err); showMessage("Erro: " + err.message, 'error'); }
        });

        window.editRegistro = (id) => {
            const rec = allRegistros.find(r => r.id === id); if(!rec) return;
            document.getElementById('recordIdToEdit').value = id;
            document.getElementById('details-modal-title').textContent = 'Editar Lan√ßamento';
            document.getElementById('modal-instructions').textContent = '';
            const container = document.getElementById('agentes-detalhes-container');
            container.innerHTML = `<div class="bg-gray-50 p-4 rounded-lg border border-gray-200"><div class="flex justify-between mb-3"><h4 class="font-bold text-sm text-gray-800">${rec.nome}</h4><span class="text-xs text-gray-500">${rec.data}</span></div><input type="hidden" name="nome_0" value="${rec.nome}"><input type="hidden" name="pseudo_0" value="${rec.pseudo}"><input type="hidden" name="data_0" value="${rec.data}"><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Entrada</label><input type="time" name="entrada_0" value="${rec.entrada}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500"></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Sa√≠da</label><input type="time" name="saida_0" value="${rec.saida}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500"></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Squad Real</label><select name="squad_0" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500">${SQUADS_OPCOES.map(s => `<option value="${s}" ${s===rec.squadReal?'selected':''}>${s}</option>`).join('')}</select></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Turno</label><select name="turno_0" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500">${TURNOS_OPCOES.map(t => `<option value="${t}" ${t===rec.turnoAtuado?'selected':''}>${t}</option>`).join('')}</select></div></div></div>`;
            openModal('details-modal');
        };

        // ... Resto das fun√ß√µes de dele√ß√£o e importa√ß√£o (mantidas do c√≥digo original) ...
        let confirmationCallback = null;
        window.resolveConfirmation = (val) => { closeModal('confirmation-modal'); if(confirmationCallback) confirmationCallback(val); confirmationCallback = null; };
        window.deleteRegistroConfirmation = (id) => { document.getElementById('confirm-title').textContent = "Excluir Registro?"; document.getElementById('confirm-message').textContent = "Essa a√ß√£o n√£o pode ser desfeita."; openModal('confirmation-modal'); confirmationCallback = async (confirmed) => { if(confirmed) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/registros_diarios`, id)); showMessage("Registro exclu√≠do.", 'success'); } }; };
        window.deleteAgentConfirmation = (nome) => { document.getElementById('confirm-title').textContent = "Excluir Agente?"; document.getElementById('confirm-message').textContent = `Remover ${nome}?`; openModal('confirmation-modal'); confirmationCallback = async (confirmed) => { if(confirmed) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/scooteiras_cadastro`, nome)); showMessage("Cadastro removido.", 'success'); } }; };

        async function processImportedData(rows) {
             const valid = [];
             let unknownAgents = 0;
             let duplicates = 0;

             for(const item of rows) {
                let agent = agentesByPseudo[item.nome] || scooteirasCadastro.find(a => a.nome === item.nome || a.pseudo === item.nome);
                if(!agent) agent = scooteirasCadastro.find(a => item.nome.includes(a.pseudo));
                
                if(!agent) {
                    unknownAgents++;
                    console.warn(`Agente desconhecida: ${item.nome}`);
                    continue;
                }

                if(checkDuplicate(agent.nome, item.data)) {
                    duplicates++;
                    continue;
                }

                valid.push({ nome: agent.nome, pseudo: agent.pseudo, data: item.data, entrada: item.entrada, saida: item.saida, squadReal: item.squadReal || agent.squadPadrao, turnoAtuado: "Meu Turno", duracaoSegundos: calculateDuration(item.entrada, item.saida), registradoEm: new Date().toISOString() });
             }

             if(valid.length) {
                 await runTransaction(db, async (txn) => { const col = collection(db, `artifacts/${appId}/public/data/registros_diarios`); valid.forEach(v => txn.set(doc(col), v)); });
                 showMessage(`Importado ${valid.length} registros.`, 'success'); closeModal('import-modal');
             } else { 
                 if (unknownAgents > 0) showMessage(`Erro: ${unknownAgents} nome(s) n√£o encontrados na aba Equipe. Cadastre-as primeiro!`, 'error');
                 else if (duplicates > 0) showMessage(`Aten√ß√£o: Todos os ${duplicates} registros j√° existiam no sistema.`, 'warning');
                 else showMessage("Nenhum dado v√°lido encontrado.", 'warning'); 
             }
        }

        window.handleImport = async () => {
             const text = document.getElementById('import-data-json').value.trim();
             if(!text) return;
             try { const rows = parseTabularData(text); await processImportedData(rows); document.getElementById('import-data-json').value = ''; }
             catch(e) { showMessage("Erro: " + e.message, 'error'); }
        };
        
        function parseTabularData(text) {
             const lines = text.split('\n').filter(l => l.trim());
             if(lines.length < 2) throw new Error("Dados insuficientes");
             const seps = ['\t', ';', ',', '|']; let sep = ','; let max = 0; seps.forEach(s => { const c = lines[1].split(s).length; if(c>max){max=c; sep=s;} });
             const headers = lines[0].split(sep).map(h => h.toLowerCase().replace(/[^a-z]/g, ''));
             const map = { 'data': 'data', 'nome': 'nome', 'agente': 'nome', 'scooteira': 'nome', 'email': 'nome', 'entrada': 'entrada', 'inicio': 'entrada', 'saida': 'saida', 'termino': 'saida', 'squad': 'squadReal', 'sua': 'squadReal', 'turno': 'turnoAtuado' };
             const data = [];
             for(let i=1; i<lines.length; i++) {
                 const cols = lines[i].split(sep); let obj = {};
                 cols.forEach((c, idx) => { const h = headers[idx]; for(let k in map) if(h.includes(k)) obj[map[k]] = c.replace(/"/g, '').trim(); });
                 if(obj.nome && obj.data && obj.entrada) {
                     if(obj.entrada.length > 5) obj.entrada = obj.entrada.substring(0,5);
                     if(obj.saida && obj.saida.length > 5) obj.saida = obj.saida.substring(0,5);
                     if(obj.nome.includes('@') || obj.nome.length > 30) { const parts = obj.nome.split(' '); if(parts.length > 1) obj.nome = parts.slice(-2).join(' '); }
                     data.push(obj);
                 }
             }
             return data;
        }

        window.editAgent = (nome) => {
            const a = scooteirasCadastro.find(x => x.nome === nome); if(!a) return;
            if(!document.getElementById('edit-agent-modal')) {
                const m = document.createElement('div'); m.id = 'edit-agent-modal'; m.className = 'fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50';
                m.innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8"><h3 class="text-xl font-bold text-indigo-700 mb-6">Editar Cadastro</h3><form id="edit-agent-form" class="space-y-4"><input type="hidden" id="ea-orig"><div><label class="text-xs uppercase font-bold text-gray-400">Nome</label><input id="ea-nome" class="w-full p-2 border rounded bg-gray-50" disabled></div><div><label class="text-xs uppercase font-bold text-gray-400">Pseudo</label><input id="ea-pseudo" class="w-full p-2 border rounded"></div><div><label class="text-xs uppercase font-bold text-gray-400">Squad</label><select id="ea-squad" class="w-full p-2 border rounded">${SQUADS_OPCOES.map(s=>`<option>${s}</option>`).join('')}</select></div><div><label class="text-xs uppercase font-bold text-gray-400">Dias</label><input id="ea-dias" class="w-full p-2 border rounded"></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs uppercase font-bold text-gray-400">Entrada</label><input type="time" id="ea-ent" class="w-full p-2 border rounded"></div><div><label class="text-xs uppercase font-bold text-gray-400">Sa√≠da</label><input type="time" id="ea-sai" class="w-full p-2 border rounded"></div></div><div class="pt-4 flex justify-end space-x-2"><button type="button" onclick="closeModal('edit-agent-modal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Salvar</button></div></form></div>`;
                document.body.appendChild(m);
                document.getElementById('edit-agent-form').addEventListener('submit', async (e)=>{ e.preventDefault(); const nome = document.getElementById('ea-orig').value; await updateDoc(doc(db, `artifacts/${appId}/public/data/scooteiras_cadastro`, nome), { pseudo: document.getElementById('ea-pseudo').value, squadPadrao: document.getElementById('ea-squad').value, turnoPadrao: document.getElementById('ea-dias').value, entradaPadrao: document.getElementById('ea-ent').value, saidaPadrao: document.getElementById('ea-sai').value }); showMessage("Salvo.", 'success'); closeModal('edit-agent-modal'); });
            }
            document.getElementById('ea-orig').value = a.nome; document.getElementById('ea-nome').value = a.nome; document.getElementById('ea-pseudo').value = a.pseudo; document.getElementById('ea-squad').value = a.squadPadrao; document.getElementById('ea-dias').value = a.turnoPadrao; document.getElementById('ea-ent').value = a.entradaPadrao; document.getElementById('ea-sai').value = a.saidaPadrao;
            openModal('edit-agent-modal');
        };

        window.onload = () => { const d = new Date(); const m = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; document.getElementById('mes-select').value = m; document.getElementById('relatorio-mes-select').value = m; initApp(); };
    </script>
</body>
</html>
