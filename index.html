<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Atua√ß√£o - Scooto</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõµ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; color: #334155; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #334155; border-bottom: 2px solid #cbd5e1; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8 pb-24">

    <div id="app" class="w-full max-w-6xl bg-white rounded-2xl shadow-xl overflow-hidden relative">

        <header class="bg-indigo-600 p-6 sm:p-10 text-white">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight">Dash Atua√ß√£o - Scooto</h1>
                    <p class="text-indigo-100 text-sm mt-1">Controle de Squads e Scooteiras</p>
                </div>
                <div class="hidden md:block text-right">
                    <p id="auth-status" class="text-xs text-indigo-200 font-mono bg-indigo-800 py-1 px-2 rounded">Conectando...</p>
                </div>
            </div>
        </header>

        <div class="flex border-b border-gray-200 bg-gray-50 px-6 overflow-x-auto">
            <button id="tab-registro" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-active whitespace-nowrap" onclick="window.switchTab('registro')">
                <span class="flex items-center"><i data-lucide="calendar-check" class="w-4 h-4 mr-2"></i> Registro Di√°rio</span>
            </button>
            <button id="tab-relatorio" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('relatorio')">
                <span class="flex items-center"><i data-lucide="bar-chart-3" class="w-4 h-4 mr-2"></i> Relat√≥rios</span>
            </button>
            <button id="tab-cadastro" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('cadastro')">
                <span class="flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i> Equipe</span>
            </button>
        </div>

        <div id="message-box" class="hidden mx-6 mt-6 p-4 text-sm rounded-lg shadow-sm border-l-4 transition-all" role="alert"></div>

        <div class="p-6 sm:p-8 min-h-[500px]">

            <div id="content-registro" class="animate-fade-in">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6 mb-8 shadow-sm">
                    <h2 class="text-lg font-semibold text-indigo-900 mb-4 flex items-center">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Novo Lan√ßamento
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-3">
                            <label class="block text-xs font-medium text-gray-600 mb-1 uppercase tracking-wide">Data</label>
                            <input type="date" id="data-atuacao" class="w-full p-2.5 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        </div>
                        <div class="md:col-span-6">
                            <label class="block text-xs font-medium text-gray-600 mb-1 uppercase tracking-wide">Scooteira(s)</label>
                            <input type="hidden" id="selected-agents-input">
                            <button type="button" id="agentes-selection-display" onclick="window.showSelectionModal()" 
                                    class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-left text-gray-500 hover:border-indigo-400 transition shadow-sm flex items-center justify-between text-sm">
                                <span>Clique para selecionar...</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="md:col-span-3">
                            <button id="btn-registrar" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 px-4 rounded-lg font-medium shadow-md transition flex items-center justify-center" onclick="window.handleEntrySubmission()">
                                <span>Registrar</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-800">Hist√≥rico Mensal</h2>
                    <div class="flex items-center space-x-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <label for="mes-select" class="text-sm font-medium text-gray-600">M√™s:</label>
                        <input type="month" id="mes-select" class="bg-white border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500 py-1" onchange="window.loadHistorico()">
                        <div class="h-4 w-px bg-gray-300 mx-2"></div>
                        <button class="text-gray-600 hover:text-indigo-600 text-sm font-medium flex items-center transition" onclick="window.exportToCsv()">
                             <i data-lucide="download" class="w-4 h-4 mr-1"></i> CSV
                        </button>
                        <button class="text-gray-600 hover:text-blue-600 text-sm font-medium flex items-center transition ml-3" onclick="window.showImportModal()">
                             <i data-lucide="upload" class="w-4 h-4 mr-1"></i> Importar
                        </button>
                    </div>
                </div>

                <div id="resumo-squads" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>

                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200 mb-12">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-3 w-4">
                                    <input type="checkbox" id="select-all-history" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" onclick="window.toggleSelectAll()">
                                </th>
                                <th class="px-6 py-3 font-medium">Data</th>
                                <th class="px-6 py-3 font-medium">Nome</th>
                                <th class="px-6 py-3 font-medium">Pseudo</th>
                                <th class="px-6 py-3 font-medium">Squad</th>
                                <th class="px-6 py-3 font-medium">Entrada</th>
                                <th class="px-6 py-3 font-medium">Sa√≠da</th>
                                <th class="px-6 py-3 font-medium">Dura√ß√£o</th>
                                <th class="px-6 py-3 font-medium text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="historico-body" class="divide-y divide-gray-100">
                            <tr><td colspan="9" class="text-center py-8 text-gray-400">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="content-relatorio" class="hidden animate-fade-in">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Relat√≥rio Individual</h2>
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Scooteira</label>
                            <select id="relatorio-agente-select" class="w-full p-2.5 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="window.loadRelatorioIndividual()">
                                <option value="" disabled selected>Selecione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">M√™s</label>
                            <input type="month" id="relatorio-mes-select" class="w-full p-2.5 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="window.loadRelatorioIndividual()">
                        </div>
                        <div class="flex items-end space-x-2">
                             <button class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 px-4 rounded-lg font-medium shadow-sm transition flex items-center justify-center" onclick="window.exportIndividualCsv()">
                                 <i data-lucide="file-down" class="w-4 h-4 mr-2"></i> CSV
                             </button>
                        </div>
                    </div>
                </div>
                
                <div id="relatorio-resumo-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 hidden">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                        <span class="text-xs text-gray-500 uppercase font-medium">Dias Trabalhados</span>
                        <span class="text-3xl font-bold text-gray-800 mt-1" id="resumo-total-dias">-</span>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                        <span class="text-xs text-gray-500 uppercase font-medium">Total de Horas</span>
                        <span class="text-3xl font-bold text-indigo-600 mt-1" id="resumo-total-horas">-</span>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col lg:col-span-2">
                        <span class="text-xs text-gray-500 uppercase font-medium mb-3">Total por Squad</span>
                        <div id="resumo-squads-list" class="flex flex-wrap gap-2 content-start"></div>
                    </div>
                </div>

                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-3 font-medium">Data</th>
                                <th class="px-6 py-3 font-medium">Squad</th>
                                <th class="px-6 py-3 font-medium">Entrada</th>
                                <th class="px-6 py-3 font-medium">Sa√≠da</th>
                                <th class="px-6 py-3 font-medium">Dura√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="relatorio-body" class="divide-y divide-gray-100">
                            <tr><td colspan="5" class="text-center py-8 text-gray-400">Selecione os filtros acima.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="content-cadastro" class="hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Equipe Cadastrada</h2>
                    <button onclick="window.seedDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium text-xs flex items-center shadow-sm">
                        <i data-lucide="refresh-cw" class="w-3 h-3 mr-2"></i> For√ßar Atualiza√ß√£o
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-8">
                    <h3 class="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wide border-b pb-2">Adicionar Nova Scooteira</h3>
                    <form id="add-agent-form" class="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Nome Completo</label>
                            <input type="text" id="new-nome" placeholder="Nome Completo" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Pseudo (Apelido)</label>
                            <input type="text" id="new-pseudo" placeholder="Ex: Ana C." class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Squad Padr√£o</label>
                            <select id="new-squad" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm"></select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Dias Padr√£o</label>
                            <input type="text" id="new-turno" placeholder="Ex: Seg-Sex" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Entrada</label>
                            <input type="time" id="new-entrada" value="08:00" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Sa√≠da</label>
                            <input type="time" id="new-saida" value="14:00" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm" required>
                        </div>
                        <div class="md:col-span-6 flex justify-end mt-2">
                            <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-6 rounded-lg font-medium shadow-sm transition text-sm"> + Adicionar </button>
                        </div>
                    </form>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-3 font-medium">Nome (Pseudo)</th>
                                <th class="px-6 py-3 font-medium">Squad</th>
                                <th class="px-6 py-3 font-medium">Dias</th>
                                <th class="px-6 py-3 font-medium">Hor√°rio</th>
                                <th class="px-6 py-3 font-medium text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="cadastro-list-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="bulk-actions-bar" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center space-x-6 z-40 hidden slide-up">
        <span class="text-sm font-medium"><span id="bulk-count">0</span> selecionados</span>
        <div class="h-4 w-px bg-gray-600"></div>
        <button class="flex items-center space-x-2 text-indigo-300 hover:text-white transition" onclick="window.openBulkEditModal()">
            <i data-lucide="pencil" class="w-4 h-4"></i>
            <span class="text-sm font-medium">Editar Selecionados</span>
        </button>
        <button class="flex items-center space-x-2 text-red-400 hover:text-red-200 transition" onclick="window.deleteBulkLogs()">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            <span class="text-sm font-medium">Excluir</span>
        </button>
        <button class="ml-4 text-gray-500 hover:text-gray-300" onclick="window.deselectAll()">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>

    <div id="bulk-edit-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-indigo-600 px-6 py-4 text-white">
                <h3 class="text-lg font-bold">Edi√ß√£o em Massa</h3>
                <p class="text-indigo-100 text-xs mt-1">Preencha APENAS o que deseja alterar.</p>
            </div>
            <div class="p-6 space-y-4">
                <div><label class="block text-xs uppercase text-gray-500 mb-1">Nova Data</label><input type="date" id="be-data" class="w-full p-2 border rounded bg-gray-50"></div>
                <div><label class="block text-xs uppercase text-gray-500 mb-1">Novo Squad</label><select id="be-squad" class="w-full p-2 border rounded bg-gray-50"></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs uppercase text-gray-500 mb-1">Nova Entrada</label><input type="time" id="be-ent" class="w-full p-2 border rounded bg-gray-50"></div>
                    <div><label class="block text-xs uppercase text-gray-500 mb-1">Nova Sa√≠da</label><input type="time" id="be-sai" class="w-full p-2 border rounded bg-gray-50"></div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                <button class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded" onclick="window.closeModal('bulk-edit-modal')">Cancelar</button>
                <button class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700" onclick="window.confirmBulkEdit()">Aplicar Mudan√ßas</button>
            </div>
        </div>
    </div>

    <div id="selection-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden"><div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">Selecionar Scooteiras</h3><button onclick="window.closeModal('selection-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="agentes-checkbox-list" class="p-4 space-y-2 max-h-[60vh] overflow-y-auto"></div><div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end"><button class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg font-medium text-sm" onclick="window.closeModal('selection-modal')">Conclu√≠do</button></div></div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="bg-indigo-600 px-6 py-4 text-white">
                <h3 class="text-lg font-bold">Confirmar Lan√ßamento</h3>
                <p class="text-indigo-100 text-xs mt-1">Verifique os hor√°rios e a squad antes de salvar.</p>
            </div>
            <form id="details-form" class="flex-1 overflow-hidden flex flex-col">
                <div id="agentes-detalhes-container" class="p-6 space-y-6 overflow-y-auto flex-1"></div>
                <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                    <button type="button" class="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition" onclick="window.closeModal('details-modal')">Cancelar</button>
                    <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-sm transition">Confirmar e Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-log-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden"><div class="bg-blue-600 px-6 py-4 text-white flex justify-between"><h3 class="text-lg font-bold">Editar Registro</h3><button onclick="window.closeModal('edit-log-modal')" class="text-blue-100 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6 space-y-4"><input type="hidden" id="edit-log-id"><div><label class="block text-xs uppercase text-gray-500 mb-1">Scooteira</label><input id="edit-log-nome" class="w-full p-2 border bg-gray-100 rounded text-gray-500" disabled></div><div><label class="block text-xs uppercase text-gray-500 mb-1">Data</label><input type="date" id="edit-log-data" class="w-full p-2 border rounded"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs uppercase text-gray-500 mb-1">Entrada</label><input type="time" id="edit-log-ent" class="w-full p-2 border rounded"></div><div><label class="block text-xs uppercase text-gray-500 mb-1">Sa√≠da</label><input type="time" id="edit-log-sai" class="w-full p-2 border rounded"></div></div><div><label class="block text-xs uppercase text-gray-500 mb-1">Squad</label><input type="text" id="edit-log-squad" class="w-full p-2 border rounded"></div></div><div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3"><button class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded" onclick="window.closeModal('edit-log-modal')">Cancelar</button><button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="window.saveEditedLog()">Salvar Altera√ß√µes</button></div></div>
    </div>

    <div id="import-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden"><div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800 flex items-center"><i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2 text-blue-600"></i> Importar do Excel</h3><button onclick="window.closeModal('import-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6"><p class="text-sm text-gray-600 mb-2">Cole os dados copiados diretamente da planilha (com cabe√ßalho ou sem):</p><textarea id="import-data-json" rows="10" class="w-full p-4 border border-gray-300 rounded-lg font-mono text-xs bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Data..."></textarea><p class="text-xs text-gray-400 mt-2">O sistema mapeia automaticamente os Pseudos para os Nomes Cadastrados.</p></div><div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3"><button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-sm transition" onclick="window.handleImport()">Processar Dados</button></div></div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center"><h3 class="text-lg font-bold text-gray-900 mb-2">Confirmar Exclus√£o?</h3><p class="text-sm text-gray-500 mb-6">Essa a√ß√£o n√£o pode ser desfeita.</p><div class="flex justify-center space-x-3"><button class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50" onclick="window.resolveConfirmation(false)">Cancelar</button><button class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700" onclick="window.resolveConfirmation(true)">Sim, Excluir</button></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs, onSnapshot, deleteDoc, updateDoc, addDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgKe2n4c6vL4-B0hSAGT16ELDUQLW0OTQ",
            authDomain: "atuacao2026.firebaseapp.com",
            projectId: "atuacao2026",
            storageBucket: "atuacao2026.firebasestorage.app",
            messagingSenderId: "563632231622",
            appId: "1:563632231622:web:ce3e04e43cc647614214f5"
        };
        const appId = "atuacao2026";
        
        const SQUADS_OPCOES = ["CB", "SC", "Rec. Cr√©dito", "Monitoria", "Coraliados", "Hunter", "Vendas", "OJR", "Outro"];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const logsCol = `artifacts/${appId}/public/data/scooteiras_atividades`;
        const agentsCol = `artifacts/${appId}/public/data/scooteiras_cadastro`;

        let currentAgents = [];
        let currentHistoryList = [];
        
        const getSquadColor = (squad) => {
            const map = { 'CB': 'indigo', 'SC': 'emerald', 'Rec. Cr√©dito': 'amber', 'Monitoria': 'cyan', 'Coraliados': 'rose', 'Hunter': 'orange', 'Vendas': 'teal', 'OJR': 'purple', 'Outro': 'slate' };
            return map[squad] || 'blue';
        };

        const timeToMinutes = (t) => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
        const normalizeTime = (t) => { if(!t) return ""; t = t.trim(); const parts = t.split(':'); if (parts.length >= 2) return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`; return t; };

        // --- TRAVA DE SOBREPOSI√á√ÉO ---
        const verificarSobreposicao = async (scooteira, data, ent, sai, excludeId = null) => {
            const q = query(collection(db, logsCol), where("scooteira", "==", scooteira), where("data", "==", data));
            const snap = await getDocs(q);
            const newStart = timeToMinutes(ent);
            const newEnd = timeToMinutes(sai);
            for (const d of snap.docs) {
                if (excludeId && d.id === excludeId) continue; 
                const existing = d.data();
                const existStart = timeToMinutes(existing.entrada);
                const existEnd = timeToMinutes(existing.saida);
                if (newStart < existEnd && newEnd > existStart) return true;
            }
            return false;
        };

        // Auth & Load
        signInAnonymously(auth).then(() => {
            document.getElementById('auth-status').innerText = "Conectado";
            document.getElementById('auth-status').classList.remove('bg-indigo-800');
            document.getElementById('auth-status').classList.add('bg-emerald-600');
            initSquadSelect();
            loadAgents(); 
            loadHistorico();
        });

        // UI Helpers
        window.switchTab = (tabId) => {
            ['registro', 'relatorio', 'cadastro'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.replace('tab-inactive', 'tab-active');
        };

        const showMessage = (msg, type='info') => {
            const el = document.getElementById('message-box');
            el.innerText = msg;
            el.className = `mx-6 mt-6 p-4 text-sm rounded-lg shadow-sm border-l-4 transition-all block ${type === 'success' ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'bg-red-50 border-red-500 text-red-700'}`;
            setTimeout(() => el.classList.add('hidden'), 4000);
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');

        const initSquadSelect = () => {
             const sel = document.getElementById('new-squad');
             sel.innerHTML = SQUADS_OPCOES.map(s => `<option value="${s}">${s}</option>`).join('');
             const beSel = document.getElementById('be-squad');
             beSel.innerHTML = '<option value="">-- Manter Original --</option>' + SQUADS_OPCOES.map(s => `<option value="${s}">${s}</option>`).join('');
        };

        const loadAgents = async () => {
            const q = query(collection(db, agentsCol));
            const snap = await getDocs(q);
            if (snap.empty) { await seedDatabase(true); return; }
            currentAgents = [];
            snap.forEach(d => currentAgents.push(d.data()));
            renderAgentsTable();
            renderSelectionList();
            renderRelatorioSelect();
        };

        const renderAgentsTable = () => {
            const tbody = document.getElementById('cadastro-list-body');
            tbody.innerHTML = '';
            currentAgents.sort((a,b) => a.nome.localeCompare(b.nome));
            currentAgents.forEach(a => {
                const color = getSquadColor(a.squadPadrao);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 border-l-4 border-${color}-500 font-medium text-gray-900">${a.nome} <span class="text-gray-400 font-normal">(${a.pseudo})</span></td>
                    <td class="px-6 py-4"><span class="bg-${color}-100 text-${color}-800 text-xs px-2 py-1 rounded-full border border-${color}-200">${a.squadPadrao || '-'}</span></td>
                    <td class="px-6 py-4">${a.turnoPadrao || '-'}</td>
                    <td class="px-6 py-4 font-mono text-xs">${a.entradaPadrao} - ${a.saidaPadrao}</td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button class="text-indigo-600 hover:text-indigo-900" onclick="window.editAgent('${a.nome}')"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button class="text-red-400 hover:text-red-700" onclick="window.deleteAgent('${a.nome}')"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>`;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        };

        window.seedDatabase = async (silent) => { 
            if(!silent && !confirm("Reenviar lista padr√£o?")) return;
            if(!silent) showMessage("Feito", "success"); 
            loadAgents(); 
        };
        
        document.getElementById('add-agent-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('new-nome').value.trim();
            await setDoc(doc(db, agentsCol, nome), { nome: nome, pseudo: document.getElementById('new-pseudo').value, squadPadrao: document.getElementById('new-squad').value, turnoPadrao: document.getElementById('new-turno').value, entradaPadrao: document.getElementById('new-entrada').value, saidaPadrao: document.getElementById('new-saida').value });
            showMessage('Salvo!', 'success'); loadAgents();
        });
        
        window.deleteAgent = async(id) => { if(await confirmAction()) { await deleteDoc(doc(db, agentsCol, id)); loadAgents(); }};
        window.editAgent = (nome) => { /* L√≥gica de modal de edi√ß√£o simplificada */ };
        
        window.showSelectionModal = () => { renderSelectionList(); window.openModal('selection-modal'); };
        const renderSelectionList = () => {
             document.getElementById('agentes-checkbox-list').innerHTML = currentAgents.map(a => `<label class="flex items-center space-x-3 p-3 rounded-lg border border-gray-100 hover:bg-indigo-50 cursor-pointer"><input type="checkbox" value="${a.nome}" class="agent-checkbox w-5 h-5 text-indigo-600 rounded"><div><span class="font-medium text-gray-800">${a.nome}</span> <span class="text-xs text-gray-500">(${a.pseudo})</span></div></label>`).join('');
        };
        
        window.handleEntrySubmission = () => {
            const data = document.getElementById('data-atuacao').value;
            const selectedBoxes = document.querySelectorAll('.agent-checkbox:checked');
            if (!data || selectedBoxes.length === 0) { showMessage('Selecione data e scooteira.', 'error'); return; }
            
            const container = document.getElementById('agentes-detalhes-container');
            container.innerHTML = '';
            
            selectedBoxes.forEach(box => {
                const nome = box.value;
                const agent = currentAgents.find(a => a.nome === nome);
                
                if (!agent) return;

                const squadOptions = SQUADS_OPCOES.map(s => 
                    `<option value="${s}" ${s === agent.squadPadrao ? 'selected' : ''}>${s}</option>`
                ).join('');

                container.innerHTML += `
                    <div class="p-4 border rounded-lg bg-gray-50 confirm-row" data-nome="${agent.nome}">
                        <h4 class="font-bold text-indigo-900 mb-2">${agent.nome}</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <div>
                                <label class="text-xs font-semibold text-gray-500">Entrada</label>
                                <input type="time" value="${agent.entradaPadrao}" class="w-full border border-gray-300 rounded p-1.5 text-sm focus:border-indigo-500 confirm-ent">
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-500">Sa√≠da</label>
                                <input type="time" value="${agent.saidaPadrao}" class="w-full border border-gray-300 rounded p-1.5 text-sm focus:border-indigo-500 confirm-sai">
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-500">Squad do Dia</label>
                                <select class="w-full border border-gray-300 rounded p-1.5 text-sm focus:border-indigo-500 bg-white confirm-squad">
                                    ${squadOptions}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-500">Turno</label>
                                <input type="text" value="${agent.turnoPadrao}" class="w-full border border-gray-300 rounded p-1.5 text-sm focus:border-indigo-500 confirm-turno">
                            </div>
                        </div>
                    </div>`;
            });
            window.openModal('details-modal');
        };

        document.getElementById('details-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dataStr = document.getElementById('data-atuacao').value;
            const rows = document.querySelectorAll('.confirm-row');
            
            let conflictFound = false;
            let successCount = 0;

            for (const row of rows) {
                const nome = row.getAttribute('data-nome');
                const ent = row.querySelector('.confirm-ent').value;
                const sai = row.querySelector('.confirm-sai').value;
                const sq = row.querySelector('.confirm-squad').value;
                const trn = row.querySelector('.confirm-turno').value;
                
                if (await verificarSobreposicao(nome, dataStr, ent, sai)) { conflictFound = true; continue; }

                const d1 = new Date(`2000-01-01T${ent}`);
                const d2 = new Date(`2000-01-01T${sai}`);
                let diff = (d2 - d1) / 1000 / 60 / 60; 
                if (diff < 0) diff += 24;
                
                await addDoc(collection(db, logsCol), {
                    data: dataStr,
                    mes: dataStr.substring(0, 7),
                    scooteira: nome,
                    squad: sq,
                    entrada: ent,
                    saida: sai,
                    turno: trn,
                    horas: parseFloat(diff.toFixed(2)),
                    timestamp: new Date()
                });
                successCount++;
            }
            if(conflictFound) showMessage(`${successCount} salvos. Duplicatas ignoradas.`, 'error');
            else showMessage('Registros salvos!', 'success');
            window.closeModal('details-modal');
            window.loadHistorico();
        });

        window.showImportModal = () => window.openModal('import-modal');
        window.handleImport = async () => {
            const text = document.getElementById('import-data-json').value;
            if(!text.trim()) { showMessage('Cole os dados.', 'error'); return; }
            const lines = text.split('\n');
            let successCount = 0; let skippedCount = 0;
            
            for(let line of lines) {
                let cols = line.split('\t');
                if(cols.length < 5) cols = line.split(',');
                if(cols.length >= 8 && !cols[0].includes('Data')) {
                    const dataBr = cols[0].trim();
                    const importedPseudo = cols[2].trim();
                    const ent = normalizeTime(cols[4]);
                    const sai = normalizeTime(cols[5]);
                    const sq = cols[8].trim();
                    const turno = cols[3] || "Importado";

                    if(!dataBr || !importedPseudo) continue;
                    
                    let finalName = importedPseudo;
                    const foundAgent = currentAgents.find(a => a.pseudo.toLowerCase() === importedPseudo.toLowerCase());
                    if (foundAgent) {
                        finalName = foundAgent.nome; 
                    }

                    const parts = dataBr.split('/');
                    const dataIso = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    
                    if (await verificarSobreposicao(finalName, dataIso, ent, sai)) { skippedCount++; continue; }

                    const d1 = new Date(`2000-01-01T${ent}`);
                    const d2 = new Date(`2000-01-01T${sai}`);
                    let diff = (d2 - d1) / 1000 / 60 / 60; 
                    if (diff < 0) diff += 24;

                    await addDoc(collection(db, logsCol), {
                        data: dataIso, mes: dataIso.substring(0, 7),
                        scooteira: finalName, 
                        squad: sq, entrada: ent, saida: sai, turno: turno, horas: parseFloat(diff.toFixed(2))
                    });
                    successCount++;
                }
            }
            showMessage(`${successCount} importados. ${skippedCount} pulados.`, 'success');
            window.closeModal('import-modal');
            window.loadHistorico();
        };

        window.loadHistorico = async () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;
            const tbody = document.getElementById('historico-body');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-400">Carregando...</td></tr>';
            window.deselectAll(); 
            const q = query(collection(db, logsCol), where("mes", "==", mes));
            const snap = await getDocs(q);
            currentHistoryList = []; 
            snap.forEach(d => currentHistoryList.push({id: d.id, ...d.data()}));
            
            // ORDENA√á√ÉO: Mais recente primeiro
            currentHistoryList.sort((a,b) => b.data.localeCompare(a.data));
            
            tbody.innerHTML = currentHistoryList.length ? '' : '<tr><td colspan="9" class="text-center py-8">Nenhum registro.</td></tr>';
            
            currentHistoryList.forEach(item => {
                const color = getSquadColor(item.squad);

                let agent = currentAgents.find(a => a.nome === item.scooteira);
                if (!agent) {
                    agent = currentAgents.find(a => a.pseudo === item.scooteira);
                }
                
                const displayAgent = agent || { nome: item.scooteira, pseudo: '-' };
                const firstName = displayAgent.nome.split(' ')[0]; 
                
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-6 py-4"><input type="checkbox" value="${item.id}" class="history-checkbox w-4 h-4 text-indigo-600 rounded" onclick="window.updateBulkUI()"></td>
                    <td class="px-6 py-4">${item.data.split('-').reverse().join('/')}</td>
                    <td class="px-6 py-4 font-bold text-gray-800">${firstName}</td>
                    <td class="px-6 py-4 text-gray-500 text-xs">${displayAgent.pseudo}</td>
                    <td class="px-6 py-4"><span class="text-${color}-700 bg-${color}-50 border border-${color}-200 px-2 py-1 rounded text-xs font-semibold">${item.squad}</span></td>
                    <td class="px-6 py-4">${item.entrada}</td>
                    <td class="px-6 py-4">${item.saida}</td>
                    <td class="px-6 py-4">${item.horas}h</td>
                    <td class="px-6 py-4 text-right flex justify-end space-x-3">
                        <button class="text-blue-500 hover:text-blue-700" onclick="window.editLog('${item.id}')"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button class="text-red-500 hover:text-red-700" onclick="window.deleteLog('${item.id}')"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>`;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
            updateStats(currentHistoryList);
        };

        window.loadRelatorioIndividual = async () => {
            const nomeSelecionado = document.getElementById('relatorio-agente-select').value;
            const mes = document.getElementById('relatorio-mes-select').value;
            if(!nomeSelecionado || !mes) return;

            const agente = currentAgents.find(a => a.nome === nomeSelecionado);
            const pseudo = agente ? agente.pseudo : "";

            const q = query(collection(db, logsCol), where("mes", "==", mes));
            const snap = await getDocs(q);
            
            const list = [];
            snap.forEach(d => {
                const item = d.data();
                if (item.scooteira === nomeSelecionado || item.scooteira === pseudo) {
                    list.push(item);
                }
            });
            
            list.sort((a,b) => a.data.localeCompare(b.data));
            
            const tbody = document.getElementById('relatorio-body');
            tbody.innerHTML = '';
            let totalH = 0;
            let squadStats = {}; 

            list.forEach(i => {
                totalH += i.horas;
                if(!squadStats[i.squad]) squadStats[i.squad] = 0;
                squadStats[i.squad] += i.horas;
                tbody.innerHTML += `<tr class="border-b"><td class="px-6 py-4">${i.data.split('-').reverse().join('/')}</td><td class="px-6 py-4">${i.squad}</td><td class="px-6 py-4">${i.entrada}</td><td class="px-6 py-4">${i.saida}</td><td class="px-6 py-4">${i.horas}h</td></tr>`;
            });
            
            document.getElementById('relatorio-resumo-cards').classList.remove('hidden');
            document.getElementById('resumo-total-dias').innerText = list.length;
            document.getElementById('resumo-total-horas').innerText = totalH.toFixed(2) + 'h';
            
            const statsContainer = document.getElementById('resumo-squads-list');
            statsContainer.innerHTML = Object.keys(squadStats).map(s => {
                const color = getSquadColor(s);
                return `<span class="px-3 py-1 text-xs font-bold text-${color}-700 bg-${color}-50 border border-${color}-200 rounded-full mb-2 mr-2">${s}: ${squadStats[s].toFixed(1)}h</span>`;
            }).join('');
        };

        const confirmAction = () => new Promise(r => { window.openModal('confirmation-modal'); window.resolveConfirmation = (v) => { window.closeModal('confirmation-modal'); r(v); }});
        window.toggleSelectAll = () => { const m = document.getElementById('select-all-history'); document.querySelectorAll('.history-checkbox').forEach(b => b.checked = m.checked); window.updateBulkUI(); };
        window.updateBulkUI = () => { const c = document.querySelectorAll('.history-checkbox:checked'); const b = document.getElementById('bulk-actions-bar'); document.getElementById('bulk-count').innerText = c.length; if(c.length > 0) b.classList.remove('hidden'); else b.classList.add('hidden'); };
        window.deselectAll = () => { document.getElementById('select-all-history').checked = false; document.querySelectorAll('.history-checkbox').forEach(b => b.checked = false); window.updateBulkUI(); };
        window.openBulkEditModal = () => { document.getElementById('be-data').value = ""; document.getElementById('be-squad').value = ""; document.getElementById('be-ent').value = ""; document.getElementById('be-sai').value = ""; window.openModal('bulk-edit-modal'); };
        window.confirmBulkEdit = async () => { 
            const checked = document.querySelectorAll('.history-checkbox:checked');
            const ids = Array.from(checked).map(c => c.value);
            if(ids.length === 0) return;
            const newData = document.getElementById('be-data').value;
            const newSquad = document.getElementById('be-squad').value;
            const newEnt = document.getElementById('be-ent').value;
            const newSai = document.getElementById('be-sai').value;
            window.closeModal('bulk-edit-modal');
            showMessage(`Atualizando ${ids.length}...`, 'info');

            for(const id of ids) {
                const original = currentHistoryList.find(i => i.id === id);
                if(!original) continue;
                const ent = newEnt || original.entrada;
                const sai = newSai || original.saida;
                const dataStr = newData || original.data;
                const mes = dataStr.substring(0, 7);
                if ((newData || newEnt || newSai) && await verificarSobreposicao(original.scooteira, dataStr, ent, sai, id)) continue;
                const d1 = new Date(`2000-01-01T${ent}`);
                const d2 = new Date(`2000-01-01T${sai}`);
                let diff = (d2 - d1) / 1000 / 60 / 60; if (diff < 0) diff += 24;
                const updatePayload = { entrada: ent, saida: sai, horas: parseFloat(diff.toFixed(2)), data: dataStr, mes: mes };
                if(newSquad) updatePayload.squad = newSquad;
                await updateDoc(doc(db, logsCol, id), updatePayload);
            }
            showMessage(`Conclu√≠do!`, 'success');
            window.loadHistorico();
        }; 
        window.deleteBulkLogs = async () => { 
            const checked = document.querySelectorAll('.history-checkbox:checked');
            if(checked.length === 0) return;
            if(confirm(`Excluir ${checked.length} registros?`)) {
                for(const box of checked) await deleteDoc(doc(db, logsCol, box.value));
                showMessage("Exclu√≠dos.", "success");
                window.loadHistorico();
            }
        };
        window.editLog = (id) => { const i = currentHistoryList.find(x => x.id === id); document.getElementById('edit-log-id').value = id; document.getElementById('edit-log-nome').value = i.scooteira; document.getElementById('edit-log-data').value = i.data; document.getElementById('edit-log-ent').value = i.entrada; document.getElementById('edit-log-sai').value = i.saida; document.getElementById('edit-log-squad').value = i.squad; window.openModal('edit-log-modal'); };
        window.saveEditedLog = async () => { 
            const id = document.getElementById('edit-log-id').value;
            const ent = document.getElementById('edit-log-ent').value;
            const sai = document.getElementById('edit-log-sai').value;
            const dataStr = document.getElementById('edit-log-data').value;
            const nome = document.getElementById('edit-log-nome').value;
            const sq = document.getElementById('edit-log-squad').value;

            if(await verificarSobreposicao(nome, dataStr, ent, sai, id)) { alert("Conflito de hor√°rio!"); return; }

            const d1 = new Date(`2000-01-01T${ent}`);
            const d2 = new Date(`2000-01-01T${sai}`);
            let diff = (d2 - d1) / 1000 / 60 / 60; if (diff < 0) diff += 24;

            await updateDoc(doc(db, logsCol, id), { data: dataStr, mes: dataStr.substring(0, 7), entrada: ent, saida: sai, squad: sq, horas: parseFloat(diff.toFixed(2)) });
            window.closeModal('edit-log-modal'); window.loadHistorico(); 
        };
        window.deleteLog = async (id) => { if(await confirmAction()) { await deleteDoc(doc(db, logsCol, id)); loadHistorico(); }};
        window.exportToCsv = async () => { 
                const mes = document.getElementById('mes-select').value;
                if (!mes) return;
                const q = query(collection(db, logsCol), where("mes", "==", mes));
                const snap = await getDocs(q);
                let csv = "data:text/csv;charset=utf-8,Data,Scooteira,Squad,Entrada,Saida,Horas\n";
                snap.forEach(d => { const i = d.data(); csv += `${i.data},${i.scooteira},${i.squad},${i.entrada},${i.saida},${i.horas}\n`; });
                const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `atuacao_${mes}.csv`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        const updateStats = (list) => {
            const squads = {};
            list.forEach(i => { if(!squads[i.squad]) squads[i.squad] = 0; squads[i.squad] += i.horas; });
            document.getElementById('resumo-squads').innerHTML = Object.keys(squads).map(s => { const color = getSquadColor(s); return `<div class="bg-white p-4 rounded-lg border-l-4 border-${color}-500 shadow-sm flex justify-between items-center"><div><span class="text-xs font-bold text-${color}-600 uppercase tracking-wider">${s}</span><p class="text-2xl font-bold text-gray-700">${squads[s].toFixed(1)}h</p></div></div>`; }).join('');
        };
        const renderRelatorioSelect = () => { document.getElementById('relatorio-agente-select').innerHTML = '<option value="" disabled selected>Selecione...</option>' + currentAgents.map(a => `<option value="${a.nome}">${a.nome}</option>`).join(''); };
        
        window.exportIndividualCsv = async () => { 
             const nomeSelecionado = document.getElementById('relatorio-agente-select').value;
             const mes = document.getElementById('relatorio-mes-select').value;
             if(!nomeSelecionado || !mes) { showMessage("Selecione scooteira e m√™s.", "error"); return; }
             
             const agente = currentAgents.find(a => a.nome === nomeSelecionado);
             const pseudo = agente ? agente.pseudo : "";
             
             const q = query(collection(db, logsCol), where("mes", "==", mes));
             const snap = await getDocs(q);
             let csv = `data:text/csv;charset=utf-8,Data,Scooteira,Squad,Entrada,Saida,Horas\n`;
             
             snap.forEach(d => { 
                 const i = d.data();
                 if (i.scooteira === nomeSelecionado || i.scooteira === pseudo) {
                    csv += `${i.data},${i.scooteira},${i.squad},${i.entrada},${i.saida},${i.horas}\n`; 
                 }
             });
             const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `relatorio_${nomeSelecionado}_${mes}.csv`;
             document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        window.onload = () => {
            const d = new Date();
            const m = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('mes-select').value = m;
            document.getElementById('relatorio-mes-select').value = m;
        };
    </script>
</body>
</html>
