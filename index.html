<!DOCTYPE html>
<html lang="pt-BR">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <!-- NOME UNIFICADO NA ABA -->
ย ย <title>Dash Atuaรงรฃo - Scooto</title>
ย ยย
ย ย <!-- Favicon de Scooter -->
ย ย <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>๐ต</text></svg>">

ย ย <!-- Tailwind CSS CDN -->
ย ย <script src="https://cdn.tailwindcss.com"></script>
ย ย <!-- FONTE ALTERADA PARA MONTSERRAT -->
ย ย <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
ย ย <!-- Icones Lucide -->
ย ย <script src="https://unpkg.com/lucide@latest"></script>
ย ย <!-- Marked para Markdown da IA -->
ย ย <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
ย ย <style>
ย ย ย ย /* FONTE APLICADA AQUI */
ย ย ย ย body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; color: #334155; }
ย ย ย ย .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; }
ย ย ย ย ::-webkit-scrollbar { width: 8px; height: 8px; }
ย ย ย ย ::-webkit-scrollbar-track { background: #f1f5f9; }
ย ย ย ย ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
ย ย ย ย ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
ย ย ย ย .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; background-color: #eef2ff; }
ย ย ย ย .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
ย ย ย ย .tab-inactive:hover { color: #334155; border-bottom: 2px solid #cbd5e1; }
ย ย ย ย .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
ย ย ย ย @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
ย ย ย ย .prose h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
ย ย ย ย .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
ย ย ย ย .prose p { margin-bottom: 0.8em; line-height: 1.5; }
ย ย ย ย .prose strong { color: #4f46e5; }
ย ย </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">

ย ย <div id="app" class="w-full max-w-6xl bg-white rounded-2xl shadow-xl overflow-hidden">
ย ย ย ยย
ย ย ย ย <!-- Header Moderno -->
ย ย ย ย <header class="bg-indigo-600 p-6 sm:p-10 text-white">
ย ย ย ย ย ย <div class="flex justify-between items-center">
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <!-- NOME UNIFICADO NO CABEรALHO -->
ย ย ย ย ย ย ย ย ย ย <h1 class="text-3xl font-bold tracking-tight">Dash Atuaรงรฃo - Scooto</h1>
ย ย ย ย ย ย ย ย ย ย <p class="text-indigo-100 text-sm mt-1">Controle de Squads e Scooteiras</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="hidden md:block text-right">
ย ย ย ย ย ย ย ย ย ย <p id="auth-status" class="text-xs text-indigo-200 font-mono bg-indigo-800 py-1 px-2 rounded">Conectando...</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </header>
ย ย ย ยย
ย ย ย ย <!-- Navegaรงรฃo (Tabs) -->
ย ย ย ย <div class="flex border-b border-gray-200 bg-gray-50 px-6 overflow-x-auto">
ย ย ย ย ย ย <button id="tab-registro" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-active whitespace-nowrap" onclick="switchTab('registro')">
ย ย ย ย ย ย ย ย <span class="flex items-center"><i data-lucide="calendar-check" class="w-4 h-4 mr-2"></i> Registro Diรกrio</span>
ย ย ย ย ย ย </button>
ย ย ย ย ย ย <button id="tab-relatorio" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-inactive whitespace-nowrap" onclick="switchTab('relatorio')">
ย ย ย ย ย ย ย ย <span class="flex items-center"><i data-lucide="bar-chart-3" class="w-4 h-4 mr-2"></i> Relatรณrios</span>
ย ย ย ย ย ย </button>
ย ย ย ย ย ย <button id="tab-cadastro" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-inactive whitespace-nowrap" onclick="switchTab('cadastro')">
ย ย ย ย ย ย ย ย <span class="flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i> Equipe</span>
ย ย ย ย ย ย </button>
ย ย ย ย </div>
ย ย ย ยย
ย ย ย ย <!-- รrea de Mensagens -->
ย ย ย ย <div id="message-box" class="hidden mx-6 mt-6 p-4 text-sm rounded-lg shadow-sm border-l-4 transition-all" role="alert"></div>

ย ย ย ย <div class="p-6 sm:p-8 min-h-[500px]">
ย ย ย ย ย ยย
ย ย ย ย ย ย <!-- CONTEรDO DA ABA 1: Registro Diรกrio e Histรณrico -->
ย ย ย ย ย ย <div id="content-registro" class="animate-fade-in">
ย ย ย ย ย ย ย ย <!-- Card de Registro -->
ย ย ย ย ย ย ย ย <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6 mb-8 shadow-sm">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-lg font-semibold text-indigo-900 mb-4 flex items-center">
ย ย ย ย ย ย ย ย ย ย ย ย <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Novo Lanรงamento
ย ย ย ย ย ย ย ย ย ย </h2>
ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="md:col-span-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs font-medium text-gray-600 mb-1 uppercase tracking-wide">Data</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="date" id="data-atuacao" class="w-full p-2.5 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="md:col-span-6">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs font-medium text-gray-600 mb-1 uppercase tracking-wide">Scooteira(s)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="hidden" id="selected-agents-input">ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button type="button" id="agentes-selection-display" onclick="showSelectionModal()"ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-left text-gray-500 hover:border-indigo-400 transition shadow-sm flex items-center justify-between text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span>Clique para selecionar...</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <i data-lucide="chevron-down" class="w-4 h-4"></i>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="md:col-span-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="btn-registrar" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 px-4 rounded-lg font-medium shadow-md transition flex items-center justify-center" onclick="handleEntrySubmission()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span>Registrar</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="loading-spinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <!-- Seรงรฃo de Histรณrico -->
ย ย ย ย ย ย ย ย <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-4 gap-4">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-xl font-semibold text-gray-800">Histรณrico Mensal</h2>
ย ย ย ย ย ย ย ย ย ย <div class="flex items-center space-x-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
ย ย ย ย ย ย ย ย ย ย ย ย <label for="mes-select" class="text-sm font-medium text-gray-600">Mรชs:</label>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="month" id="mes-select" class="bg-white border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500 py-1" onchange="loadHistorico()">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="h-4 w-px bg-gray-300 mx-2"></div>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="text-gray-600 hover:text-indigo-600 text-sm font-medium flex items-center transition" onclick="exportToCsv()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<i data-lucide="download" class="w-4 h-4 mr-1"></i> CSV
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย <button class="text-gray-600 hover:text-blue-600 text-sm font-medium flex items-center transition ml-3" onclick="showImportModal()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<i data-lucide="upload" class="w-4 h-4 mr-1"></i> Importar
ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div class="flex justify-end mb-4">
ย ย ย ย ย ย ย ย ย ย ย <button onclick="analyzeMonthlyData()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition flex items-center">
ย ย ย ย ย ย ย ย ย ย ย ย <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i> Analisar Mรชs com IA
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div id="resumo-squads" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>

ย ย ย ย ย ย ย ย <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
ย ย ย ย ย ย ย ย ย ย <table class="w-full text-sm text-left text-gray-600">
ย ย ย ย ย ย ย ย ย ย ย ย <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Data</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Scooteira</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Squad</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Entrada</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Saรญda</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Duraรงรฃo</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Turno</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium text-right">Aรงรตes</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody id="historico-body" class="divide-y divide-gray-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr><td colspan="8" class="text-center py-8 text-gray-400">Carregando dados...</td></tr>
ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <!-- CONTEรDO DA ABA 2: Relatรณrio Individual -->
ย ย ย ย ย ย <div id="content-relatorio" class="hidden animate-fade-in">
ย ย ย ย ย ย ย ย <h2 class="text-xl font-bold text-gray-800 mb-6">Relatรณrio Individual</h2>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Scooteira</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="relatorio-agente-select" class="w-full p-2.5 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="loadRelatorioIndividual()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="" disabled selected>Selecione...</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Mรชs</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="month" id="relatorio-mes-select" class="w-full p-2.5 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="loadRelatorioIndividual()">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-end space-x-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<button class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 px-4 rounded-lg font-medium shadow-sm transition flex items-center justify-center" onclick="exportIndividualCsv()">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<i data-lucide="file-down" class="w-4 h-4 mr-2"></i> CSV
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<button onclick="analyzeIndividualData()" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white py-2.5 px-4 rounded-lg font-medium shadow-sm transition flex items-center justify-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i> Insights
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div id="relatorio-resumo-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 hidden">
ย ย ย ย ย ย ย ย ย ย <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-xs text-gray-500 uppercase font-medium">Dias Trabalhados</span>
ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-3xl font-bold text-gray-800 mt-1" id="resumo-total-dias">-</span>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-xs text-gray-500 uppercase font-medium">Total de Horas</span>
ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-3xl font-bold text-gray-800 mt-1" id="resumo-total-horas">-</span>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-xs text-gray-500 uppercase font-medium">Squad Principal</span>
ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-xl font-bold text-indigo-600 mt-auto" id="resumo-squad-princ">-</span>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
ย ย ย ย ย ย ย ย ย ย <table class="w-full text-sm text-left text-gray-600">
ย ย ย ย ย ย ย ย ย ย ย ย <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Data</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Dia</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Squad</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Entrada</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Saรญda</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Duraรงรฃo</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Turno</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody id="relatorio-body" class="divide-y divide-gray-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr><td colspan="7" class="text-center py-8 text-gray-400">Selecione os filtros acima.</td></tr>
ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <!-- CONTEรDO DA ABA 3: Gestรฃo de Cadastros -->
ย ย ย ย ย ย <div id="content-cadastro" class="hidden animate-fade-in">
ย ย ย ย ย ย ย ย <div class="flex justify-between items-center mb-6">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-xl font-bold text-gray-800">Equipe Cadastrada</h2>
ย ย ย ย ย ย ย ย ย ย <button onclick="forceResetDefaults()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 py-2 px-4 rounded border border-gray-300 flex items-center transition">
ย ย ย ย ย ย ย ย ย ย ย ย <i data-lucide="refresh-cw" class="w-3 h-3 mr-2"></i> Restaurar Padrรตes
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-8">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wide border-b pb-2">Adicionar Nova Agente</h3>
ย ย ย ย ย ย ย ย ย ย <form id="add-agent-form" class="grid grid-cols-1 md:grid-cols-6 gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="md:col-span-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs font-medium text-gray-500 mb-1">Nome Completo</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="new-nome" placeholder="Nome da Scooteira" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" required>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs font-medium text-gray-500 mb-1">Pseudo</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="new-pseudo" placeholder="Ex: Diana C." class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" required>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs font-medium text-gray-500 mb-1">Squad Padrรฃo</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="new-squad" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="CB">CB</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="SC">SC</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Rec Cred">Rec Cred</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="Monitoria">Monitoria</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="OJR">OJR</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="md:col-span-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs font-medium text-gray-500 mb-1">Dias Padrรฃo</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="new-turno" placeholder="Ex: Seg. ร Sex." class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" required>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs font-medium text-gray-500 mb-1">Entrada</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="time" id="new-entrada" value="08:00" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" required>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-xs font-medium text-gray-500 mb-1">Saรญda</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="time" id="new-saida" value="14:00" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm" required>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="md:col-span-6 flex justify-end mt-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-6 rounded-lg font-medium shadow-sm transition text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย+ Adicionar
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </form>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
ย ย ย ย ย ย ย ย ย ย <table class="w-full text-sm text-left text-gray-600">
ย ย ย ย ย ย ย ย ย ย ย ย <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Nome (Pseudo)</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Squad</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Dias</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium">Horรกrio</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="px-6 py-3 font-medium text-right">Aรงรตes</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody id="cadastro-list-body" class="divide-y divide-gray-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr><td colspan="5" class="text-center py-8 text-gray-400">Carregando equipe...</td></tr>
ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย </div>
ย ย </div>

ย ย <!-- MODAIS -->
ย ย <!-- Modal Seleรงรฃo, Detalhes, Importaรงรฃo, Anรกlise e Confirmaรงรฃo... (Mantidos) -->
ย ยย
ย ย <div id="selection-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity">
ย ย ย ย <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
ย ย ย ย ย ย <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
ย ย ย ย ย ย ย ย <h3 class="text-lg font-bold text-gray-800">Selecionar Scooteiras</h3>
ย ย ย ย ย ย ย ย <button onclick="closeModal('selection-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div id="agentes-checkbox-list" class="p-4 space-y-2 max-h-[60vh] overflow-y-auto"></div>
ย ย ย ย ย ย <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end">
ย ย ย ย ย ย ย ย <button class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg font-medium text-sm" onclick="closeModal('selection-modal')">Concluรญdo</button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="details-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
ย ย ย ย <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col">
ย ย ย ย ย ย <div class="bg-indigo-600 px-6 py-4 text-white">
ย ย ย ย ย ย ย ย <h3 class="text-lg font-bold" id="details-modal-title">Ajuste de Detalhes</h3>
ย ย ย ย ย ย ย ย <p class="text-indigo-100 text-xs mt-1" id="modal-instructions"></p>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <form id="details-form" class="flex-1 overflow-hidden flex flex-col">
ย ย ย ย ย ย ย ย <input type="hidden" id="recordIdToEdit" value="">ย
ย ย ย ย ย ย ย ย <div id="agentes-detalhes-container" class="p-6 space-y-6 overflow-y-auto flex-1"></div>
ย ย ย ย ย ย ย ย <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
ย ย ย ย ย ย ย ย ย ย <button type="button" class="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition" onclick="closeModal('details-modal')">Cancelar</button>
ย ย ย ย ย ย ย ย ย ย <button type="submit" id="btn-modal-submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-sm transition">Confirmar</button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </form>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="import-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
ย ย ย ย <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden">
ย ย ย ย ย ย <div class="px-6 py-4 border-b border-gray-100">
ย ย ย ย ย ย ย ย <h3 class="text-lg font-bold text-gray-800 flex items-center"><i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2 text-blue-600"></i> Importar Histรณrico</h3>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="p-6">
ย ย ย ย ย ย ย ย <p class="text-sm text-gray-600 mb-4">
ย ย ย ย ย ย ย ย ย ย Cole os dados (Excel/CSV) <strong>OU</strong> um texto simples (E-mail/Whatsapp).
ย ย ย ย ย ย ย ย ย ย <br><span class="text-xs text-gray-400">Use "Importar com IA โจ" para textos desorganizados.</span>
ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย <textarea id="import-data-json" rows="10" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 font-mono text-xs bg-gray-50" placeholder="Exemplo CSV:
Scooteira	Data	Entrada	Saรญda	Squad
Maria	15/11/2025	08:00	14:00	CB

Exemplo Texto (Use IA โจ):
'A Maria trabalhou ontem das 8h รs 14h no squad CB e a Joana fez das 10 รs 16h.'"></textarea>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
ย ย ย ย ย ย ย ย <button type="button" class="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition" onclick="closeModal('import-modal')">Cancelar</button>
ย ย ย ย ย ย ย ย <div class="relative group">
ย ย ย ย ย ย ย ย ย ย <div class="absolute -inset-0.5 bg-gradient-to-r from-pink-600 to-purple-600 rounded-lg blur opacity-40 group-hover:opacity-100 transition duration-200"></div>
ย ย ย ย ย ย ย ย ย ย <button class="relative bg-white hover:bg-gray-50 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium border border-gray-200 shadow-sm flex items-center" onclick="handleSmartImport()">
ย ย ย ย ย ย ย ย ย ย ย ย <i data-lucide="sparkles" class="w-4 h-4 mr-2 text-purple-600"></i> Importar com IA
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-sm transition" onclick="handleImport()">Importar CSV</button>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div id="ai-loading-overlay" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center flex-col z-10">
ย ย ย ย ย ย ย ย <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600 mb-3"></div>
ย ย ย ย ย ย ย ย <p class="text-purple-800 font-medium text-sm animate-pulse">A Inteligรชncia Artificial estรก a ler os seus dados...</p>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="ai-analysis-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
ย ย ย ย <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[80vh] flex flex-col">
ย ย ย ย ย ย <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 text-white flex justify-between items-center">
ย ย ย ย ย ย ย ย <h3 class="text-lg font-bold flex items-center"><i data-lucide="bot" class="w-5 h-5 mr-2"></i> Anรกlise Inteligente</h3>
ย ย ย ย ย ย ย ย <button onclick="closeModal('ai-analysis-modal')" class="text-purple-100 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="p-8 overflow-y-auto flex-1 prose prose-sm max-w-none text-gray-700 leading-relaxed" id="ai-analysis-content"></div>
ย ย ย ย ย ย <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end">
ย ย ย ย ย ย ย ย <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium" onclick="closeModal('ai-analysis-modal')">Fechar</button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="confirmation-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
ย ย ย ย <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
ย ย ย ย ย ย <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
ย ย ย ย ย ย ย ย <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <h3 class="text-lg font-bold text-gray-900 mb-2" id="confirm-title">Confirmar</h3>
ย ย ย ย ย ย <p class="text-sm text-gray-500 mb-6" id="confirm-message">Tem certeza?</p>
ย ย ย ย ย ย <div class="flex justify-center space-x-3">
ย ย ย ย ย ย ย ย <button class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition" onclick="window.resolveConfirmation(false)">Cancelar</button>
ย ย ย ย ย ย ย ย <button id="confirm-yes-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition shadow-sm" onclick="window.resolveConfirmation(true)">Sim, Confirmar</button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="edit-agent-modal-container"></div>

ย ย <script type="module">
ย ย ย ย import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
ย ย ย ย import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
ย ย ย ย import { getFirestore, doc, setDoc, collection, query, where, getDocs, onSnapshot, runTransaction, deleteDoc, setLogLevel, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

ย ย ย ย // =========================================================================================
ย ย ย ย // CONFIGURAรรO PARA GITHUB PAGES - PREENCHA AQUI!
ย ย ย ย // =========================================================================================
ย ย ย ยย
ย ย ย ย // 1. Obtenha estes dados no Console do Firebase (Configuraรงรตes do Projeto > Geral > Seus aplicativos)
ย ย ย ย const firebaseConfig = {
ย ย ย ย ย ย apiKey: "AIzaSyBgKe2n4c6vL4-B0hSAGT16ELDUQLW0OTQ",
ย authDomain: "atuacao2026.firebaseapp.com",
ย projectId: "atuacao2026",
ย storageBucket: "atuacao2026.firebasestorage.app",
ย messagingSenderId: "862692587738",
ย appId: "1:862692587738:web:f8cbedfd0951a4632b8de3",
ย measurementId: "G-GYBGDY5L14"
ย ย ย ย };
ย ย ย ย // 2. Chave de API do Gemini (Google AI Studio)
ย ย ย ย // IMPORTANTE: Em um site pรบblico (GitHub Pages), esta chave ficarรก visรญvel.
ย ย ย ย // Restrinja o uso desta chave apenas para o domรญnio do seu GitHub Pages no console da Google Cloud.
ย ย ย ย const geminiApiKey = "AIzaSyDoGeOheMsmmsEQiirykFHI_Y3XMhcSoFA";ย
ย ย ย ย // 3. ID รบnico para o armazenamento de dados. Pode ser o nome do seu projeto.
ย ย ย ย const appId = "scooto-gestao-v1";ย

ย ย ย ย // =========================================================================================

ย ย ย ย let db, auth, userId = null;
ย ย ย ย let scooteirasCadastro = [], allRegistros = [], selectedAgentsNames = [];
ย ย ย ย let isAuthReady = false;
ย ย ย ย let agentesByPseudo = {};
ย ย ย ยย
ย ย ย ย const SQUADS_OPCOES = ["CB", "SC", "Rec Cred", "Monitoria", "OJR"];
ย ย ย ย const TURNOS_OPCOES = ["Diรกria Extra", "Troca", "Freela", "Monitora", "Meu Turno"];
ย ย ย ยย
ย ย ย ย const MOCK_CADASTROS = [
ย ย ย ย ย ย { nome: "Jรฉssica Zanquettin", pseudo: "Celina Z", squadPadrao: "CB", turnoPadrao: "Seg. ร Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Juliana da Silva Sfair", pseudo: "Lรณri S", squadPadrao: "CB", turnoPadrao: "Seg. ร Sex.", entradaPadrao: "10:00", saidaPadrao: "16:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Raylla Caroline Fernandes Santos", pseudo: "Teresa S.", squadPadrao: "CB", turnoPadrao: "Seg. ร Sex.", entradaPadrao: "10:00", saidaPadrao: "16:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Barbara Santos De Souza Moreira", pseudo: "Nara M", squadPadrao: "CB", turnoPadrao: "Seg. ร Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Viviane Santiago de Oliveira", pseudo: "Menna S.", squadPadrao: "CB", turnoPadrao: "Seg ร Qui. e Dom.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Janaina Gonzaga Fioravante", pseudo: "Solar F.", squadPadrao: "CB", turnoPadrao: "Quin. ร Sรกb.", entradaPadrao: "16:00", saidaPadrao: "22:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Gizele Uglar Leite Lima", pseudo: "Mari U", squadPadrao: "SC", turnoPadrao: "Seg. ร Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Gleiciรฉle Nogueira", pseudo: "Mariana N.", squadPadrao: "SC", turnoPadrao: "Seg. ร Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Lindisen Guiomar Lemos dos Santos", pseudo: "Ruama S.", squadPadrao: "SC", turnoPadrao: "Dom. ร Quar.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Maria Eduarda Ferreira Gusmรฃo", pseudo: "Ruth G.", squadPadrao: "SC", turnoPadrao: "Seg. ร Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Thaรญs Hayelen", pseudo: "Raquel H.", squadPadrao: "SC", turnoPadrao: "Seg. ร Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Rafaela Lins da Costa", pseudo: "Leila C.", squadPadrao: "SC", turnoPadrao: "FDS", entradaPadrao: "10:00", saidaPadrao: "16:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Ana Claudia Ferreira de Souza", pseudo: "Ravena F.", squadPadrao: "SC", turnoPadrao: "Ter. ร Sรกb.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Crislaine Gomes da Silva", pseudo: "Izabel G.", squadPadrao: "SC", turnoPadrao: "Dom. ร Quar.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Ilanna Rodrigues Nascimento", pseudo: "Noelle R.", squadPadrao: "SC", turnoPadrao: "Seg. ร Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Isabelle Cristine Marques", pseudo: "รsis M.", squadPadrao: "SC", turnoPadrao: "Seg. ร Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Lidia Lorraine Silva Cruz", pseudo: "Alba C.", squadPadrao: "SC", turnoPadrao: "Quin. ร Sรกb.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Thainรก Jaqueline Batista Ferreira", pseudo: "Cรญntia B", squadPadrao: "SC", turnoPadrao: "Seg. ร Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Elice Pisciotta", pseudo: "Yarin P.", squadPadrao: "Monitoria", turnoPadrao: "Semanal", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 },
ย ย ย ย ย ย { nome: "Dรฉbora da Silva Lima de Jesus", pseudo: "Serena L", squadPadrao: "Monitoria", turnoPadrao: "Semanal", entradaPadrao: "08:00", saidaPadrao: "14:00", cargaPadrao: 6 }
ย ย ย ย ];

ย ย ย ย // === Gemini API Helper ===
ย ย ย ย async function callGemini(prompt) {
ย ย ย ย ย ย // Verifica se a chave foi configurada
ย ย ย ย ย ย if (!geminiApiKey || geminiApiKey.includes("COLE_SUA")) {
ย ย ย ย ย ย ย ย throw new Error("Chave da API Gemini nรฃo configurada no cรณdigo.");
ย ย ย ย ย ย }

ย ย ย ย ย ย const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`;
ย ย ย ย ย ย const delays = [1000, 2000, 4000];
ย ย ย ย ย ยย
ย ย ย ย ย ย for (let i = 0; i <= delays.length; i++) {
ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย const response = await fetch(url, {
ย ย ย ย ย ย ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย ย ย ย ย ย ย body: JSON.stringify({
ย ย ย ย ย ย ย ย ย ย ย ย ย ย contents: [{ parts: [{ text: prompt }] }]
ย ย ย ย ย ย ย ย ย ย ย ย })
ย ย ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย ย ย if (!response.ok) {
ย ย ย ย ย ย ย ย ย ย ย ย const errText = await response.text();
ย ย ย ย ย ย ย ย ย ย ย ย if (response.status === 400 || response.status === 403) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย throw new Error(`Erro de Permissรฃo/Requisiรงรฃo (${response.status}): Verifique sua API Key.`);
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย throw new Error(`Erro Gemini (${response.status}): ${errText}`);
ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย const data = await response.json();
ย ย ย ย ย ย ย ย ย ย return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sem resposta.";
ย ย ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย ย ย if (i === delays.length) throw error;
ย ย ย ย ย ย ย ย ย ย await new Promise(r => setTimeout(r, delays[i]));
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // === AI Features, UI Logic, CSV Export, etc. ===
ย ย ย ย // (Mantรฉm a lรณgica original, apenas referenciando as novas variรกveis)

ย ย ย ย window.handleSmartImport = async () => {
ย ย ย ย ย ย const text = document.getElementById('import-data-json').value.trim();
ย ย ย ย ย ย if (!text) return showMessage("Por favor, cole algum texto para importar.", 'warning');
ย ย ย ย ย ย document.getElementById('ai-loading-overlay').classList.remove('hidden');

ย ย ย ย ย ย const prompt = `
ย ย ย ย ย ย ย ย Vocรช รฉ um assistente de extraรงรฃo de dados de RH.
ย ย ย ย ย ย ย ย Extraia os dados de turnos do seguinte texto (que pode ser informal, email, whatsapp, etc).
ย ย ย ย ย ย ย ย O contexto รฉ: Ano atual 2025.
ย ย ย ย ย ย ย ย Texto: "${text}"
ย ย ย ย ย ย ย ย Retorne APENAS um JSON vรกlido (array de objetos com nome, data DD/MM/YYYY, entrada HH:MM, saida HH:MM, squadReal).
ย ย ย ย ย ย `;

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const result = await callGemini(prompt);
ย ย ย ย ย ย ย ย const cleanResult = result.replace(/```json/g, '').replace(/```/g, '').trim();
ย ย ย ย ย ย ย ย const parsedData = JSON.parse(cleanResult);
ย ย ย ย ย ย ย ย if (!Array.isArray(parsedData) || parsedData.length === 0) throw new Error("Dados nรฃo identificados.");
ย ย ย ย ย ย ย ย await processImportedData(parsedData);
ย ย ย ย ย ย ย ย document.getElementById('import-data-json').value = '';
ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย console.error(error);
ย ย ย ย ย ย ย ย showMessage("Erro na IA: " + error.message, 'error');
ย ย ย ย ย ย } finally {
ย ย ย ย ย ย ย ย document.getElementById('ai-loading-overlay').classList.add('hidden');
ย ย ย ย ย ย }
ย ย ย ย };

ย ย ย ย window.analyzeMonthlyData = async () => {
ย ย ย ย ย ย const val = document.getElementById('mes-select').value;
ย ย ย ย ย ย if(!val) return showMessage("Selecione um mรชs primeiro.", 'warning');
ย ย ย ย ย ยย
ย ย ย ย ย ย const [y, m] = val.split('-').map(Number);
ย ย ย ย ย ย const filtered = allRegistros.filter(r => {
ย ย ย ย ย ย ย ย const d = parseDate(r.data);
ย ย ย ย ย ย ย ย return d && d.getFullYear() === y && d.getMonth() === (m-1);
ย ย ย ย ย ย });

ย ย ย ย ย ย if(filtered.length === 0) return showMessage("Sem dados para analisar neste mรชs.", 'warning');

ย ย ย ย ย ย const modalContent = document.getElementById('ai-analysis-content');
ย ย ย ย ย ย modalContent.innerHTML = '<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>';
ย ย ย ย ย ย openModal('ai-analysis-modal');

ย ย ย ย ย ย const summaryData = filtered.map(r => `${r.nome} (${r.squadReal}): ${r.data} ${r.entrada}-${r.saida}`).join('\n');
ย ย ย ย ย ย const prompt = `Analise estes dados de turnos (Scooto) para o mรชs ${val}. Dados: ${summaryData}. Forneรงa um relatรณrio executivo em Markdown com Resumo, Distribuiรงรฃo por Squad e Alertas.`;

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const analysis = await callGemini(prompt);
ย ย ย ย ย ย ย ย modalContent.innerHTML = marked.parse(analysis);
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย modalContent.textContent = "Erro ao gerar anรกlise: " + e.message;
ย ย ย ย ย ย }
ย ย ย ย };

ย ย ย ย window.analyzeIndividualData = async () => {
ย ย ย ย ย ย const nome = document.getElementById('relatorio-agente-select').value;
ย ย ย ย ย ย const mes = document.getElementById('relatorio-mes-select').value;
ย ย ย ย ย ย if(!nome || !mes) return showMessage("Selecione scooteira e mรชs.", 'warning');

ย ย ย ย ย ย const [y, m] = mes.split('-').map(Number);
ย ย ย ย ย ย const filtered = allRegistros.filter(r => r.nome === nome && parseDate(r.data).getMonth() === (m-1));

ย ย ย ย ย ย if(filtered.length === 0) return showMessage("Sem dados para esta scooteira.", 'warning');

ย ย ย ย ย ย const modalContent = document.getElementById('ai-analysis-content');
ย ย ย ย ย ย modalContent.innerHTML = '<div class="flex justify-center p-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>';
ย ย ย ย ย ย openModal('ai-analysis-modal');

ย ย ย ย ย ย const prompt = `Analise o desempenho de ${nome} em ${mes}. Registos: ${JSON.stringify(filtered.map(r => ({data: r.data, entrada: r.entrada, saida: r.saida})))}. Dรช feedback construtivo.`;

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const analysis = await callGemini(prompt);
ย ย ย ย ย ย ย ย modalContent.innerHTML = marked.parse(analysis);
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย modalContent.textContent = "Erro ao gerar anรกlise.";
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // Funรงรตes de UI, Lรณgica e Helpers
ย ย ย ย window.loadRelatorioIndividual = () => {
ย ย ย ย ย ย const nome = document.getElementById('relatorio-agente-select').value;
ย ย ย ย ย ย const mes = document.getElementById('relatorio-mes-select').value;
ย ย ย ย ย ย const tbody = document.getElementById('relatorio-body');

ย ย ย ย ย ย if(!nome || !mes) {
ย ย ย ย ย ย ย ย document.getElementById('relatorio-resumo-cards').classList.add('hidden');
ย ย ย ย ย ย ย ย tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">Selecione Scooteira e Mรชs.</td></tr>';
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย const [y, m] = mes.split('-').map(Number);
ย ย ย ย ย ย const filtered = allRegistros.filter(r => r.nome === nome && parseDate(r.data).getMonth() === (m-1)).sort((a,b) => parseDate(a.data) - parseDate(b.data));

ย ย ย ย ย ย if(filtered.length === 0) {
ย ย ย ย ย ย ย ย ยdocument.getElementById('relatorio-resumo-cards').classList.add('hidden');
ย ย ย ย ย ย ย ย ยtbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">Nenhum registro encontrado.</td></tr>';
ย ย ย ย ย ย ย ย ยreturn;
ย ย ย ย ย ย }

ย ย ย ย ย ย let totalSegundos = 0;
ย ย ย ย ย ย const squadsCount = {};
ย ย ย ย ย ย tbody.innerHTML = '';
ย ย ย ย ย ย filtered.forEach(r => {
ย ย ย ย ย ย ย ย totalSegundos += r.duracaoSegundos;
ย ย ย ย ย ย ย ย squadsCount[r.squadReal] = (squadsCount[r.squadReal] || 0) + 1;
ย ย ย ย ย ย ย ย const tr = document.createElement('tr');
ย ย ย ย ย ย ย ย tr.className = "hover:bg-gray-50 transition border-b border-gray-50";
ย ย ย ย ย ย ย ย const dateObj = parseDate(r.data);
ย ย ย ย ย ย ย ย const diaSemana = dateObj.toLocaleDateString('pt-BR', { weekday: 'short' });
ย ย ย ย ย ย ย ย tr.innerHTML = `<td class="px-6 py-3 font-medium text-gray-900">${r.data}</td><td class="px-6 py-3 text-xs text-gray-500 uppercase">${diaSemana}</td><td class="px-6 py-3">${getSquadBadge(r.squadReal)}</td><td class="px-6 py-3 font-mono text-xs">${r.entrada}</td><td class="px-6 py-3 font-mono text-xs">${r.saida}</td><td class="px-6 py-3 font-mono text-xs font-semibold text-gray-600">${formatDuration(r.duracaoSegundos)}</td><td class="px-6 py-3 text-xs text-gray-500">${r.turnoAtuado}</td>`;
ย ย ย ย ย ย ย ย tbody.appendChild(tr);
ย ย ย ย ย ย });

ย ย ย ย ย ย document.getElementById('resumo-total-dias').textContent = filtered.length;
ย ย ย ย ย ย const [h, min] = formatDuration(totalSegundos).split(':');
ย ย ย ย ย ย document.getElementById('resumo-total-horas').innerHTML = `${h}<span class="text-sm font-normal text-gray-400">h</span> ${min}<span class="text-sm font-normal text-gray-400">m</span>`;
ย ย ย ย ย ย const mainSquad = Object.entries(squadsCount).sort((a,b) => b[1] - a[1])[0][0];
ย ย ย ย ย ย document.getElementById('resumo-squad-princ').textContent = mainSquad;
ย ย ย ย ย ย document.getElementById('relatorio-resumo-cards').classList.remove('hidden');
ย ย ย ย };

ย ย ย ย window.exportToCsv = () => {
ย ย ย ย ย ย const val = document.getElementById('mes-select').value;
ย ย ย ย ย ย if(!val) return showMessage("Selecione um mรชs.", 'warning');
ย ย ย ย ย ย const [y, m] = val.split('-').map(Number);
ย ย ย ย ย ย const filtered = allRegistros.filter(r => { const d = parseDate(r.data); return d && d.getFullYear() === y && d.getMonth() === (m-1); }).sort((a,b) => parseDate(a.data) - parseDate(b.data));
ย ย ย ย ย ย if(filtered.length === 0) return showMessage("Sem dados.", 'warning');
ย ย ย ย ย ย const headers = ["Data", "Nome", "Pseudo", "Squad", "Entrada", "Saรญda", "Duraรงรฃo (h)", "Turno"];
ย ย ย ย ย ย const rows = filtered.map(r => [r.data, r.nome, r.pseudo, r.squadReal, r.entrada, r.saida, (r.duracaoSegundos / 3600).toFixed(2).replace('.', ','), r.turnoAtuado]);
ย ย ย ย ย ย downloadCSV([headers, ...rows], `Relatorio_Geral_${val}.csv`);
ย ย ย ย };

ย ย ย ย window.exportIndividualCsv = () => {
ย ย ย ย ย ย const nome = document.getElementById('relatorio-agente-select').value;
ย ย ย ย ย ย const mes = document.getElementById('relatorio-mes-select').value;
ย ย ย ย ย ย if(!nome || !mes) return showMessage("Selecione dados.", 'warning');
ย ย ย ย ย ย const [y, m] = mes.split('-').map(Number);
ย ย ย ย ย ย const filtered = allRegistros.filter(r => r.nome === nome && parseDate(r.data).getMonth() === (m-1)).sort((a,b) => parseDate(a.data) - parseDate(b.data));
ย ย ย ย ย ย if(filtered.length === 0) return showMessage("Sem dados.", 'warning');
ย ย ย ย ย ย const headers = ["Data", "Nome", "Squad", "Entrada", "Saรญda", "Duraรงรฃo (h)", "Turno"];
ย ย ย ย ย ย const rows = filtered.map(r => [r.data, r.nome, r.squadReal, r.entrada, r.saida, (r.duracaoSegundos / 3600).toFixed(2).replace('.', ','), r.turnoAtuado]);
ย ย ย ย ย ย downloadCSV([headers, ...rows], `Relatorio_${nome.split(' ')[0]}_${mes}.csv`);
ย ย ย ย };

ย ย ย ย function downloadCSV(data, filename) {
ย ย ย ย ย ย const csvContent = data.map(e => e.join(";")).join("\n");
ย ย ย ย ย ย const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
ย ย ย ย ย ย const link = document.createElement("a");
ย ย ย ย ย ย if (link.download !== undefined) {
ย ย ย ย ย ย ย ย const url = URL.createObjectURL(blob);
ย ย ย ย ย ย ย ย link.setAttribute("href", url);
ย ย ย ย ย ย ย ย link.setAttribute("download", filename);
ย ย ย ย ย ย ย ย link.style.visibility = 'hidden';
ย ย ย ย ย ย ย ย document.body.appendChild(link);
ย ย ย ย ย ย ย ย link.click();
ย ย ย ย ย ย ย ย document.body.removeChild(link);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย window.switchTab = (tabName) => {
ย ย ย ย ย ย ['registro', 'relatorio', 'cadastro'].forEach(t => {
ย ย ย ย ย ย ย ย const btn = document.getElementById(`tab-${t}`);
ย ย ย ย ย ย ย ย const content = document.getElementById(`content-${t}`);
ย ย ย ย ย ย ย ย if (btn && content) { btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); content.classList.add('hidden'); }
ย ย ย ย ย ย });
ย ย ย ย ย ย const activeBtn = document.getElementById(`tab-${tabName}`);
ย ย ย ย ย ย const activeContent = document.getElementById(`content-${tabName}`);
ย ย ย ย ย ย if (activeBtn && activeContent) { activeBtn.classList.add('tab-active'); activeBtn.classList.remove('tab-inactive'); activeContent.classList.remove('hidden'); }
ย ย ย ย ย ยย
ย ย ย ย ย ย // Forรงar atualizaรงรฃo do relatรณrio ao trocar de aba
ย ย ย ย ย ย if (tabName === 'relatorio') {
ย ย ย ย ย ย ย ย window.loadRelatorioIndividual();
ย ย ย ย ย ย }

ย ย ย ย ย ย hideMessage();
ย ย ย ย ย ย refreshIcons();
ย ย ย ย };

ย ย ย ย window.showSelectionModal = () => openModal('selection-modal');
ย ย ย ย window.showImportModal = () => openModal('import-modal');
ย ย ย ย window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); };
ย ย ย ย function openModal(id) { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex'); refreshIcons(); }
ย ย ย ย function refreshIcons() { if (typeof lucide !== 'undefined') lucide.createIcons(); }
ย ย ย ย function showMessage(text, type = 'info') {
ย ย ย ย ย ย const box = document.getElementById('message-box');
ย ย ย ย ย ย box.textContent = text;
ย ย ย ย ย ย box.className = 'mx-6 mt-6 p-4 text-sm rounded-lg shadow-sm border-l-4 transition-all flex items-center';
ย ย ย ย ย ย if (type === 'success') box.className += ' bg-emerald-50 text-emerald-800 border-emerald-500';
ย ย ย ย ย ย else if (type === 'error') box.className += ' bg-red-50 text-red-800 border-red-500';
ย ย ย ย ย ย else box.className += ' bg-amber-50 text-amber-800 border-amber-500';
ย ย ย ย ย ย box.classList.remove('hidden');
ย ย ย ย ย ย setTimeout(() => { if(!box.classList.contains('hidden')) hideMessage(); }, 5000);
ย ย ย ย }
ย ย ย ย function hideMessage() { document.getElementById('message-box').classList.add('hidden'); }
ย ย ย ย function formatDate(date) { return date.toLocaleDateString('pt-BR', {timeZone: 'UTC'}); }
ย ย ย ย function parseDate(dateStr) { if(!dateStr) return new Date(); const [day, m, y] = dateStr.split('/'); return new Date(Date.UTC(y, m-1, day)); }
ย ย ย ย function formatDuration(sec) { const h = Math.floor(sec / 3600); const m = Math.floor((sec % 3600) / 60); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
ย ย ย ย function calculateDuration(start, end) { const toSec = (t) => { const [h,m] = t.split(':').map(Number); return h*3600 + m*60; }; let diff = toSec(end) - toSec(start); if (diff <= 0) diff += 24*3600; return diff; }
ย ย ย ย function checkDuplicate(nome, data, excludeId=null) { return allRegistros.some(r => r.nome === nome && r.data === data && r.id !== excludeId); }
ย ย ย ยย
ย ย ย ย window.toggleAgentSelection = (nome) => {
ย ย ย ย ย ย const idx = selectedAgentsNames.indexOf(nome);
ย ย ย ย ย ย if (idx > -1) selectedAgentsNames.splice(idx, 1);
ย ย ย ย ย ย else selectedAgentsNames.push(nome);
ย ย ย ย ย ย updateSelectionDisplay();
ย ย ย ย };

ย ย ย ย function updateSelectionDisplay() {
ย ย ย ย ย ย const btn = document.getElementById('agentes-selection-display');
ย ย ย ย ย ย const count = selectedAgentsNames.length;
ย ย ย ย ย ย const span = btn.querySelector('span');
ย ย ย ย ย ย if (count === 0) { span.textContent = 'Clique para selecionar...'; btn.classList.remove('border-indigo-500', 'ring-1', 'ring-indigo-500'); }
ย ย ย ย ย ย else { span.textContent = `${count} Agente(s) Selecionada(s)`; btn.classList.add('border-indigo-500', 'ring-1', 'ring-indigo-500'); }
ย ย ย ย }

ย ย ย ย // Firebase Init Logic Atualizada para GitHub Pages
ย ย ย ย async function initApp() {
ย ย ย ย ย ย // Verificar se o usuรกrio preencheu a config
ย ย ย ย ย ย if (firebaseConfig.apiKey.includes("COLE_SUA")) {
ย ย ย ย ย ย ย ย showMessage("ATENรรO: Configure as chaves do Firebase no arquivo index.html!", 'error');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const app = initializeApp(firebaseConfig);
ย ย ย ย ย ย ย ย db = getFirestore(app);
ย ย ย ย ย ย ย ย auth = getAuth(app);
ย ย ย ย ย ย ย ย await setPersistence(auth, browserSessionPersistence);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย onAuthStateChanged(auth, async (user) => {
ย ย ย ย ย ย ย ย ย ย if (user) {
ย ย ย ย ย ย ย ย ย ย ย ย userId = user.uid;
ย ย ย ย ย ย ย ย ย ย ย ย isAuthReady = true;
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('auth-status').textContent = 'Conectado';
ย ย ย ย ย ย ย ย ย ย ย ย document.getElementById('auth-status').className = 'text-xs text-emerald-200 font-mono bg-emerald-800 py-1 px-2 rounded';
ย ย ย ย ย ย ย ย ย ย ย ย loadData();
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย // Apenas login anรดnimo suportado no modo GitHub Pages por padrรฃo
ย ย ย ย ย ย ย ย ย ย ย ย await signInAnonymously(auth);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย console.error(e);
ย ย ย ย ย ย ย ย showMessage("Erro de inicializaรงรฃo do Firebase: " + e.message, 'error');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // LรGICA DE CARREGAMENTO ATUALIZADA
ย ย ย ย function loadData() {
ย ย ย ย ย ย const cadastroRef = collection(db, `artifacts/${appId}/public/data/scooteiras_cadastro`);
ย ย ย ย ย ยย
ย ย ย ย ย ย // 1. Renderiza o MOCK localmente IMEDIATAMENTE para feedback visual
ย ย ย ย ย ย // (Assim vocรช vรช a lista mesmo se o banco demorar para conectar)
ย ย ย ย ย ย if (scooteirasCadastro.length === 0) {
ย ย ย ย ย ย ย ย ยscooteirasCadastro = [...MOCK_CADASTROS].sort((a,b) => a.nome.localeCompare(b.nome));
ย ย ย ย ย ย ย ย ยrenderCheckboxes();
ย ย ย ย ย ย ย ย ยrenderCadastro();
ย ย ย ย ย ย }

ย ย ย ย ย ย // 2. Conecta ao banco para pegar dados reais
ย ย ย ย ย ย onSnapshot(cadastroRef, async (snap) => {
ย ย ย ย ย ย ย ย if (snap.empty) {
ย ย ย ย ย ย ย ย ย ย // Se o banco estรก vazio, tenta salvar o Mock lรก silenciosamente
ย ย ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย ย ย const batch = writeBatch(db);
ย ย ย ย ย ย ย ย ย ย ย ย MOCK_CADASTROS.forEach(s => {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const ref = doc(cadastroRef, s.nome);
ย ย ย ย ย ย ย ย ย ย ย ย ย ย batch.set(ref, s);
ย ย ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย ย ย ย ย await batch.commit();
ย ย ย ย ย ย ย ย ย ย ย ย console.log("Banco estava vazio. Padrรตes salvos automaticamente.");
ย ย ย ย ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย ย ย ย ย console.error("Erro ao salvar padrรตes automรกticos:", e);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย // Se tem dados no banco, usa eles (sobrescreve o mock local)
ย ย ย ย ย ย ย ย ย ย scooteirasCadastro = snap.docs.map(d => d.data()).sort((a,b) => a.nome.localeCompare(b.nome));
ย ย ย ย ย ย ย ย ย ย agentesByPseudo = {};
ย ย ย ย ย ย ย ย ย ย scooteirasCadastro.forEach(a => { if(a.pseudo) agentesByPseudo[a.pseudo] = a; });
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย renderCheckboxes();
ย ย ย ย ย ย ย ย ย ย renderCadastro();
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }, (error) => {
ย ย ย ย ย ย ย ย ยconsole.error("Erro no Snapshot:", error);
ย ย ย ย ย ย ย ย ย// Se der erro de conexรฃo, mantรฉm o mock local que jรก carregamos no passo 1
ย ย ย ย ย ย ย ย ยshowMessage("Usando dados locais (Modo Offline).", 'warning');
ย ย ย ย ย ย });

ย ย ย ย ย ย const monthInput = document.getElementById('mes-select');
ย ย ย ย ย ย if(monthInput) loadHistorico();
ย ย ย ย }

ย ย ย ย window.loadHistorico = () => {
ย ย ย ย ย ย if(!db) return;
ย ย ย ย ย ย const val = document.getElementById('mes-select').value;
ย ย ย ย ย ย if(!val) return;
ย ย ย ย ย ย const [y, m] = val.split('-').map(Number);
ย ย ย ย ย ย onSnapshot(collection(db, `artifacts/${appId}/public/data/registros_diarios`), (snap) => {
ย ย ย ย ย ย ย ย allRegistros = snap.docs.map(d => ({id: d.id, ...d.data()}));
ย ย ย ย ย ย ย ย const filtered = allRegistros.filter(r => { const d = parseDate(r.data); return d && d.getFullYear() === y && d.getMonth() === (m-1); }).sort((a,b) => parseDate(a.data) - parseDate(b.data));
ย ย ย ย ย ย ย ย renderHistoryTable(filtered);
ย ย ย ย ย ย ย ย renderSummary(filtered);
ย ย ย ย ย ย ย ย if(!document.getElementById('content-relatorio').classList.contains('hidden')) { window.loadRelatorioIndividual(); }
ย ย ย ย ย ย });
ย ย ย ย };

ย ย ย ย // Nova funรงรฃo para forรงar o reset
ย ย ย ย window.forceResetDefaults = async () => {
ย ย ย ย ย ย if(!confirm("Tem certeza? Isso vai apagar TODAS as agentes cadastradas e restaurar a lista padrรฃo de 20 nomes.")) return;
ย ย ย ย ย ยย
ย ย ย ย ย ย showMessage("Restaurando padrรตes...", 'info');
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย // 1. Apagar tudo primeiro
ย ย ย ย ย ย ย ย const cadastroRef = collection(db, `artifacts/${appId}/public/data/scooteiras_cadastro`);
ย ย ย ย ย ย ย ย const snap = await getDocs(cadastroRef);
ย ย ย ย ย ย ย ย const batchDel = writeBatch(db);
ย ย ย ย ย ย ย ย snap.docs.forEach(d => batchDel.delete(d.ref));
ย ย ย ย ย ย ย ย await batchDel.commit();

ย ย ย ย ย ย ย ย // 2. Inserir Mock
ย ย ย ย ย ย ย ย const batchAdd = writeBatch(db);
ย ย ย ย ย ย ย ย MOCK_CADASTROS.forEach(s => {
ย ย ย ย ย ย ย ย ย ย const ref = doc(cadastroRef, s.nome);
ย ย ย ย ย ย ย ย ย ย batchAdd.set(ref, s);
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย await batchAdd.commit();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย showMessage("Lista padrรฃo restaurada com sucesso!", 'success');
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย console.error(e);
ย ย ย ย ย ย ย ย showMessage("Erro ao restaurar: " + e.message, 'error');
ย ย ย ย ย ย }
ย ย ย ย };

ย ย ย ย function renderCadastro() {
ย ย ย ย ย ย const tbody = document.getElementById('cadastro-list-body');
ย ย ย ย ย ย tbody.innerHTML = '';
ย ย ย ย ย ย if(scooteirasCadastro.length === 0) {
ย ย ย ย ย ย ย ย tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">Nenhuma scooteira cadastrada.</td></tr>';
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย ย scooteirasCadastro.forEach(a => {
ย ย ย ย ย ย ย ย const tr = document.createElement('tr');
ย ย ย ย ย ย ย ย tr.className = "hover:bg-gray-50 transition border-b border-gray-50 last:border-0";
ย ย ย ย ย ย ย ย tr.innerHTML = `<td class="px-6 py-3 font-medium text-gray-900">${a.nome} <span class="block text-xs text-gray-400 font-normal">${a.pseudo}</span></td><td class="px-6 py-3">${getSquadBadge(a.squadPadrao)}</td><td class="px-6 py-3 text-sm text-gray-600">${a.turnoPadrao}</td><td class="px-6 py-3 font-mono text-xs text-gray-500">${a.entradaPadrao} - ${a.saidaPadrao}</td><td class="px-6 py-3 text-right"><div class="flex justify-end space-x-2"><button onclick="editAgent('${a.nome}')" class="p-1 text-blue-600 hover:bg-blue-50 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteAgentConfirmation('${a.nome}')" class="p-1 text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td>`;
ย ย ย ย ย ย ย ย tbody.appendChild(tr);
ย ย ย ย ย ย });
ย ย ย ย ย ย refreshIcons();
ย ย ย ย }

ย ย ย ย function renderCheckboxes() {
ย ย ย ย ย ย const container = document.getElementById('agentes-checkbox-list');
ย ย ย ย ย ย const reportSelect = document.getElementById('relatorio-agente-select');
ย ย ย ย ย ย container.innerHTML = '';
ย ย ย ย ย ย reportSelect.innerHTML = '<option value="" disabled selected>Selecione...</option>';
ย ย ย ย ย ย scooteirasCadastro.forEach(a => {
ย ย ย ย ย ย ย ย const div = document.createElement('div');
ย ย ย ย ย ย ย ย div.className = 'flex items-center p-2 hover:bg-gray-50 rounded transition cursor-pointer';
ย ย ย ย ย ย ย ย div.onclick = (e) => { if(e.target.type !== 'checkbox') { const cb = div.querySelector('input'); cb.checked = !cb.checked; window.toggleAgentSelection(a.nome); } };
ย ย ย ย ย ย ย ย div.innerHTML = `<input type="checkbox" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${selectedAgentsNames.includes(a.nome) ? 'checked' : ''} onchange="window.toggleAgentSelection('${a.nome}')"><div class="ml-3 text-sm"><p class="font-medium text-gray-700">${a.nome}</p><p class="text-xs text-gray-500">${a.pseudo}</p></div>`;
ย ย ย ย ย ย ย ย container.appendChild(div);
ย ย ย ย ย ย ย ย const opt = document.createElement('option');
ย ย ย ย ย ย ย ย opt.value = a.nome;
ย ย ย ย ย ย ย ย opt.textContent = a.nome;
ย ย ย ย ย ย ย ย reportSelect.appendChild(opt);
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย function renderHistoryTable(data) {
ย ย ย ย ย ย const tbody = document.getElementById('historico-body');
ย ย ย ย ย ย tbody.innerHTML = '';
ย ย ย ย ย ย if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">Nenhum registro encontrado.</td></tr>'; return; }
ย ย ย ย ย ย data.forEach(r => {
ย ย ย ย ย ย ย ย const badgeColor = getSquadBadge(r.squadReal);
ย ย ย ย ย ย ย ย const tr = document.createElement('tr');
ย ย ย ย ย ย ย ย tr.className = "hover:bg-gray-50 transition border-b border-gray-50 last:border-0";
ย ย ย ย ย ย ย ย tr.innerHTML = `<td class="px-6 py-3 font-medium text-gray-900 whitespace-nowrap">${r.data}</td><td class="px-6 py-3"><div class="flex flex-col"><span class="font-medium text-gray-700">${r.nome}</span><span class="text-xs text-gray-400">${r.pseudo || '-'}</span></div></td><td class="px-6 py-3">${badgeColor}</td><td class="px-6 py-3 font-mono text-xs">${r.entrada}</td><td class="px-6 py-3 font-mono text-xs">${r.saida}</td><td class="px-6 py-3 font-mono text-xs text-gray-500">${formatDuration(r.duracaoSegundos)}</td><td class="px-6 py-3 text-xs">${r.turnoAtuado}</td><td class="px-6 py-3 text-right"><div class="flex justify-end space-x-2"><button onclick="editRegistro('${r.id}')" class="p-1 text-blue-600 hover:bg-blue-50 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteRegistroConfirmation('${r.id}')" class="p-1 text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td>`;
ย ย ย ย ย ย ย ย tbody.appendChild(tr);
ย ย ย ย ย ย });
ย ย ย ย ย ย refreshIcons();
ย ย ย ย }

ย ย ย ย function renderSummary(data) {
ย ย ย ย ย ย const container = document.getElementById('resumo-squads');
ย ย ย ย ย ย container.innerHTML = '';
ย ย ย ย ย ย const totals = {};
ย ย ย ย ย ย let grandTotal = 0;

ย ย ย ย ย ย data.forEach(r => {ย
ย ย ย ย ย ย ย ย // 1. Limpa espaรงos e normaliza
ย ย ย ย ย ย ย ย let s = r.squadReal ? r.squadReal.trim() : 'Outro';
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Normalizaรงรฃo agressiva para garantir que Rec Cred caia na chave certa
ย ย ย ย ย ย ย ย const lower = s.toLowerCase();
ย ย ย ย ย ย ย ย if(lower.includes('rec') || lower.includes('crรฉdito') || lower.includes('credito')) {
ย ย ย ย ย ย ย ย ย ย s = 'Rec Cred';
ย ย ย ย ย ย ย ย } else if(lower.includes('monitor')) {
ย ย ย ย ย ย ย ย ย ย s = 'Monitoria';
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย if(!totals[s]) totals[s] = 0;ย
ย ย ย ย ย ย ย ย totals[s] += r.duracaoSegundos;ย
ย ย ย ย ย ย ย ย grandTotal += r.duracaoSegundos;
ย ย ย ย ย ย });
ย ย ย ย ย ยย
ย ย ย ย ย ย // 2. Renderiza Squads Fixos (Incluindo Rec Cred)
ย ย ย ย ย ย SQUADS_OPCOES.forEach(s => {
ย ย ย ย ย ย ย ย const sec = totals[s] || 0;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (sec === 0) return;

ย ย ย ย ย ย ย ย const [h, m] = formatDuration(sec).split(':');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Definiรงรฃo de Cores
ย ย ย ย ย ย ย ย let borderClass = 'border-l-4 border-indigo-500'; // Padrรฃo
ย ย ย ย ย ย ย ย if(s.includes('SC')) borderClass = 'border-l-4 border-purple-500';
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // --- AQUI ESTร A COR VERMELHA ---
ย ย ย ย ย ย ย ย if(s === 'Rec Cred' || s.includes('Rec')) borderClass = 'border-l-4 border-red-600';ย
ย ย ย ย ย ย ย ย // --------------------------------
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if(s.includes('Monitoria')) borderClass = 'border-l-4 border-yellow-500';
ย ย ย ย ย ย ย ย if(s === 'OJR') borderClass = 'border-l-4 border-orange-500';

ย ย ย ย ย ย ย ย container.innerHTML += `
ย ย ย ย ย ย ย ย ย ย <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 ${borderClass}">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">${s}</h3>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-2xl font-bold text-gray-800">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${h}<span class="text-sm text-gray-400 font-normal">h</span>ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${m}<span class="text-sm text-gray-400 font-normal">m</span>
ย ย ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย </div>`;
ย ย ย ย ย ย });
ย ย ย ย ย ยย
ย ย ย ย ย ย // 3. Renderiza Outros Squads (Dinรขmicos)
ย ย ย ย ย ย Object.keys(totals).forEach(s => {
ย ย ย ย ย ย ย ย if (!SQUADS_OPCOES.includes(s)) {
ย ย ย ย ย ย ย ย ย ย const sec = totals[s];
ย ย ย ย ย ย ย ย ย ย if (sec === 0) return;

ย ย ย ย ย ย ย ย ย ย const [h, m] = formatDuration(sec).split(':');
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย // Fallback de seguranรงa: Se por acaso "Rec Cred" cair aqui, forรงa vermelho tambรฉm
ย ย ย ย ย ย ย ย ย ย let dynBorder = 'border-l-4 border-gray-500';
ย ย ย ย ย ย ย ย ย ย if (s.toLowerCase().includes('rec')) dynBorder = 'border-l-4 border-red-600';

ย ย ย ย ย ย ย ย ย ย container.innerHTML += `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 ${dynBorder}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xs font-semibold text-gray-500 uppercase mb-1">${s}</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-2xl font-bold text-gray-800">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${h}<span class="text-sm text-gray-400 font-normal">h</span>ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${m}<span class="text-sm text-gray-400 font-normal">m</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>`;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });

ย ย ย ย ย ย // Render Grand Total Card LAST
ย ย ย ย ย ย const [gh, gm] = formatDuration(grandTotal).split(':');
ย ย ย ย ย ย ยcontainer.innerHTML += `
ย ย ย ย ย ย ย ย <div class="bg-gradient-to-br from-indigo-600 to-blue-600 p-4 rounded-lg shadow-md text-white flex flex-col justify-between">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-xs font-bold text-indigo-100 uppercase mb-1 flex items-center">
ย ย ย ย ย ย ย ย ย ย ย ย <i data-lucide="clock" class="w-3 h-3 mr-1"></i> Total Geral
ย ย ย ย ย ย ย ย ย ย </h3>
ย ย ย ย ย ย ย ย ย ย <p class="text-3xl font-bold">${gh}<span class="text-sm text-indigo-200 font-normal">h</span> ${gm}<span class="text-sm text-indigo-200 font-normal">m</span></p>
ย ย ย ย ย ย ย ย </div>`;

ย ย ย ย ย ย refreshIcons();
ย ย ย ย }

ย ย ย ย function getSquadBadge(squad) {
ย ย ย ย ย ย let classes = "bg-gray-100 text-gray-800";
ย ย ย ย ย ย if(squad === 'CB') classes = "bg-indigo-100 text-indigo-800";
ย ย ย ย ย ย else if(squad === 'SC') classes = "bg-purple-100 text-purple-800";
ย ย ย ย ย ย else if(squad === 'Rec Cred') classes = "bg-pink-100 text-pink-800";
ย ย ย ย ย ย else if(squad === 'Monitoria') classes = "bg-yellow-100 text-yellow-800";
ย ย ย ย ย ย else if(squad === 'OJR') classes = "bg-orange-100 text-orange-800";
ย ย ย ย ย ย return `<span class="px-2 py-1 rounded-full text-xs font-semibold ${classes}">${squad}</span>`;
ย ย ย ย }

ย ย ย ย // --- Eventos de Formulรกrios ---
ย ย ย ย document.getElementById('add-agent-form').addEventListener('submit', async (e) => {
ย ย ย ย ย ย e.preventDefault();
ย ย ย ย ย ย const nome = document.getElementById('new-nome').value.trim();
ย ย ย ย ย ย const pseudo = document.getElementById('new-pseudo').value.trim();
ย ย ย ย ย ย const squad = document.getElementById('new-squad').value;
ย ย ย ย ย ย const turno = document.getElementById('new-turno').value;
ย ย ย ย ย ย const entrada = document.getElementById('new-entrada').value;
ย ย ย ย ย ย const saida = document.getElementById('new-saida').value;
ย ย ย ย ย ย if(!nome || !pseudo) { showMessage("Preencha nome e pseudo.", 'error'); return; }
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const newAgent = { nome, pseudo, squadPadrao: squad, turnoPadrao: turno, entradaPadrao: entrada, saidaPadrao: saida, cargaPadrao: 6 };
ย ย ย ย ย ย ย ย await setDoc(doc(db, `artifacts/${appId}/public/data/scooteiras_cadastro`, nome), newAgent);
ย ย ย ย ย ย ย ย showMessage("Agente adicionada!", 'success');
ย ย ย ย ย ย ย ย e.target.reset(); document.getElementById('new-entrada').value = "08:00"; document.getElementById('new-saida').value = "14:00";
ย ย ย ย ย ย } catch(err) { console.error(err); showMessage("Erro: " + err.message, 'error'); }
ย ย ย ย });

ย ย ย ย window.handleEntrySubmission = () => {
ย ย ย ย ย ย const dateInput = document.getElementById('data-atuacao').value;
ย ย ย ย ย ย if(!dateInput || selectedAgentsNames.length === 0) { showMessage("Selecione data e agentes.", 'error'); return; }
ย ย ย ย ย ย const [y,m,d] = dateInput.split('-'); const dataFormatada = `${d}/${m}/${y}`;
ย ย ย ย ย ย const agents = selectedAgentsNames.map(n => scooteirasCadastro.find(a => a.nome === n));
ย ย ย ย ย ย if(agents.some(a => checkDuplicate(a.nome, dataFormatada))) { showMessage("Atenรงรฃo: Duplicidade detectada.", 'warning'); return; }
ย ย ย ย ย ย document.getElementById('recordIdToEdit').value = '';
ย ย ย ย ย ย document.getElementById('details-modal-title').textContent = 'Confirmar Lanรงamentos';
ย ย ย ย ย ย document.getElementById('modal-instructions').textContent = `Data: ${dataFormatada}`;
ย ย ย ย ย ย const container = document.getElementById('agentes-detalhes-container'); container.innerHTML = '';
ย ย ย ย ย ย agents.forEach((a, idx) => {
ย ย ย ย ย ย ย ย let defTurno = "Meu Turno";
ย ย ย ย ย ย ย ย const html = `<div class="bg-gray-50 p-4 rounded-lg border border-gray-200" data-agent-block="${idx}"><div class="flex justify-between mb-3"><h4 class="font-bold text-sm text-gray-800">${a.nome}</h4><span class="text-xs bg-white border px-2 py-0.5 rounded text-gray-500">${a.squadPadrao}</span></div><input type="hidden" name="nome_${idx}" value="${a.nome}"><input type="hidden" name="pseudo_${idx}" value="${a.pseudo}"><input type="hidden" name="data_${idx}" value="${dataFormatada}"><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Entrada</label><input type="time" name="entrada_${idx}" value="${a.entradaPadrao}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500"></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Saรญda</label><input type="time" name="saida_${idx}" value="${a.saidaPadrao}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500"></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Squad Real</label><select name="squad_${idx}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500">${SQUADS_OPCOES.map(s => `<option value="${s}" ${s===a.squadPadrao?'selected':''}>${s}</option>`).join('')}</select></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Turno</label><select name="turno_${idx}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500">${TURNOS_OPCOES.map(t => `<option value="${t}" ${t===defTurno?'selected':''}>${t}</option>`).join('')}</select></div></div></div>`;
ย ย ย ย ย ย ย ย container.innerHTML += html;
ย ย ย ย ย ย });
ย ย ย ย ย ย openModal('details-modal');
ย ย ย ย };

ย ย ย ย document.getElementById('details-form').addEventListener('submit', async (e) => {
ย ย ย ย ย ย e.preventDefault();
ย ย ย ย ย ย const formData = new FormData(e.target);
ย ย ย ย ย ย const isUpdate = !!document.getElementById('recordIdToEdit').value;
ย ย ย ย ย ย const entries = [];
ย ย ย ย ย ย for(let i=0; i<100; i++) {
ย ย ย ย ย ย ย ย const nome = formData.get(`nome_${i}`); if(!nome) break;
ย ย ย ย ย ย ย ย const entrada = formData.get(`entrada_${i}`); const saida = formData.get(`saida_${i}`);
ย ย ย ย ย ย ย ย const entry = { nome: nome, pseudo: formData.get(`pseudo_${i}`), data: formData.get(`data_${i}`), entrada: entrada, saida: saida, squadReal: formData.get(`squad_${i}`), turnoAtuado: formData.get(`turno_${i}`), duracaoSegundos: calculateDuration(entrada, saida), registradoEm: new Date().toISOString() };
ย ย ย ย ย ย ย ย if(isUpdate) entry.id = document.getElementById('recordIdToEdit').value;
ย ย ย ย ย ย ย ย entries.push(entry);
ย ย ย ย ย ย }
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย if(isUpdate) { const { id, ...data } = entries[0]; await updateDoc(doc(db, `artifacts/${appId}/public/data/registros_diarios`, id), data); showMessage("Atualizado!", 'success'); }
ย ย ย ย ย ย ย ย else { await runTransaction(db, async (txn) => { const col = collection(db, `artifacts/${appId}/public/data/registros_diarios`); entries.forEach(ent => txn.set(doc(col), ent)); }); showMessage("Salvo!", 'success'); selectedAgentsNames = []; updateSelectionDisplay(); renderCheckboxes(); document.getElementById('data-atuacao').value = ''; }
ย ย ย ย ย ย ย ย closeModal('details-modal');
ย ย ย ย ย ย } catch(err) { console.error(err); showMessage("Erro: " + err.message, 'error'); }
ย ย ย ย });

ย ย ย ย window.editRegistro = (id) => {
ย ย ย ย ย ย const rec = allRegistros.find(r => r.id === id); if(!rec) return;
ย ย ย ย ย ย document.getElementById('recordIdToEdit').value = id;
ย ย ย ย ย ย document.getElementById('details-modal-title').textContent = 'Editar Lanรงamento';
ย ย ย ย ย ย document.getElementById('modal-instructions').textContent = '';
ย ย ย ย ย ย const container = document.getElementById('agentes-detalhes-container');
ย ย ย ย ย ย container.innerHTML = `<div class="bg-gray-50 p-4 rounded-lg border border-gray-200"><div class="flex justify-between mb-3"><h4 class="font-bold text-sm text-gray-800">${rec.nome}</h4><span class="text-xs text-gray-500">${rec.data}</span></div><input type="hidden" name="nome_0" value="${rec.nome}"><input type="hidden" name="pseudo_0" value="${rec.pseudo}"><input type="hidden" name="data_0" value="${rec.data}"><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Entrada</label><input type="time" name="entrada_0" value="${rec.entrada}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500"></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Saรญda</label><input type="time" name="saida_0" value="${rec.saida}" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500"></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Squad Real</label><select name="squad_0" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500">${SQUADS_OPCOES.map(s => `<option value="${s}" ${s===rec.squadReal?'selected':''}>${s}</option>`).join('')}</select></div><div><label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Turno</label><select name="turno_0" class="w-full text-sm border-gray-300 rounded focus:ring-indigo-500">${TURNOS_OPCOES.map(t => `<option value="${t}" ${t===rec.turnoAtuado?'selected':''}>${t}</option>`).join('')}</select></div></div></div>`;
ย ย ย ย ย ย openModal('details-modal');
ย ย ย ย };

ย ย ย ย // ... Resto das funรงรตes de deleรงรฃo e importaรงรฃo (mantidas do cรณdigo original) ...
ย ย ย ย let confirmationCallback = null;
ย ย ย ย window.resolveConfirmation = (val) => { closeModal('confirmation-modal'); if(confirmationCallback) confirmationCallback(val); confirmationCallback = null; };
ย ย ย ย window.deleteRegistroConfirmation = (id) => { document.getElementById('confirm-title').textContent = "Excluir Registro?"; document.getElementById('confirm-message').textContent = "Essa aรงรฃo nรฃo pode ser desfeita."; openModal('confirmation-modal'); confirmationCallback = async (confirmed) => { if(confirmed) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/registros_diarios`, id)); showMessage("Registro excluรญdo.", 'success'); } }; };
ย ย ย ย window.deleteAgentConfirmation = (nome) => { document.getElementById('confirm-title').textContent = "Excluir Agente?"; document.getElementById('confirm-message').textContent = `Remover ${nome}?`; openModal('confirmation-modal'); confirmationCallback = async (confirmed) => { if(confirmed) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/scooteiras_cadastro`, nome)); showMessage("Cadastro removido.", 'success'); } }; };

ย ย ย ย async function processImportedData(rows) {
ย ย ย ย ย ย ยconst valid = [];
ย ย ย ย ย ย ยlet unknownAgents = 0;
ย ย ย ย ย ย ยlet duplicates = 0;

ย ย ย ย ย ย ยfor(const item of rows) {
ย ย ย ย ย ย ย ย let agent = agentesByPseudo[item.nome] || scooteirasCadastro.find(a => a.nome === item.nome || a.pseudo === item.nome);
ย ย ย ย ย ย ย ย if(!agent) agent = scooteirasCadastro.find(a => item.nome.includes(a.pseudo));
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if(!agent) {
ย ย ย ย ย ย ย ย ย ย unknownAgents++;
ย ย ย ย ย ย ย ย ย ย console.warn(`Agente desconhecida: ${item.nome}`);
ย ย ย ย ย ย ย ย ย ย continue;
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย if(checkDuplicate(agent.nome, item.data)) {
ย ย ย ย ย ย ย ย ย ย duplicates++;
ย ย ย ย ย ย ย ย ย ย continue;
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย valid.push({ nome: agent.nome, pseudo: agent.pseudo, data: item.data, entrada: item.entrada, saida: item.saida, squadReal: item.squadReal || agent.squadPadrao, turnoAtuado: "Meu Turno", duracaoSegundos: calculateDuration(item.entrada, item.saida), registradoEm: new Date().toISOString() });
ย ย ย ย ย ย ย}

ย ย ย ย ย ย ยif(valid.length) {
ย ย ย ย ย ย ย ย ยawait runTransaction(db, async (txn) => { const col = collection(db, `artifacts/${appId}/public/data/registros_diarios`); valid.forEach(v => txn.set(doc(col), v)); });
ย ย ย ย ย ย ย ย ยshowMessage(`Importado ${valid.length} registros.`, 'success'); closeModal('import-modal');
ย ย ย ย ย ย ย} else {ย
ย ย ย ย ย ย ย ย ยif (unknownAgents > 0) showMessage(`Erro: ${unknownAgents} nome(s) nรฃo encontrados na aba Equipe. Cadastre-as primeiro!`, 'error');
ย ย ย ย ย ย ย ย ยelse if (duplicates > 0) showMessage(`Atenรงรฃo: Todos os ${duplicates} registros jรก existiam no sistema.`, 'warning');
ย ย ย ย ย ย ย ย ยelse showMessage("Nenhum dado vรกlido encontrado.", 'warning');ย
ย ย ย ย ย ย ย}
ย ย ย ย }

ย ย ย ย window.handleImport = async () => {
ย ย ย ย ย ย ยconst text = document.getElementById('import-data-json').value.trim();
ย ย ย ย ย ย ยif(!text) return;
ย ย ย ย ย ย ยtry { const rows = parseTabularData(text); await processImportedData(rows); document.getElementById('import-data-json').value = ''; }
ย ย ย ย ย ย ยcatch(e) { showMessage("Erro: " + e.message, 'error'); }
ย ย ย ย };
ย ย ย ยย
ย ย ย ย function parseTabularData(text) {
ย ย ย ย ย ย ยconst lines = text.split('\n').filter(l => l.trim());
ย ย ย ย ย ย ยif(lines.length < 2) throw new Error("Dados insuficientes");
ย ย ย ย ย ย ยconst seps = ['\t', ';', ',', '|']; let sep = ','; let max = 0; seps.forEach(s => { const c = lines[1].split(s).length; if(c>max){max=c; sep=s;} });
ย ย ย ย ย ย ยconst headers = lines[0].split(sep).map(h => h.toLowerCase().replace(/[^a-z]/g, ''));
ย ย ย ย ย ย ยconst map = { 'data': 'data', 'nome': 'nome', 'agente': 'nome', 'scooteira': 'nome', 'email': 'nome', 'entrada': 'entrada', 'inicio': 'entrada', 'saida': 'saida', 'termino': 'saida', 'squad': 'squadReal', 'sua': 'squadReal', 'turno': 'turnoAtuado' };
ย ย ย ย ย ย ยconst data = [];
ย ย ย ย ย ย ยfor(let i=1; i<lines.length; i++) {
ย ย ย ย ย ย ย ย ยconst cols = lines[i].split(sep); let obj = {};
ย ย ย ย ย ย ย ย ยcols.forEach((c, idx) => { const h = headers[idx]; for(let k in map) if(h.includes(k)) obj[map[k]] = c.replace(/"/g, '').trim(); });
ย ย ย ย ย ย ย ย ยif(obj.nome && obj.data && obj.entrada) {
ย ย ย ย ย ย ย ย ย ย ยif(obj.entrada.length > 5) obj.entrada = obj.entrada.substring(0,5);
ย ย ย ย ย ย ย ย ย ย ยif(obj.saida && obj.saida.length > 5) obj.saida = obj.saida.substring(0,5);
ย ย ย ย ย ย ย ย ย ย ยif(obj.nome.includes('@') || obj.nome.length > 30) { const parts = obj.nome.split(' '); if(parts.length > 1) obj.nome = parts.slice(-2).join(' '); }
ย ย ย ย ย ย ย ย ย ย ยdata.push(obj);
ย ย ย ย ย ย ย ย ย}
ย ย ย ย ย ย ย}
ย ย ย ย ย ย ยreturn data;
ย ย ย ย }

ย ย ย ย window.editAgent = (nome) => {
ย ย ย ย ย ย const a = scooteirasCadastro.find(x => x.nome === nome); if(!a) return;
ย ย ย ย ย ย if(!document.getElementById('edit-agent-modal')) {
ย ย ย ย ย ย ย ย const m = document.createElement('div'); m.id = 'edit-agent-modal'; m.className = 'fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50';
ย ย ย ย ย ย ย ย m.innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8"><h3 class="text-xl font-bold text-indigo-700 mb-6">Editar Cadastro</h3><form id="edit-agent-form" class="space-y-4"><input type="hidden" id="ea-orig"><div><label class="text-xs uppercase font-bold text-gray-400">Nome</label><input id="ea-nome" class="w-full p-2 border rounded bg-gray-50" disabled></div><div><label class="text-xs uppercase font-bold text-gray-400">Pseudo</label><input id="ea-pseudo" class="w-full p-2 border rounded"></div><div><label class="text-xs uppercase font-bold text-gray-400">Squad</label><select id="ea-squad" class="w-full p-2 border rounded">${SQUADS_OPCOES.map(s=>`<option>${s}</option>`).join('')}</select></div><div><label class="text-xs uppercase font-bold text-gray-400">Dias</label><input id="ea-dias" class="w-full p-2 border rounded"></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs uppercase font-bold text-gray-400">Entrada</label><input type="time" id="ea-ent" class="w-full p-2 border rounded"></div><div><label class="text-xs uppercase font-bold text-gray-400">Saรญda</label><input type="time" id="ea-sai" class="w-full p-2 border rounded"></div></div><div class="pt-4 flex justify-end space-x-2"><button type="button" onclick="closeModal('edit-agent-modal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Salvar</button></div></form></div>`;
ย ย ย ย ย ย ย ย document.body.appendChild(m);
ย ย ย ย ย ย ย ย document.getElementById('edit-agent-form').addEventListener('submit', async (e)=>{ e.preventDefault(); const nome = document.getElementById('ea-orig').value; await updateDoc(doc(db, `artifacts/${appId}/public/data/scooteiras_cadastro`, nome), { pseudo: document.getElementById('ea-pseudo').value, squadPadrao: document.getElementById('ea-squad').value, turnoPadrao: document.getElementById('ea-dias').value, entradaPadrao: document.getElementById('ea-ent').value, saidaPadrao: document.getElementById('ea-sai').value }); showMessage("Salvo.", 'success'); closeModal('edit-agent-modal'); });
ย ย ย ย ย ย }
ย ย ย ย ย ย document.getElementById('ea-orig').value = a.nome; document.getElementById('ea-nome').value = a.nome; document.getElementById('ea-pseudo').value = a.pseudo; document.getElementById('ea-squad').value = a.squadPadrao; document.getElementById('ea-dias').value = a.turnoPadrao; document.getElementById('ea-ent').value = a.entradaPadrao; document.getElementById('ea-sai').value = a.saidaPadrao;
ย ย ย ย ย ย openModal('edit-agent-modal');
ย ย ย ย };

ย ย ย ย window.onload = () => { const d = new Date(); const m = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; document.getElementById('mes-select').value = m; document.getElementById('relatorio-mes-select').value = m; initApp(); };
ย ย </script>
</body>
</html>
