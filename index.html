<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Atuação - Scooto</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚜️</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; color: #334155; }
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        
        .cap-cell { font-size: 0.75rem; padding: 6px; text-align: center; border: 1px solid #e2e8f0; }
        .cap-header { font-size: 0.7rem; font-weight: 700; background-color: #f8fafc; padding: 8px; border: 1px solid #e2e8f0; color: #64748b; text-transform: uppercase; }
        .cap-warn-low { background-color: #fee2e2; color: #991b1b; }
        .cap-warn-high { background-color: #ffedd5; color: #9a3412; }
        .cap-ok { background-color: #dcfce7; color: #166534; }

        .week-group-header { cursor: pointer; background: #ffffff; border: 1px solid #e2e8f0; padding: 16px; border-radius: 12px; margin-bottom: 8px; transition: all 0.2s; }
        .week-group-header:hover { border-color: #4f46e5; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .week-content { display: none; margin-bottom: 20px; border: 1px solid #e2e8f0; border-radius: 0 0 12px 12px; overflow-x: auto; background: white; }
        .week-content.active { display: block; border-top: none; margin-top: -12px; }
        
        .squad-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-right: 4px; border: 1px solid currentColor; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8 pb-24">

    <div id="app" class="w-full max-w-full sm:max-w-7xl bg-white rounded-2xl shadow-xl overflow-hidden relative">

        <header class="bg-indigo-600 p-6 sm:p-10 text-white">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight">Dash Atuação - Scooto</h1>
                    <p class="text-indigo-100 text-sm mt-1">Gestão de Horas x Squads</p>
                </div>
                <div id="auth-status" class="bg-indigo-800 py-1 px-3 rounded text-xs font-mono">Conectando...</div>
            </div>
        </header>

        <div class="flex border-b border-gray-200 bg-gray-50 px-6 overflow-x-auto">
            <button id="tab-registro" class="py-4 px-6 text-sm font-semibold transition-all tab-active whitespace-nowrap" onclick="window.switchTab('registro')">Registro Diário</button>
            <button id="tab-capacidade" class="py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('capacidade')">Capacidade & Metas</button>
            <button id="tab-relatorio" class="py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('relatorio')">Relatórios</button>
            <button id="tab-cadastro" class="py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('cadastro')">Equipe</button>
        </div>

        <div id="message-box" class="hidden mx-6 mt-6 p-4 text-sm rounded-lg shadow-sm border-l-4"></div>

        <div class="p-6 sm:p-8 min-h-[500px]">

            <div id="content-registro" class="animate-fade-in">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-3">
                            <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Data</label>
                            <input type="date" id="data-atuacao" class="w-full p-2.5 border-gray-300 rounded-lg text-sm">
                        </div>
                        <div class="md:col-span-6">
                            <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Scooteiras</label>
                            <button onclick="window.showSelectionModal()" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-left text-sm flex justify-between items-center">
                                <span id="selected-count-label">Clique para selecionar...</span>
                                <i data-lucide="users" class="w-4 h-4 text-gray-400"></i>
                            </button>
                        </div>
                        <div class="md:col-span-3">
                            <button onclick="window.handleEntrySubmission()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg font-bold shadow-md">Lançar</button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Histórico Mensal</h2>
                    <input type="month" id="mes-select" onchange="window.loadHistorico()" class="border-gray-300 rounded-md text-sm">
                </div>

                <div id="resumo-squads" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8"></div>

                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3"><input type="checkbox" id="select-all-history" onclick="window.toggleSelectAll()"></th>
                                <th class="px-6 py-3">Data</th>
                                <th class="px-6 py-3">Nome</th>
                                <th class="px-6 py-3">Squad</th>
                                <th class="px-6 py-3">Horário</th>
                                <th class="px-6 py-3 font-bold">Total</th>
                                <th class="px-6 py-3 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="historico-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-capacidade" class="hidden animate-fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Capacidade & Metas Diárias</h2>
                    <p class="text-sm text-gray-500">Exibição baseada nas metas oficiais.</p>
                </div>
                <div id="capacity-accordion-container" class="space-y-4"></div>
            </div>

            <div id="content-relatorio" class="hidden"></div>
            <div id="content-cadastro" class="hidden"></div>
        </div>
    </div>

    <div id="selection-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Equipe</h3>
            <div id="agentes-checkbox-list" class="space-y-2 max-h-96 overflow-y-auto mb-6"></div>
            <button onclick="window.closeModal('selection-modal')" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Concluir</button>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-3xl w-full max-h-[90vh] flex flex-col shadow-2xl">
            <div class="p-6 bg-indigo-600 text-white font-bold rounded-t-xl flex justify-between">
                <span>Confirmar Dados</span>
                <button onclick="window.closeModal('details-modal')"><i data-lucide="x"></i></button>
            </div>
            <form id="details-form" class="overflow-y-auto p-6 space-y-4 flex-1">
                <div id="agentes-detalhes-container" class="space-y-4"></div>
            </form>
            <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-xl">
                <button type="submit" form="details-form" class="bg-emerald-600 text-white px-8 py-2 rounded-xl font-bold">Salvar Tudo</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- METAS CONFORME IMAGENS ENVIADAS ---
        const SQUADS_ATIVAS = ["SC", "CB", "Rec. Crédito", "OJR", "Monitoria"];
        
        // Mapeamento de metas diárias
        const METAS_POR_DIA = {
            "SC":           { 1: 54, 2: 60, 3: 60, 4: 54, 5: 54, 6: 18, 0: 18 },
            "CB":           { 1: 54, 2: 54, 3: 54, 4: 54, 5: 42, 6: 12, 0: 12 },
            "Rec. Crédito": { 1: 5,  2: 5,  3: 5,  4: 5,  5: 4,  6: 0,  0: 0  },
            "OJR":          { 1: 5,  2: 5,  3: 5,  4: 5,  5: 4,  6: 0,  0: 0  }
        };

        const firebaseConfig = { apiKey: "AIzaSyBgKe2n4c6vL4-B0hSAGT16ELDUQLW0OTQ", authDomain: "atuacao2026.firebaseapp.com", projectId: "atuacao2026", storageBucket: "atuacao2026.firebasestorage.app", messagingSenderId: "563632231622", appId: "1:563632231622:web:ce3e04e43cc647614214f5" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const logsCol = `artifacts/atuacao2026/public/data/scooteiras_atividades`;
        const agentsCol = `artifacts/atuacao2026/public/data/scooteiras_cadastro`;

        let currentAgents = [];
        let currentHistoryList = [];

        // --- LÓGICA DE NORMALIZAÇÃO INTELIGENTE ---
        const normalizarSquad = (s) => {
            if (!s) return "Outro";
            const val = s.toUpperCase().trim();
            if (val.includes("REC") || val.includes("CRED")) return "Rec. Crédito";
            if (val.includes("SC") || val.includes("SPECIAL")) return "SC";
            if (val.includes("CB") || val.includes("BLOQUEADO")) return "CB";
            if (val.includes("OJR") || val.includes("JURIDICO")) return "OJR";
            return s;
        };

        const normalizarDiaSemana = (dia) => {
            const val = dia.toLowerCase().trim();
            if (val.includes("seg")) return 1;
            if (val.includes("ter")) return 2;
            if (val.includes("qua")) return 3;
            if (val.includes("qui")) return 4;
            if (val.includes("sex")) return 5;
            if (val.includes("sab")) return 6;
            if (val.includes("dom")) return 0;
            return null;
        };

        signInAnonymously(auth).then(() => {
            document.getElementById('auth-status').innerText = "ONLINE";
            loadInitialData();
        });

        async function loadInitialData() {
            const d = new Date();
            document.getElementById('mes-select').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            await loadAgents();
            await loadHistorico();
        }

        window.switchTab = (tabId) => {
            ['registro', 'capacidade', 'relatorio', 'cadastro'].forEach(t => {
                const el = document.getElementById(`content-${t}`);
                if(el) el.classList.add('hidden');
                const btn = document.getElementById(`tab-${t}`);
                if(btn) btn.className = "py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap";
            });
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).className = "py-4 px-6 text-sm font-semibold transition-all tab-active whitespace-nowrap";
            if (tabId === 'capacidade') renderCapacityAccordion();
            lucide.createIcons();
        };

        const loadAgents = async () => {
            const snap = await getDocs(collection(db, agentsCol));
            currentAgents = [];
            snap.forEach(d => {
                const a = d.data();
                a.squadPadrao = normalizarSquad(a.squadPadrao);
                currentAgents.push(a);
            });
            renderSelectionList();
        };

        const renderSelectionList = () => {
            document.getElementById('agentes-checkbox-list').innerHTML = currentAgents.map(a => `
                <label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" value="${a.nome}" class="agent-checkbox w-5 h-5 text-indigo-600">
                    <span class="text-sm">${a.nome} <small class="text-gray-400">(${a.squadPadrao})</small></span>
                </label>
            `).join('');
        };

        window.handleEntrySubmission = () => {
            const data = document.getElementById('data-atuacao').value;
            const selected = Array.from(document.querySelectorAll('.agent-checkbox:checked')).map(cb => cb.value);
            if (!data || selected.length === 0) return alert("Selecione data e equipe");

            const container = document.getElementById('agentes-detalhes-container');
            container.innerHTML = selected.map(nome => {
                const agent = currentAgents.find(a => a.nome === nome);
                return `
                    <div class="confirm-row p-4 border rounded-lg bg-white relative" data-nome="${agent.nome}">
                        <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        <div class="font-bold text-indigo-600 mb-2">${agent.nome}</div>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                            <input type="time" value="${agent.entradaPadrao}" class="confirm-ent border p-1 rounded text-sm">
                            <input type="time" value="${agent.saidaPadrao}" class="confirm-sai border p-1 rounded text-sm">
                            <select class="confirm-squad border p-1 rounded text-sm">
                                ${SQUADS_ATIVAS.map(s => `<option value="${s}" ${s === agent.squadPadrao ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                            <input type="text" value="${agent.turnoPadrao}" class="confirm-turno border p-1 rounded text-sm">
                        </div>
                    </div>
                `;
            }).join('');
            window.openModal('details-modal');
            lucide.createIcons();
        };

        document.getElementById('details-form').onsubmit = async (e) => {
            e.preventDefault();
            const dataStr = document.getElementById('data-atuacao').value;
            const rows = document.querySelectorAll('.confirm-row');
            for (const row of rows) {
                const nome = row.dataset.nome;
                const ent = row.querySelector('.confirm-ent').value;
                const sai = row.querySelector('.confirm-sai').value;
                const sq = row.querySelector('.confirm-squad').value;
                const d1 = new Date(`2000-01-01T${ent}`);
                const d2 = new Date(`2000-01-01T${sai}`);
                let diff = (d2 - d1) / 3600000;
                if (diff < 0) diff += 24;

                await addDoc(collection(db, logsCol), {
                    data: dataStr, mes: dataStr.substring(0, 7), scooteira: nome, squad: sq, entrada: ent, saida: sai, horas: parseFloat(diff.toFixed(2)), timestamp: new Date()
                });
            }
            window.closeModal('details-modal');
            loadHistorico();
        };

        window.loadHistorico = async () => {
            const mes = document.getElementById('mes-select').value;
            const q = query(collection(db, logsCol), where("mes", "==", mes));
            const snap = await getDocs(q);
            currentHistoryList = [];
            snap.forEach(d => {
                const item = { id: d.id, ...d.data() };
                item.squad = normalizarSquad(item.squad);
                currentHistoryList.push(item);
            });

            currentHistoryList.sort((a,b) => b.data.localeCompare(a.data) || b.entrada.localeCompare(a.entrada));

            const tbody = document.getElementById('historico-body');
            tbody.innerHTML = currentHistoryList.map(item => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="px-6 py-4"><input type="checkbox" value="${item.id}"></td>
                    <td class="px-6 py-4">${item.data.split('-').reverse().join('/')}</td>
                    <td class="px-6 py-4 font-bold">${item.scooteira.split(' ')[0]}</td>
                    <td class="px-6 py-4 text-gray-400 text-xs">${item.scooteira}</td>
                    <td class="px-6 py-4"><span class="squad-tag text-indigo-600 border-indigo-600">${item.squad}</span></td>
                    <td class="px-6 py-4 text-xs">${item.entrada} - ${item.saida}</td>
                    <td class="px-6 py-4 font-bold text-indigo-600">${item.horas}h</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="window.deleteLog('${item.id}')" class="text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
            updateStats();
        };

        const updateStats = () => {
            const totals = {};
            currentHistoryList.forEach(i => { totals[i.squad] = (totals[i.squad] || 0) + i.horas; });
            document.getElementById('resumo-squads').innerHTML = SQUADS_ATIVAS.map(s => `
                <div class="bg-white p-4 rounded-xl border-t-4 border-indigo-500 shadow-sm">
                    <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">${s}</div>
                    <div class="text-xl font-bold">${(totals[s] || 0).toFixed(1)}h</div>
                </div>
            `).join('');
        };

        const renderCapacityAccordion = () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;
            const [ano, mesNum] = mes.split('-').map(Number);
            const container = document.getElementById('capacity-accordion-container');
            container.innerHTML = "";

            const dataMap = {};
            currentHistoryList.forEach(log => {
                if(!dataMap[log.data]) dataMap[log.data] = {};
                dataMap[log.data][log.squad] = (dataMap[log.data][log.squad] || 0) + log.horas;
            });

            const weeks = {};
            const firstDay = new Date(ano, mesNum - 1, 1);
            const lastDay = new Date(ano, mesNum, 0);

            for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                const dateClone = new Date(d);
                const wNum = getISOWeek(dateClone);
                if (!weeks[wNum]) weeks[wNum] = [];
                weeks[wNum].push(new Date(dateClone));
            }

            Object.keys(weeks).forEach(wNum => {
                const days = weeks[wNum];
                const weekId = `week-${wNum}`;
                const weekSquadTotals = {};
                days.forEach(dateObj => {
                    const dateKey = dateObj.toISOString().split('T')[0];
                    if (dataMap[dateKey]) {
                        Object.keys(dataMap[dateKey]).forEach(sq => {
                            weekSquadTotals[sq] = (weekSquadTotals[sq] || 0) + dataMap[dateKey][sq];
                        });
                    }
                });

                const header = document.createElement('div');
                header.className = "week-group-header shadow-sm";
                header.innerHTML = `
                    <div class="flex justify-between items-center w-full">
                        <div class="flex flex-col">
                            <span class="font-bold text-indigo-700">Semana ${wNum}</span>
                            <span class="text-[10px] text-gray-400">${days[0].toLocaleDateString('pt-BR', {day:'2-digit', month:'short'})} a ${days[days.length-1].toLocaleDateString('pt-BR', {day:'2-digit', month:'short'})}</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${SQUADS_ATIVAS.filter(s => s !== 'Monitoria').map(s => `
                                <span class="squad-tag border-indigo-400 text-indigo-700 text-[10px]">${s}: ${(weekSquadTotals[s] || 0).toFixed(1)}h</span>
                            `).join('')}
                        </div>
                    </div>
                `;
                header.onclick = () => document.getElementById(weekId).classList.toggle('active');

                const content = document.createElement('div');
                content.id = weekId;
                content.className = "week-content";

                let tableHtml = `<table class="w-full"><thead><tr><th class="cap-header text-left">Dia</th>`;
                SQUADS_ATIVAS.forEach(s => tableHtml += `<th class="cap-header">${s}</th>`);
                tableHtml += `</tr></thead><tbody>`;

                days.forEach(dateObj => {
                    const dateKey = dateObj.toISOString().split('T')[0];
                    const dow = dateObj.getDay();
                    const dayLabel = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });

                    tableHtml += `<tr><td class="cap-cell font-bold bg-gray-50 text-left px-4">${dayLabel}</td>`;
                    SQUADS_ATIVAS.forEach(squad => {
                        const actual = (dataMap[dateKey] && dataMap[dateKey][squad]) ? dataMap[dateKey][squad] : 0;
                        let cellClass = "cap-cell";
                        let valText = actual > 0 ? actual.toFixed(1) + 'h' : '-';
                        let subText = "";

                        if (squad !== "Monitoria") {
                            const target = (METAS_POR_DIA[squad] && METAS_POR_DIA[squad][dow]) ? METAS_POR_DIA[squad][dow] : 0;
                            if (target > 0) {
                                if (actual < target) {
                                    cellClass += " cap-warn-low";
                                    subText = `<div class="text-[9px] opacity-60">-${(target - actual).toFixed(1)}</div>`;
                                } else if (actual > target) {
                                    cellClass += " cap-warn-high";
                                    subText = `<div class="text-[9px] opacity-60">+${(actual - target).toFixed(1)}</div>`;
                                } else {
                                    cellClass += " cap-ok";
                                }
                            }
                        }
                        tableHtml += `<td class="${cellClass}">${valText}${subText}</td>`;
                    });
                    tableHtml += `</tr>`;
                });

                content.innerHTML = tableHtml + `</tbody></table>`;
                container.appendChild(header);
                container.appendChild(content);
            });
        };

        function getISOWeek(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.deleteLog = async (id) => { if(confirm("Excluir?")) { await deleteDoc(doc(db, logsCol, id)); loadHistorico(); } };
    </script>
</body>
</html>
