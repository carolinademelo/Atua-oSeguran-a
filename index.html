<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Atuaﾃｧﾃ｣o - Scooto</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>峽</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; color: #334155; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Capacidade Estilos */
        .cap-cell { font-size: 0.75rem; padding: 8px; text-align: center; border: 1px solid #e2e8f0; }
        .cap-header { font-size: 0.75rem; font-weight: 700; background-color: #f8fafc; padding: 10px; border: 1px solid #e2e8f0; color: #64748b; }
        .cap-warn-low { background-color: #fee2e2; color: #991b1b; font-weight: 600; }
        .cap-warn-high { background-color: #ffedd5; color: #9a3412; font-weight: 600; }
        .cap-ok { background-color: #dcfce7; color: #166534; }
        .week-group-header { cursor: pointer; background: #4f46e5; color: white; padding: 12px; border-radius: 8px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .week-group-header:hover { background: #4338ca; }
        .week-content { display: none; margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 0 0 8px 8px; overflow: hidden; }
        .week-content.active { display: block; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8 pb-24">

    <div id="app" class="w-full max-w-full sm:max-w-7xl bg-white rounded-2xl shadow-xl overflow-hidden relative">

        <header class="bg-indigo-600 p-6 sm:p-10 text-white">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight">Dash Atuaﾃｧﾃ｣o - Scooto</h1>
                    <p class="text-indigo-100 text-sm mt-1">Gestﾃ｣o de Capacity e Squads</p>
                </div>
                <div id="auth-status" class="bg-indigo-800 py-1 px-3 rounded text-xs font-mono">Conectando...</div>
            </div>
        </header>

        <div class="flex border-b border-gray-200 bg-gray-50 px-6 overflow-x-auto">
            <button id="tab-registro" class="py-4 px-6 text-sm font-semibold transition-all tab-active whitespace-nowrap" onclick="window.switchTab('registro')">Registro Diﾃ｡rio</button>
            <button id="tab-capacidade" class="py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('capacidade')">Capacidade & Metas</button>
            <button id="tab-relatorio" class="py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('relatorio')">Relatﾃｳrios</button>
            <button id="tab-cadastro" class="py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('cadastro')">Equipe</button>
        </div>

        <div id="message-box" class="hidden mx-6 mt-6 p-4 text-sm rounded-lg shadow-sm border-l-4"></div>

        <div class="p-6 sm:p-8 min-h-[500px]">

            <div id="content-registro" class="animate-fade-in">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-3">
                            <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Data</label>
                            <input type="date" id="data-atuacao" class="w-full p-2.5 border-gray-300 rounded-lg text-sm">
                        </div>
                        <div class="md:col-span-6">
                            <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Scooteiras</label>
                            <button onclick="window.showSelectionModal()" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-left text-sm flex justify-between">
                                <span>Selecionar equipe...</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="md:col-span-3">
                            <button onclick="window.handleEntrySubmission()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg font-bold">Registrar</button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Lanﾃｧamentos</h2>
                    <input type="month" id="mes-select" onchange="window.loadHistorico()" class="border-gray-300 rounded-md text-sm">
                </div>

                <div id="resumo-squads" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8"></div>

                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3"><input type="checkbox" id="select-all-history" onclick="window.toggleSelectAll()"></th>
                                <th class="px-6 py-3">Data</th>
                                <th class="px-6 py-3">Nome</th>
                                <th class="px-6 py-3">Squad</th>
                                <th class="px-6 py-3">Horﾃ｡rio</th>
                                <th class="px-6 py-3">Total</th>
                                <th class="px-6 py-3 text-right">Aﾃｧﾃｵes</th>
                            </tr>
                        </thead>
                        <tbody id="historico-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-capacidade" class="hidden animate-fade-in">
                <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Anﾃ｡lise de Capacidade por Semana</h2>
                    <p class="text-xs text-gray-500">Clique na semana para expandir os dias</p>
                </div>
                <div id="capacity-accordion-container" class="space-y-4">
                    </div>
            </div>

            <div id="content-relatorio" class="hidden animate-fade-in"> Conteﾃｺdo de Relatﾃｳrios... </div>
            <div id="content-cadastro" class="hidden animate-fade-in">
                 <div id="cadastro-form-container"></div>
                 <table class="w-full mt-8 text-sm"><tbody id="cadastro-list-body"></tbody></table>
            </div>
        </div>
    </div>

    <div id="selection-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6">
            <h3 class="font-bold mb-4">Selecionar Equipe</h3>
            <div id="agentes-checkbox-list" class="space-y-2 max-h-96 overflow-y-auto mb-4"></div>
            <button onclick="window.closeModal('selection-modal')" class="w-full bg-indigo-600 text-white py-2 rounded-lg">Fechar</button>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="p-6 bg-indigo-600 text-white font-bold rounded-t-xl">Ajuste de Detalhes</div>
            <form id="details-form" class="overflow-y-auto p-6 space-y-4 flex-1">
                <div id="agentes-detalhes-container" class="space-y-4"></div>
            </form>
            <div class="p-4 bg-gray-50 flex justify-end space-x-3 rounded-b-xl">
                <button onclick="window.closeModal('details-modal')" class="px-4 py-2">Cancelar</button>
                <button type="submit" form="details-form" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold">Salvar Tudo</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs, deleteDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAﾃﾃグ DE SQUADS ---
        const SQUADS_ATIVAS = ["CB", "SC", "Rec. Crﾃｩdito", "Monitoria", "OJR"];
        
        // --- METAS DIFERENCIADAS POR DIA ---
        // 0: Dom, 1: Seg, 2: Ter, 3: Qua, 4: Qui, 5: Sex, 6: Sab
        const METAS_POR_DIA = {
            "CB":           { 1: 50, 2: 50, 3: 50, 4: 50, 5: 50, 6: 20, 0: 10 },
            "SC":           { 1: 40, 2: 40, 3: 40, 4: 40, 5: 40, 6: 15, 0: 5  },
            "Rec. Crﾃｩdito": { 1: 30, 2: 30, 3: 30, 4: 30, 5: 30, 6: 0,  0: 0  },
            "OJR":          { 1: 10, 2: 10, 3: 10, 4: 10, 5: 10, 6: 5,  0: 0  }
            // Monitoria nﾃ｣o tem meta (calcula apenas soma)
        };

        const firebaseConfig = { apiKey: "AIzaSyBgKe2n4c6vL4-B0hSAGT16ELDUQLW0OTQ", authDomain: "atuacao2026.firebaseapp.com", projectId: "atuacao2026", storageBucket: "atuacao2026.firebasestorage.app", messagingSenderId: "563632231622", appId: "1:563632231622:web:ce3e04e43cc647614214f5" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "atuacao2026";
        const logsCol = `artifacts/${appId}/public/data/scooteiras_atividades`;
        const agentsCol = `artifacts/${appId}/public/data/scooteiras_cadastro`;

        let currentAgents = [];
        let currentHistoryList = [];

        // --- UNIFICAﾃﾃグ DE SQUAD (REC) ---
        const normalizarSquad = (s) => {
            if (!s) return "Outro";
            const upper = s.toUpperCase().trim();
            if (upper.includes("REC") || upper.includes("CRED")) return "Rec. Crﾃｩdito";
            return s;
        };

        // --- FIREBASE INIT ---
        signInAnonymously(auth).then(() => {
            document.getElementById('auth-status').innerText = "ONLINE";
            document.getElementById('auth-status').className = "bg-emerald-600 py-1 px-3 rounded text-xs font-mono text-white";
            loadInitialData();
        });

        async function loadInitialData() {
            const d = new Date();
            document.getElementById('mes-select').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            await loadAgents();
            await loadHistorico();
        }

        window.switchTab = (tabId) => {
            ['registro', 'capacidade', 'relatorio', 'cadastro'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).className = "py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap";
            });
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).className = "py-4 px-6 text-sm font-semibold transition-all tab-active whitespace-nowrap";
            if (tabId === 'capacidade') renderCapacityAccordion();
        };

        const loadAgents = async () => {
            const snap = await getDocs(collection(db, agentsCol));
            currentAgents = [];
            snap.forEach(d => {
                const a = d.data();
                a.squadPadrao = normalizarSquad(a.squadPadrao);
                if (SQUADS_ATIVAS.includes(a.squadPadrao)) currentAgents.push(a);
            });
            renderSelectionList();
        };

        const renderSelectionList = () => {
            currentAgents.sort((a,b) => a.nome.localeCompare(b.nome));
            document.getElementById('agentes-checkbox-list').innerHTML = currentAgents.map(a => `
                <label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" value="${a.nome}" class="agent-checkbox w-5 h-5 text-indigo-600">
                    <span class="text-sm">${a.nome} <small class="text-gray-400">(${a.squadPadrao})</small></span>
                </label>
            `).join('');
        };

        window.handleEntrySubmission = () => {
            const data = document.getElementById('data-atuacao').value;
            const selected = Array.from(document.querySelectorAll('.agent-checkbox:checked')).map(cb => cb.value);
            if (!data || selected.length === 0) return alert("Selecione data e equipe");

            const container = document.getElementById('agentes-detalhes-container');
            container.innerHTML = selected.map(nome => {
                const agent = currentAgents.find(a => a.nome === nome);
                return `
                    <div class="confirm-row p-4 border rounded-lg bg-white relative" data-nome="${agent.nome}">
                        <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        <div class="font-bold text-indigo-600 mb-3">${agent.nome}</div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <input type="time" value="${agent.entradaPadrao}" class="confirm-ent border p-1 rounded text-sm">
                            <input type="time" value="${agent.saidaPadrao}" class="confirm-sai border p-1 rounded text-sm">
                            <select class="confirm-squad border p-1 rounded text-sm">
                                ${SQUADS_ATIVAS.map(s => `<option value="${s}" ${s === agent.squadPadrao ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                            <input type="text" value="${agent.turnoPadrao}" class="confirm-turno border p-1 rounded text-sm">
                        </div>
                    </div>
                `;
            }).join('');
            window.openModal('details-modal');
            lucide.createIcons();
        };

        document.getElementById('details-form').onsubmit = async (e) => {
            e.preventDefault();
            const dataStr = document.getElementById('data-atuacao').value;
            const rows = document.querySelectorAll('.confirm-row');
            
            for (const row of rows) {
                const nome = row.dataset.nome;
                const ent = row.querySelector('.confirm-ent').value;
                const sai = row.querySelector('.confirm-sai').value;
                const sq = row.querySelector('.confirm-squad').value;
                
                const d1 = new Date(`2000-01-01T${ent}`);
                const d2 = new Date(`2000-01-01T${sai}`);
                let diff = (d2 - d1) / 3600000;
                if (diff < 0) diff += 24;

                await addDoc(collection(db, logsCol), {
                    data: dataStr,
                    mes: dataStr.substring(0, 7),
                    scooteira: nome,
                    squad: sq,
                    entrada: ent,
                    saida: sai,
                    horas: parseFloat(diff.toFixed(2)),
                    timestamp: new Date()
                });
            }
            window.closeModal('details-modal');
            loadHistorico();
        };

        window.loadHistorico = async () => {
            const mes = document.getElementById('mes-select').value;
            const q = query(collection(db, logsCol), where("mes", "==", mes));
            const snap = await getDocs(q);
            currentHistoryList = [];
            snap.forEach(d => {
                const item = { id: d.id, ...d.data() };
                item.squad = normalizarSquad(item.squad);
                if (SQUADS_ATIVAS.includes(item.squad)) currentHistoryList.push(item);
            });

            // --- ORDENAﾃﾃグ SOLICITADA ---
            // 1. Data (Desc), 2. Entrada (Desc), 3. Squad (Asc), 4. Nome (Asc)
            currentHistoryList.sort((a,b) => {
                if (b.data !== a.data) return b.data.localeCompare(a.data);
                if (b.entrada !== a.entrada) return b.entrada.localeCompare(a.entrada);
                if (a.squad !== b.squad) return a.squad.localeCompare(b.squad);
                return a.scooteira.localeCompare(b.scooteira);
            });

            const tbody = document.getElementById('historico-body');
            tbody.innerHTML = currentHistoryList.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4"><input type="checkbox" value="${item.id}" class="history-checkbox"></td>
                    <td class="px-6 py-4">${item.data.split('-').reverse().join('/')}</td>
                    <td class="px-6 py-4 font-bold">${item.scooteira.split(' ')[0]}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded-full bg-indigo-50 text-indigo-600 text-xs font-bold">${item.squad}</span></td>
                    <td class="px-6 py-4 text-xs">${item.entrada} - ${item.saida}</td>
                    <td class="px-6 py-4 font-bold">${item.horas}h</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="window.deleteLog('${item.id}')" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
            updateStats();
        };

        const updateStats = () => {
            const totals = {};
            currentHistoryList.forEach(i => { totals[i.squad] = (totals[i.squad] || 0) + i.horas; });
            document.getElementById('resumo-squads').innerHTML = Object.keys(totals).map(s => `
                <div class="bg-white p-4 rounded-xl border-l-4 border-indigo-500 shadow-sm">
                    <div class="text-xs text-gray-500 uppercase font-bold">${s}</div>
                    <div class="text-2xl font-bold">${totals[s].toFixed(1)}h</div>
                </div>
            `).join('');
        };

        // --- Lﾃ敵ICA DO ACORDEﾃグ DE CAPACIDADE ---
        const renderCapacityAccordion = () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;
            const [ano, mesNum] = mes.split('-').map(Number);
            const daysInMonth = new Date(ano, mesNum, 0).getDate();
            const container = document.getElementById('capacity-accordion-container');
            container.innerHTML = "";

            // Organiza dados por Data
            const dataMap = {};
            currentHistoryList.forEach(log => {
                if(!dataMap[log.data]) dataMap[log.data] = {};
                dataMap[log.data][log.squad] = (dataMap[log.data][log.squad] || 0) + log.horas;
            });

            // Agrupa por Semanas
            const weeks = {};
            for (let i = 1; i <= daysInMonth; i++) {
                const dateObj = new Date(ano, mesNum - 1, i);
                const weekNum = getWeekOfMonth(dateObj);
                if (!weeks[weekNum]) weeks[weekNum] = [];
                weeks[weekNum].push(i);
            }

            Object.keys(weeks).forEach(wNum => {
                const days = weeks[wNum];
                const weekId = `week-${wNum}`;
                
                // Calcula Total da Semana
                let weekTotalHours = 0;
                days.forEach(d => {
                    const dateKey = `${mes}-${String(d).padStart(2,'0')}`;
                    if (dataMap[dateKey]) {
                        Object.values(dataMap[dateKey]).forEach(h => weekTotalHours += h);
                    }
                });

                // Cabeﾃｧalho do Acordeﾃ｣o
                const header = document.createElement('div');
                header.className = "week-group-header";
                header.innerHTML = `<span>Semana ${wNum}</span> <span class="text-sm font-normal">Total: ${weekTotalHours.toFixed(1)}h</span>`;
                header.onclick = () => {
                    document.getElementById(weekId).classList.toggle('active');
                };

                // Conteﾃｺdo da Tabela
                const content = document.createElement('div');
                content.id = weekId;
                content.className = "week-content";

                let tableHtml = `<table class="w-full border-collapse"><thead><tr><th class="cap-header text-left">Dia</th>`;
                SQUADS_ATIVAS.forEach(s => tableHtml += `<th class="cap-header">${s}</th>`);
                tableHtml += `</tr></thead><tbody>`;

                days.forEach(day => {
                    const dayStr = String(day).padStart(2,'0');
                    const fullDate = `${mes}-${dayStr}`;
                    const dateObj = new Date(ano, mesNum - 1, day);
                    const dow = dateObj.getDay();

                    tableHtml += `<tr><td class="cap-cell cap-date-col font-bold">${dayStr}/${mesNum}</td>`;
                    
                    SQUADS_ATIVAS.forEach(squad => {
                        const actual = (dataMap[fullDate] && dataMap[fullDate][squad]) ? dataMap[fullDate][squad] : 0;
                        let cellClass = "cap-cell";
                        let content = actual > 0 ? actual.toFixed(1) + 'h' : '-';

                        // Apenas valida se nﾃ｣o for Monitoria
                        if (squad !== "Monitoria") {
                            const target = (METAS_POR_DIA[squad] && METAS_POR_DIA[squad][dow]) ? METAS_POR_DIA[squad][dow] : 0;
                            if (target > 0) {
                                if (actual < target) cellClass += " cap-warn-low";
                                else if (actual > target) cellClass += " cap-warn-high";
                                else cellClass += " cap-ok";
                            }
                        }

                        tableHtml += `<td class="${cellClass}">${content}</td>`;
                    });
                    tableHtml += `</tr>`;
                });

                tableHtml += `</tbody></table>`;
                content.innerHTML = tableHtml;

                container.appendChild(header);
                container.appendChild(content);
            });
        };

        function getWeekOfMonth(date) {
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            return Math.ceil((date.getDate() + firstDay) / 7);
        }

        // Helpers de Janela
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.deleteLog = async (id) => { if(confirm("Excluir?")) { await deleteDoc(doc(db, logsCol, id)); loadHistorico(); } };

    </script>
</body>
</html>
