 <!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Atua√ß√£o - Scooto</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõµ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; color: #334155; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #334155; border-bottom: 2px solid #cbd5e1; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Floating Action Bar Animation */
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8 pb-24">

    <div id="app" class="w-full max-w-6xl bg-white rounded-2xl shadow-xl overflow-hidden relative">

        <header class="bg-indigo-600 p-6 sm:p-10 text-white">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight">Dash Atua√ß√£o - Scooto</h1>
                    <p class="text-indigo-100 text-sm mt-1">Controle de Squads e Scooteiras</p>
                </div>
                <div class="hidden md:block text-right">
                    <p id="auth-status" class="text-xs text-indigo-200 font-mono bg-indigo-800 py-1 px-2 rounded">Conectando...</p>
                </div>
            </div>
        </header>

        <div class="flex border-b border-gray-200 bg-gray-50 px-6 overflow-x-auto">
            <button id="tab-registro" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-active whitespace-nowrap" onclick="window.switchTab('registro')">
                <span class="flex items-center"><i data-lucide="calendar-check" class="w-4 h-4 mr-2"></i> Registro Di√°rio</span>
            </button>
            <button id="tab-relatorio" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('relatorio')">
                <span class="flex items-center"><i data-lucide="bar-chart-3" class="w-4 h-4 mr-2"></i> Relat√≥rios</span>
            </button>
            <button id="tab-cadastro" class="py-4 px-6 text-sm font-semibold focus:outline-none transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('cadastro')">
                <span class="flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i> Equipe</span>
            </button>
        </div>

        <div id="message-box" class="hidden mx-6 mt-6 p-4 text-sm rounded-lg shadow-sm border-l-4 transition-all" role="alert"></div>

        <div class="p-6 sm:p-8 min-h-[500px]">

            <div id="content-registro" class="animate-fade-in">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6 mb-8 shadow-sm">
                    <h2 class="text-lg font-semibold text-indigo-900 mb-4 flex items-center">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Novo Lan√ßamento
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-3">
                            <label class="block text-xs font-medium text-gray-600 mb-1 uppercase tracking-wide">Data</label>
                            <input type="date" id="data-atuacao" class="w-full p-2.5 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        </div>
                        <div class="md:col-span-6">
                            <label class="block text-xs font-medium text-gray-600 mb-1 uppercase tracking-wide">Scooteira(s)</label>
                            <input type="hidden" id="selected-agents-input">
                            <button type="button" id="agentes-selection-display" onclick="window.showSelectionModal()" 
                                    class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-left text-gray-500 hover:border-indigo-400 transition shadow-sm flex items-center justify-between text-sm">
                                <span>Clique para selecionar...</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="md:col-span-3">
                            <button id="btn-registrar" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 px-4 rounded-lg font-medium shadow-md transition flex items-center justify-center" onclick="window.handleEntrySubmission()">
                                <span>Registrar</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-800">Hist√≥rico Mensal</h2>
                    <div class="flex items-center space-x-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <label for="mes-select" class="text-sm font-medium text-gray-600">M√™s:</label>
                        <input type="month" id="mes-select" class="bg-white border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500 py-1" onchange="window.loadHistorico()">
                        <div class="h-4 w-px bg-gray-300 mx-2"></div>
                        <button class="text-gray-600 hover:text-indigo-600 text-sm font-medium flex items-center transition" onclick="window.exportToCsv()">
                             <i data-lucide="download" class="w-4 h-4 mr-1"></i> CSV
                        </button>
                        <button class="text-gray-600 hover:text-blue-600 text-sm font-medium flex items-center transition ml-3" onclick="window.showImportModal()">
                             <i data-lucide="upload" class="w-4 h-4 mr-1"></i> Importar
                        </button>
                    </div>
                </div>

                <div class="flex justify-end mb-4">
                      <button onclick="window.analyzeMonthlyData()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition flex items-center">
                        <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i> Analisar M√™s
                    </button>
                </div>

                <div id="resumo-squads" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>

                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200 mb-12">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-3 w-4">
                                    <input type="checkbox" id="select-all-history" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" onclick="window.toggleSelectAll()">
                                </th>
                                <th class="px-6 py-3 font-medium">Data</th>
                                <th class="px-6 py-3 font-medium">Scooteira</th>
                                <th class="px-6 py-3 font-medium">Squad</th>
                                <th class="px-6 py-3 font-medium">Entrada</th>
                                <th class="px-6 py-3 font-medium">Sa√≠da</th>
                                <th class="px-6 py-3 font-medium">Dura√ß√£o</th>
                                <th class="px-6 py-3 font-medium">Turno</th>
                                <th class="px-6 py-3 font-medium text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="historico-body" class="divide-y divide-gray-100">
                            <tr><td colspan="9" class="text-center py-8 text-gray-400">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="content-relatorio" class="hidden animate-fade-in">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Relat√≥rio Individual</h2>
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Scooteira</label>
                            <select id="relatorio-agente-select" class="w-full p-2.5 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="window.loadRelatorioIndividual()">
                                <option value="" disabled selected>Selecione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">M√™s</label>
                            <input type="month" id="relatorio-mes-select" class="w-full p-2.5 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="window.loadRelatorioIndividual()">
                        </div>
                        <div class="flex items-end space-x-2">
                             <button class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 px-4 rounded-lg font-medium shadow-sm transition flex items-center justify-center" onclick="window.exportIndividualCsv()">
                                 <i data-lucide="file-down" class="w-4 h-4 mr-2"></i> CSV
                             </button>
                             <button onclick="window.analyzeIndividualData()" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white py-2.5 px-4 rounded-lg font-medium shadow-sm transition flex items-center justify-center">
                                <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i> Insights
                            </button>
                        </div>
                    </div>
                </div>
                <div id="relatorio-resumo-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 hidden">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                        <span class="text-xs text-gray-500 uppercase font-medium">Dias Trabalhados</span>
                        <span class="text-3xl font-bold text-gray-800 mt-1" id="resumo-total-dias">-</span>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col">
                        <span class="text-xs text-gray-500 uppercase font-medium">Total de Horas</span>
                        <span class="text-3xl font-bold text-indigo-600 mt-1" id="resumo-total-horas">-</span>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col lg:col-span-2">
                        <span class="text-xs text-gray-500 uppercase font-medium mb-2">Horas por Squad</span>
                        <div id="resumo-squads-list" class="flex flex-wrap gap-2 mt-auto"></div>
                    </div>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-3 font-medium">Data</th>
                                <th class="px-6 py-3 font-medium">Squad</th>
                                <th class="px-6 py-3 font-medium">Entrada</th>
                                <th class="px-6 py-3 font-medium">Sa√≠da</th>
                                <th class="px-6 py-3 font-medium">Dura√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="relatorio-body" class="divide-y divide-gray-100">
                            <tr><td colspan="5" class="text-center py-8 text-gray-400">Selecione os filtros acima.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="content-cadastro" class="hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Equipe Cadastrada</h2>
                    <button onclick="window.seedDatabase()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium text-xs flex items-center shadow-sm">
                        <i data-lucide="refresh-cw" class="w-3 h-3 mr-2"></i> For√ßar Atualiza√ß√£o
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-8">
                    <h3 class="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wide border-b pb-2">Adicionar Nova Scooteira</h3>
                    <form id="add-agent-form" class="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Nome Completo</label>
                            <input type="text" id="new-nome" placeholder="Nome Completo" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Pseudo (Apelido)</label>
                            <input type="text" id="new-pseudo" placeholder="Ex: Ana C." class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Squad Padr√£o</label>
                            <select id="new-squad" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm">
                                </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-gray-500 mb-1">Dias Padr√£o</label>
                            <input type="text" id="new-turno" placeholder="Ex: Seg-Sex" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Entrada</label>
                            <input type="time" id="new-entrada" value="08:00" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Sa√≠da</label>
                            <input type="time" id="new-saida" value="14:00" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 text-sm" required>
                        </div>
                        <div class="md:col-span-6 flex justify-end mt-2">
                            <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-6 rounded-lg font-medium shadow-sm transition text-sm">
                                 + Adicionar
                            </button>
                        </div>
                    </form>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-3 font-medium">Nome (Pseudo)</th>
                                <th class="px-6 py-3 font-medium">Squad</th>
                                <th class="px-6 py-3 font-medium">Dias</th>
                                <th class="px-6 py-3 font-medium">Hor√°rio</th>
                                <th class="px-6 py-3 font-medium text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="cadastro-list-body" class="divide-y divide-gray-100">
                            <tr><td colspan="5" class="text-center py-8 text-gray-400">Carregando equipe...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="bulk-actions-bar" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-xl shadow-2xl flex items-center space-x-6 z-40 hidden slide-up">
        <span class="text-sm font-medium"><span id="bulk-count">0</span> selecionados</span>
        <div class="h-4 w-px bg-gray-600"></div>
        <button class="flex items-center space-x-2 text-indigo-300 hover:text-white transition" onclick="window.openBulkEditModal()">
            <i data-lucide="pencil" class="w-4 h-4"></i>
            <span class="text-sm font-medium">Editar Selecionados</span>
        </button>
        <button class="flex items-center space-x-2 text-red-400 hover:text-red-200 transition" onclick="window.deleteBulkLogs()">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            <span class="text-sm font-medium">Excluir</span>
        </button>
        <button class="ml-4 text-gray-500 hover:text-gray-300" onclick="window.deselectAll()">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>

    <div id="bulk-edit-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-indigo-600 px-6 py-4 text-white">
                <h3 class="text-lg font-bold">Edi√ß√£o em Massa</h3>
                <p class="text-indigo-100 text-xs mt-1">Preencha APENAS o que deseja alterar. O que ficar vazio ser√° mantido.</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs uppercase text-gray-500 mb-1">Nova Data (Opcional)</label>
                    <input type="date" id="be-data" class="w-full p-2 border rounded bg-gray-50">
                </div>
                <div>
                    <label class="block text-xs uppercase text-gray-500 mb-1">Novo Squad (Opcional)</label>
                    <select id="be-squad" class="w-full p-2 border rounded bg-gray-50">
                        <option value="">-- Manter Original --</option>
                        </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase text-gray-500 mb-1">Nova Entrada</label>
                        <input type="time" id="be-ent" class="w-full p-2 border rounded bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-xs uppercase text-gray-500 mb-1">Nova Sa√≠da</label>
                        <input type="time" id="be-sai" class="w-full p-2 border rounded bg-gray-50">
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                <button class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded" onclick="window.closeModal('bulk-edit-modal')">Cancelar</button>
                <button class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700" onclick="window.confirmBulkEdit()">Aplicar Mudan√ßas</button>
            </div>
        </div>
    </div>

    <div id="selection-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800">Selecionar Scooteiras</h3>
                <button onclick="window.closeModal('selection-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="agentes-checkbox-list" class="p-4 space-y-2 max-h-[60vh] overflow-y-auto"></div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end">
                <button class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg font-medium text-sm" onclick="window.closeModal('selection-modal')">Conclu√≠do</button>
            </div>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col">
            <div class="bg-indigo-600 px-6 py-4 text-white">
                <h3 class="text-lg font-bold">Ajuste de Detalhes</h3>
                <p class="text-indigo-100 text-xs mt-1">Confirme os hor√°rios para cada scooteira selecionada.</p>
            </div>
            <form id="details-form" class="flex-1 overflow-hidden flex flex-col">
                <div id="agentes-detalhes-container" class="p-6 space-y-6 overflow-y-auto flex-1"></div>
                <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                    <button type="button" class="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition" onclick="window.closeModal('details-modal')">Cancelar</button>
                    <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-sm transition">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-log-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-blue-600 px-6 py-4 text-white flex justify-between">
                <h3 class="text-lg font-bold">Editar Registro</h3>
                <button onclick="window.closeModal('edit-log-modal')" class="text-blue-100 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-log-id">
                <div>
                    <label class="block text-xs uppercase text-gray-500 mb-1">Scooteira</label>
                    <input id="edit-log-nome" class="w-full p-2 border bg-gray-100 rounded text-gray-500" disabled>
                </div>
                <div>
                    <label class="block text-xs uppercase text-gray-500 mb-1">Data</label>
                    <input type="date" id="edit-log-data" class="w-full p-2 border rounded">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase text-gray-500 mb-1">Entrada</label>
                        <input type="time" id="edit-log-ent" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-xs uppercase text-gray-500 mb-1">Sa√≠da</label>
                        <input type="time" id="edit-log-sai" class="w-full p-2 border rounded">
                    </div>
                </div>
                <div>
                    <label class="block text-xs uppercase text-gray-500 mb-1">Squad</label>
                    <input type="text" id="edit-log-squad" class="w-full p-2 border rounded">
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                <button class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded" onclick="window.closeModal('edit-log-modal')">Cancelar</button>
                <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="window.saveEditedLog()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl overflow-hidden">
             <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800 flex items-center"><i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2 text-blue-600"></i> Importar do Excel</h3>
                <button onclick="window.closeModal('import-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-2">Cole os dados copiados diretamente da planilha (com cabe√ßalho ou sem):</p>
                <textarea id="import-data-json" rows="10" class="w-full p-4 border border-gray-300 rounded-lg font-mono text-xs bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Data	Email	Pseudo	Turno	In√≠cio	Fim...&#10;01/12/2025	email@scooto	Nome	Meu Turno	08:00	14:00..."></textarea>
                <p class="text-xs text-gray-400 mt-2">O sistema corrige automaticamente hor√°rios como '8:00:00' para '08:00'.</p>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                 <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-sm transition" onclick="window.handleImport()">Processar Dados</button>
            </div>
        </div>
    </div>

    <div id="ai-analysis-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[80vh] flex flex-col">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold flex items-center"><i data-lucide="bot" class="w-5 h-5 mr-2"></i> An√°lise</h3>
                <button onclick="window.closeModal('ai-analysis-modal')" class="text-purple-100 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 overflow-y-auto flex-1 prose prose-sm max-w-none text-gray-700 leading-relaxed" id="ai-analysis-content"></div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center">
            <h3 class="text-lg font-bold text-gray-900 mb-2">Confirmar Exclus√£o?</h3>
            <p class="text-sm text-gray-500 mb-6">Essa a√ß√£o n√£o pode ser desfeita.</p>
            <div class="flex justify-center space-x-3">
                <button class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50" onclick="window.resolveConfirmation(false)">Cancelar</button>
                <button class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700" onclick="window.resolveConfirmation(true)">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs, onSnapshot, deleteDoc, updateDoc, addDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // CONFIGURA√á√ÉO
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBgKe2n4c6vL4-B0hSAGT16ELDUQLW0OTQ",
            authDomain: "atuacao2026.firebaseapp.com",
            projectId: "atuacao2026",
            storageBucket: "atuacao2026.firebasestorage.app",
            messagingSenderId: "563632231622",
            appId: "1:563632231622:web:ce3e04e43cc647614214f5"
        };
        const appId = "atuacao2026";
        
        const SQUADS_OPCOES = ["CB", "SC", "Rec. Cr√©dito", "Monitoria", "Coraliados", "Hunter", "Vendas", "OJR", "Outro"];
        
        // Mock data omitted for brevity as it's the same as before, but exists in code logic
        const MOCK_CADASTROS = [
            { nome: "J√©ssica Zanquettin", pseudo: "Celina Z", squadPadrao: "CB", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00" },
            { nome: "La√≠s Cristine dos Reis", pseudo: "Malu R", squadPadrao: "CB", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00" },
            { nome: "Renata Mendes Valentim", pseudo: "Luara M", squadPadrao: "CB", turnoPadrao: "Seg √† Qui. e S√°b.", entradaPadrao: "09:00", saidaPadrao: "15:00" },
            { nome: "Juliana da Silva Sfair", pseudo: "L√≥ri S", squadPadrao: "CB", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "10:00", saidaPadrao: "16:00" },
            { nome: "Raylla Caroline Fernandes Santos", pseudo: "Teresa S.", squadPadrao: "CB", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "10:00", saidaPadrao: "16:00" },
            { nome: "Barbara Santos De Souza Moreira", pseudo: "Nara M", squadPadrao: "CB", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00" },
            { nome: "Viviane Santiago de Oliveira", pseudo: "Menna S.", squadPadrao: "CB", turnoPadrao: "Seg √† Qui. e Dom.", entradaPadrao: "14:00", saidaPadrao: "20:00" },
            { nome: "Adriana Yurie Becker de Carvalho Chino", pseudo: "Diana C.", squadPadrao: "CB", turnoPadrao: "Dom. √† Quar.", entradaPadrao: "16:00", saidaPadrao: "22:00" },
            { nome: "Lissandra Pereira da Frota", pseudo: "Aurora P.", squadPadrao: "CB", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "16:00", saidaPadrao: "22:00" },
            { nome: "Janaina Gonzaga Fioravante", pseudo: "Solar F.", squadPadrao: "CB", turnoPadrao: "Quin. √† S√°b.", entradaPadrao: "16:00", saidaPadrao: "22:00" },
            { nome: "Gizele Uglar Leite Lima", pseudo: "Mari U", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00" },
            { nome: "Gleici√©le Nogueira", pseudo: "Mariana N.", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00" },
            { nome: "Lindisen Guiomar Lemos dos Santos", pseudo: "Ruama S.", squadPadrao: "SC", turnoPadrao: "Dom. √† Quar.", entradaPadrao: "08:00", saidaPadrao: "14:00" },
            { nome: "Maria Eduarda Ferreira Gusm√£o", pseudo: "Ruth G.", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00" },
            { nome: "Tha√≠s Hayelen", pseudo: "Raquel H.", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "08:00", saidaPadrao: "14:00" },
            { nome: "Rafaela Lins da Costa", pseudo: "Leila C.", squadPadrao: "SC", turnoPadrao: "FDS", entradaPadrao: "10:00", saidaPadrao: "16:00" },
            { nome: "Ana Claudia Ferreira de Souza", pseudo: "Ravena F.", squadPadrao: "SC", turnoPadrao: "Ter. √† S√°b.", entradaPadrao: "14:00", saidaPadrao: "20:00" },
            { nome: "Crislaine Gomes da Silva", pseudo: "Izabel G.", squadPadrao: "SC", turnoPadrao: "Dom. √† Quar.", entradaPadrao: "14:00", saidaPadrao: "20:00" },
            { nome: "Ilanna Rodrigues Nascimento", pseudo: "Noelle R.", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00" },
            { nome: "Isabelle Cristine Marques", pseudo: "√çsis M.", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00" },
            { nome: "Lidia Lorraine Silva Cruz", pseudo: "Alba C.", squadPadrao: "SC", turnoPadrao: "Quin. √† S√°b.", entradaPadrao: "14:00", saidaPadrao: "20:00" },
            { nome: "Thain√° Jaqueline Batista Ferreira", pseudo: "C√≠ntia B", squadPadrao: "SC", turnoPadrao: "Seg. √† Sex.", entradaPadrao: "14:00", saidaPadrao: "20:00" },
            { nome: "Elice Pisciotta", pseudo: "Yarin P.", squadPadrao: "Monitoria", turnoPadrao: "Semanal", entradaPadrao: "08:00", saidaPadrao: "14:00" },
            { nome: "D√©bora da Silva Lima de Jesus", pseudo: "Serena L", squadPadrao: "Monitoria", turnoPadrao: "Semanal", entradaPadrao: "08:00", saidaPadrao: "14:00" },
            { nome: "Ingrid de Arruda Azeredo", pseudo: "Duda A.", squadPadrao: "Coraliados", turnoPadrao: "Semanal", entradaPadrao: "08:00", saidaPadrao: "14:00" },
            { nome: "Vanessa Maria de Medeiros Abreu", pseudo: "Sara M", squadPadrao: "Coraliados", turnoPadrao: "Semanal", entradaPadrao: "14:00", saidaPadrao: "18:00" },
            { nome: "Marcia de Paulo Araujo de Souza", pseudo: "Maria Marc", squadPadrao: "Hunter", turnoPadrao: "Semanal", entradaPadrao: "11:00", saidaPadrao: "17:00" },
            { nome: "Juliana Dos Santos Candido", pseudo: "Mia C", squadPadrao: "Hunter", turnoPadrao: "Semanal", entradaPadrao: "11:00", saidaPadrao: "17:00" },
            { nome: "Pryscilla Santos Seabra", pseudo: "Paula", squadPadrao: "Vendas", turnoPadrao: "Semanal", entradaPadrao: "10:00", saidaPadrao: "16:00" },
            { nome: "Pamella Ferreira de Lima Amorim", pseudo: "Cassia A.", squadPadrao: "Rec. Cr√©dito", turnoPadrao: "Semanal", entradaPadrao: "10:00", saidaPadrao: "15:00" },
            { nome: "Mariana Bezerra Andr√©", pseudo: "Vit√≥ria M.", squadPadrao: "OJR", turnoPadrao: "Semanal", entradaPadrao: "09:00", saidaPadrao: "14:00" }
        ];

        // --- APP LOGIC ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const logsCol = `artifacts/${appId}/public/data/scooteiras_atividades`;
        const agentsCol = `artifacts/${appId}/public/data/scooteiras_cadastro`;

        let currentAgents = [];
        let currentHistoryList = [];

        // HELPER DE HORA
        const normalizeTime = (t) => {
            if(!t) return ""; // Retorna vazio se nao tiver
            t = t.trim();
            const parts = t.split(':');
            if (parts.length >= 2) {
                const h = parts[0].padStart(2, '0');
                const m = parts[1].padStart(2, '0');
                return `${h}:${m}`;
            }
            return t;
        };

        // Auth
        signInAnonymously(auth).then(() => {
            document.getElementById('auth-status').innerText = "Conectado";
            document.getElementById('auth-status').classList.remove('bg-indigo-800');
            document.getElementById('auth-status').classList.add('bg-emerald-600');
            initSquadSelect();
            loadAgents(); 
            loadHistorico();
        }).catch((error) => {
            console.error(error);
            document.getElementById('auth-status').innerText = "Erro Conex√£o";
            document.getElementById('auth-status').classList.add('bg-red-600');
        });

        // UI Helpers
        window.switchTab = (tabId) => {
            ['registro', 'relatorio', 'cadastro'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.replace('tab-inactive', 'tab-active');
        };

        const showMessage = (msg, type='info') => {
            const el = document.getElementById('message-box');
            el.innerText = msg;
            el.className = `mx-6 mt-6 p-4 text-sm rounded-lg shadow-sm border-l-4 transition-all block ${type === 'success' ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'bg-red-50 border-red-500 text-red-700'}`;
            setTimeout(() => el.classList.add('hidden'), 4000);
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');

        const initSquadSelect = () => {
             const sel = document.getElementById('new-squad');
             sel.innerHTML = SQUADS_OPCOES.map(s => `<option value="${s}">${s}</option>`).join('');
             
             // Populate Bulk Edit Squad Select
             const beSel = document.getElementById('be-squad');
             beSel.innerHTML = '<option value="">-- Manter Original --</option>' + SQUADS_OPCOES.map(s => `<option value="${s}">${s}</option>`).join('');
        };

        // --- AGENTS MANAGEMENT ---
        const loadAgents = async () => {
            const q = query(collection(db, agentsCol));
            const snap = await getDocs(q);
            
            if (snap.empty) {
                showMessage("Primeiro acesso detectado. Configurando banco de dados...", "info");
                await seedDatabase(true); 
                return; 
            }

            currentAgents = [];
            snap.forEach(d => currentAgents.push(d.data()));
            renderAgentsTable();
            renderSelectionList();
            renderRelatorioSelect();
        };

        const renderAgentsTable = () => {
            const tbody = document.getElementById('cadastro-list-body');
            tbody.innerHTML = '';
            currentAgents.sort((a,b) => a.nome.localeCompare(b.nome));
            currentAgents.forEach(a => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition border-b border-gray-50";
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${a.nome} <span class="text-gray-400 font-normal">(${a.pseudo})</span></td>
                    <td class="px-6 py-4"><span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full">${a.squadPadrao || '-'}</span></td>
                    <td class="px-6 py-4">${a.turnoPadrao || '-'}</td>
                    <td class="px-6 py-4 font-mono text-xs">${a.entradaPadrao} - ${a.saidaPadrao}</td>
                    <td class="px-6 py-4 text-right space-x-2">
                        <button class="text-indigo-600 hover:text-indigo-900" onclick="window.editAgent('${a.nome}')"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button class="text-red-400 hover:text-red-700" onclick="window.deleteAgent('${a.nome}')"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        };
        
        window.seedDatabase = async (silent = false) => {
            if(!silent && !confirm("Reenviar lista padr√£o?")) return;
            let count = 0;
            for(const a of MOCK_CADASTROS) {
                try { await setDoc(doc(db, agentsCol, a.nome), a); count++; } catch(e) {}
            }
            if(!silent) showMessage(`${count} scooteiras sincronizadas!`, 'success');
            loadAgents();
        };

        document.getElementById('add-agent-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('new-nome').value.trim();
            if(!nome) return;
            try {
                await setDoc(doc(db, agentsCol, nome), {
                    nome: nome,
                    pseudo: document.getElementById('new-pseudo').value,
                    squadPadrao: document.getElementById('new-squad').value,
                    turnoPadrao: document.getElementById('new-turno').value,
                    entradaPadrao: document.getElementById('new-entrada').value,
                    saidaPadrao: document.getElementById('new-saida').value
                });
                showMessage('Scooteira adicionada!', 'success');
                e.target.reset();
                loadAgents();
            } catch (err) { showMessage('Erro ao salvar.', 'error'); }
        });

        window.deleteAgent = async (id) => {
            if (await confirmAction()) { await deleteDoc(doc(db, agentsCol, id)); loadAgents(); showMessage('Removida.', 'success'); }
        };

        window.editAgent = (nome) => {
            const a = currentAgents.find(x => x.nome === nome);
            if(!a) return;
            const options = SQUADS_OPCOES.map(s => `<option value="${s}" ${s===a.squadPadrao?'selected':''}>${s}</option>`).join('');
            const m = document.createElement('div');
            m.id = 'edit-agent-modal';
            m.className = 'fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50';
            m.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
                    <h3 class="text-lg font-bold mb-4">Editar Scooteira</h3>
                    <form id="edit-agent-form" class="space-y-4">
                        <div><label class="block text-xs uppercase text-gray-500">Nome (ID)</label>
                        <input id="ea-nome" class="w-full p-2 border bg-gray-100 rounded text-gray-500" disabled value="${a.nome}"></div>
                        <div><label class="block text-xs uppercase text-gray-500">Pseudo</label>
                        <input id="ea-pseudo" class="w-full p-2 border rounded" value="${a.pseudo}"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs uppercase text-gray-500">Squad</label>
                            <select id="ea-squad" class="w-full p-2 border rounded">${options}</select></div>
                            <div><label class="block text-xs uppercase text-gray-500">Dias</label>
                            <input id="ea-dias" class="w-full p-2 border rounded" value="${a.turnoPadrao}"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs uppercase text-gray-500">Entrada</label>
                            <input type="time" id="ea-ent" class="w-full p-2 border rounded" value="${a.entradaPadrao}"></div>
                            <div><label class="block text-xs uppercase text-gray-500">Sa√≠da</label>
                            <input type="time" id="ea-sai" class="w-full p-2 border rounded" value="${a.saidaPadrao}"></div>
                        </div>
                        <div class="flex justify-end gap-2 mt-4">
                            <button type="button" class="px-4 py-2 border rounded hover:bg-gray-50" onclick="document.getElementById('edit-agent-modal').remove()">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Salvar</button>
                        </div>
                    </form>
                </div>`;
            document.body.appendChild(m);
            document.getElementById('edit-agent-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateDoc(doc(db, agentsCol, nome), {
                    pseudo: document.getElementById('ea-pseudo').value,
                    squadPadrao: document.getElementById('ea-squad').value,
                    turnoPadrao: document.getElementById('ea-dias').value,
                    entradaPadrao: document.getElementById('ea-ent').value,
                    saidaPadrao: document.getElementById('ea-sai').value
                });
                showMessage('Dados atualizados.', 'success');
                document.getElementById('edit-agent-modal').remove();
                loadAgents();
            });
        };

        // --- REGISTRO DI√ÅRIO ---
        window.showSelectionModal = () => { renderSelectionList(); window.openModal('selection-modal'); };

        const renderSelectionList = () => {
            const div = document.getElementById('agentes-checkbox-list');
            div.innerHTML = currentAgents.map(a => `
                <label class="flex items-center space-x-3 p-3 rounded-lg border border-gray-100 hover:bg-indigo-50 cursor-pointer transition">
                    <input type="checkbox" value="${a.nome}" class="agent-checkbox w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500">
                    <div><span class="font-medium text-gray-800">${a.nome}</span> <span class="text-xs text-gray-500">(${a.pseudo})</span> <span class="text-[10px] bg-gray-100 px-1 rounded">${a.squadPadrao}</span></div>
                </label>
            `).join('');
        };

        window.handleEntrySubmission = () => {
            const data = document.getElementById('data-atuacao').value;
            const selectedBoxes = document.querySelectorAll('.agent-checkbox:checked');
            if (!data || selectedBoxes.length === 0) { showMessage('Selecione data e scooteira.', 'error'); return; }
            const container = document.getElementById('agentes-detalhes-container');
            container.innerHTML = '';
            selectedBoxes.forEach(box => {
                const nome = box.value;
                const agent = currentAgents.find(a => a.nome === nome);
                container.innerHTML += `
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h4 class="font-bold text-indigo-900 mb-2">${agent.nome}</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <div><label class="text-xs">Entrada</label><input type="time" name="ent_${nome}" value="${agent.entradaPadrao}" class="w-full border rounded p-1"></div>
                            <div><label class="text-xs">Sa√≠da</label><input type="time" name="sai_${nome}" value="${agent.saidaPadrao}" class="w-full border rounded p-1"></div>
                            <div><label class="text-xs">Squad</label><input type="text" name="sq_${nome}" value="${agent.squadPadrao}" class="w-full border rounded p-1"></div>
                            <div><label class="text-xs">Turno</label><input type="text" name="trn_${nome}" value="${agent.turnoPadrao}" class="w-full border rounded p-1"></div>
                        </div>
                    </div>`;
            });
            window.openModal('details-modal');
        };

        document.getElementById('details-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dataStr = document.getElementById('data-atuacao').value;
            const selectedBoxes = document.querySelectorAll('.agent-checkbox:checked');
            
            for (const box of selectedBoxes) {
                const nome = box.value;
                const ent = document.querySelector(`input[name="ent_${nome}"]`).value;
                const sai = document.querySelector(`input[name="sai_${nome}"]`).value;
                const sq = document.querySelector(`input[name="sq_${nome}"]`).value;
                const trn = document.querySelector(`input[name="trn_${nome}"]`).value;
                
                const d1 = new Date(`2000-01-01T${ent}`);
                const d2 = new Date(`2000-01-01T${sai}`);
                let diff = (d2 - d1) / 1000 / 60 / 60; 
                if (diff < 0) diff += 24;
                
                await addDoc(collection(db, logsCol), {
                    data: dataStr,
                    mes: dataStr.substring(0, 7),
                    scooteira: nome,
                    squad: sq,
                    entrada: ent,
                    saida: sai,
                    turno: trn,
                    horas: parseFloat(diff.toFixed(2)),
                    timestamp: new Date()
                });
            }
            showMessage('Registros salvos!', 'success');
            window.closeModal('details-modal');
            
            const novoMes = dataStr.substring(0, 7);
            const mesAtual = document.getElementById('mes-select').value;
            if (novoMes !== mesAtual) document.getElementById('mes-select').value = novoMes;
            window.loadHistorico();
        });

        // --- HIST√ìRICO E A√á√ïES EM MASSA ---
        
        window.loadHistorico = async () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;
            
            const tbody = document.getElementById('historico-body');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-400">Carregando...</td></tr>';
            
            // Hide bulk bar on reload
            window.deselectAll(); 
            
            const q = query(collection(db, logsCol), where("mes", "==", mes));
            const snap = await getDocs(q);
            currentHistoryList = []; 
            snap.forEach(d => currentHistoryList.push({id: d.id, ...d.data()}));
            currentHistoryList.sort((a,b) => a.data.localeCompare(b.data));

            tbody.innerHTML = currentHistoryList.length ? '' : '<tr><td colspan="9" class="text-center py-8">Nenhum registro.</td></tr>';
            
            currentHistoryList.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <input type="checkbox" value="${item.id}" class="history-checkbox w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" onclick="window.updateBulkUI()">
                    </td>
                    <td class="px-6 py-4">${item.data.split('-').reverse().join('/')}</td>
                    <td class="px-6 py-4 font-bold text-gray-700">${item.scooteira}</td>
                    <td class="px-6 py-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${item.squad}</span></td>
                    <td class="px-6 py-4">${item.entrada}</td>
                    <td class="px-6 py-4">${item.saida}</td>
                    <td class="px-6 py-4">${item.horas}h</td>
                    <td class="px-6 py-4 text-xs text-gray-500">${item.turno}</td>
                    <td class="px-6 py-4 text-right flex justify-end space-x-3">
                        <button class="text-blue-500 hover:text-blue-700" onclick="window.editLog('${item.id}')" title="Editar"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button class="text-red-500 hover:text-red-700" onclick="window.deleteLog('${item.id}')" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
            updateStats(currentHistoryList);
        };

        // --- BULK ACTION LOGIC ---
        window.toggleSelectAll = () => {
            const master = document.getElementById('select-all-history');
            const boxes = document.querySelectorAll('.history-checkbox');
            boxes.forEach(b => b.checked = master.checked);
            window.updateBulkUI();
        };

        window.updateBulkUI = () => {
            const checked = document.querySelectorAll('.history-checkbox:checked');
            const bar = document.getElementById('bulk-actions-bar');
            document.getElementById('bulk-count').innerText = checked.length;
            
            if(checked.length > 0) {
                bar.classList.remove('hidden');
            } else {
                bar.classList.add('hidden');
            }
        };

        window.deselectAll = () => {
            document.getElementById('select-all-history').checked = false;
            document.querySelectorAll('.history-checkbox').forEach(b => b.checked = false);
            window.updateBulkUI();
        };

        window.openBulkEditModal = () => {
            // Reset fields
            document.getElementById('be-data').value = "";
            document.getElementById('be-squad').value = "";
            document.getElementById('be-ent').value = "";
            document.getElementById('be-sai').value = "";
            window.openModal('bulk-edit-modal');
        };
        
        window.confirmBulkEdit = async () => {
            const checked = document.querySelectorAll('.history-checkbox:checked');
            const ids = Array.from(checked).map(c => c.value);
            
            if(ids.length === 0) return;

            const newData = document.getElementById('be-data').value;
            const newSquad = document.getElementById('be-squad').value;
            const newEnt = document.getElementById('be-ent').value;
            const newSai = document.getElementById('be-sai').value;

            showMessage(`Atualizando ${ids.length} registros...`, 'info');
            window.closeModal('bulk-edit-modal');

            const batch = writeBatch(db); // Use batch for better performance (though limit is 500)
            let count = 0;

            for(const id of ids) {
                const original = currentHistoryList.find(i => i.id === id);
                if(!original) continue;

                // Determine final values (New OR Original)
                const ent = newEnt || original.entrada;
                const sai = newSai || original.saida;
                const dataStr = newData || original.data;
                const mes = dataStr.substring(0, 7);

                // Recalculate hours
                const d1 = new Date(`2000-01-01T${ent}`);
                const d2 = new Date(`2000-01-01T${sai}`);
                let diff = (d2 - d1) / 1000 / 60 / 60; 
                if (diff < 0) diff += 24;

                const updatePayload = {
                    entrada: ent,
                    saida: sai,
                    horas: parseFloat(diff.toFixed(2)),
                    data: dataStr,
                    mes: mes
                };

                if(newSquad) updatePayload.squad = newSquad;

                const docRef = doc(db, logsCol, id);
                // Firestore batch limit is 500, simple implementation for now
                await updateDoc(docRef, updatePayload);
                count++;
            }

            showMessage(`${count} registros atualizados!`, 'success');
            window.loadHistorico();
        };

        window.deleteBulkLogs = async () => {
            const checked = document.querySelectorAll('.history-checkbox:checked');
            if(checked.length === 0) return;

            if(confirm(`Tem certeza que deseja EXCLUIR ${checked.length} registros?`)) {
                showMessage(`Excluindo...`, 'info');
                for(const box of checked) {
                    await deleteDoc(doc(db, logsCol, box.value));
                }
                showMessage(`Registros exclu√≠dos.`, 'success');
                window.loadHistorico();
            }
        };

        // --- INDIVIDUAL EDIT LOGIC ---
        window.editLog = (id) => {
            const item = currentHistoryList.find(i => i.id === id);
            if(!item) return;
            document.getElementById('edit-log-id').value = id;
            document.getElementById('edit-log-nome').value = item.scooteira;
            document.getElementById('edit-log-data').value = item.data;
            document.getElementById('edit-log-ent').value = item.entrada;
            document.getElementById('edit-log-sai').value = item.saida;
            document.getElementById('edit-log-squad').value = item.squad;
            window.openModal('edit-log-modal');
        };

        window.saveEditedLog = async () => {
            const id = document.getElementById('edit-log-id').value;
            const dataStr = document.getElementById('edit-log-data').value;
            const ent = document.getElementById('edit-log-ent').value;
            const sai = document.getElementById('edit-log-sai').value;
            const sq = document.getElementById('edit-log-squad').value;

            const d1 = new Date(`2000-01-01T${ent}`);
            const d2 = new Date(`2000-01-01T${sai}`);
            let diff = (d2 - d1) / 1000 / 60 / 60; 
            if (diff < 0) diff += 24;

            try {
                await updateDoc(doc(db, logsCol, id), {
                    data: dataStr,
                    mes: dataStr.substring(0, 7),
                    entrada: ent,
                    saida: sai,
                    squad: sq,
                    horas: parseFloat(diff.toFixed(2))
                });
                showMessage('Registro atualizado!', 'success');
                window.closeModal('edit-log-modal');
                const novoMes = dataStr.substring(0, 7);
                if (document.getElementById('mes-select').value !== novoMes) {
                     document.getElementById('mes-select').value = novoMes;
                }
                window.loadHistorico();
            } catch(e) {
                console.error(e);
                showMessage('Erro ao atualizar.', 'error');
            }
        };

        window.deleteLog = async (id) => {
            if(await confirmAction()){
                await deleteDoc(doc(db, logsCol, id));
                loadHistorico();
            }
        };

        // --- IMPORTA√á√ÉO ---
        window.showImportModal = () => window.openModal('import-modal');

        window.handleImport = async () => {
            const text = document.getElementById('import-data-json').value;
            if(!text.trim()) { showMessage('Cole os dados primeiro.', 'error'); return; }

            const lines = text.split('\n');
            let successCount = 0;
            let lastProcessedMonth = null;

            for(let line of lines) {
                let cols = line.split('\t');
                if(cols.length < 5) cols = line.split(',');
                if(cols.length > 0 && (cols[0].includes('Data') || cols[1].includes('mail'))) continue;

                if(cols.length >= 8) {
                    const dataBr = cols[0].trim(); 
                    const pseudo = cols[2].trim(); 
                    const ent = normalizeTime(cols[4]); 
                    const sai = normalizeTime(cols[5]); 
                    const sq = cols[8].trim();     
                    const turno = cols[3] ? cols[3].trim() : "Importado";

                    if(!dataBr || !pseudo) continue;

                    const parts = dataBr.split('/');
                    if(parts.length !== 3) continue;
                    const dataIso = `${parts[2]}-${parts[1]}-${parts[0]}`; 
                    lastProcessedMonth = `${parts[2]}-${parts[1]}`;

                    const d1 = new Date(`2000-01-01T${ent}`);
                    const d2 = new Date(`2000-01-01T${sai}`);
                    let diff = (d2 - d1) / 1000 / 60 / 60; 
                    if (diff < 0) diff += 24;

                    try {
                        await addDoc(collection(db, logsCol), {
                            data: dataIso,
                            mes: dataIso.substring(0, 7),
                            scooteira: pseudo,
                            squad: sq || 'Importado',
                            entrada: ent,
                            saida: sai,
                            turno: turno,
                            horas: parseFloat(diff.toFixed(2)),
                            timestamp: new Date()
                        });
                        successCount++;
                    } catch(e) { console.error(e); }
                }
            }
            
            showMessage(`${successCount} registros importados!`, 'success');
            window.closeModal('import-modal');
            if(lastProcessedMonth) document.getElementById('mes-select').value = lastProcessedMonth;
            window.loadHistorico();
        };

        const confirmAction = () => {
            return new Promise((resolve) => {
                window.openModal('confirmation-modal');
                window.resolveConfirmation = (val) => {
                    window.closeModal('confirmation-modal');
                    resolve(val);
                };
            });
        };

        window.exportToCsv = async () => { 
             const mes = document.getElementById('mes-select').value;
             if (!mes) return;
             const q = query(collection(db, logsCol), where("mes", "==", mes));
             const snap = await getDocs(q);
             if(snap.empty) { showMessage('Nada para exportar.', 'error'); return; }
             let csv = "data:text/csv;charset=utf-8,Data,Scooteira,Squad,Entrada,Saida,Horas,Turno\n";
             snap.forEach(d => { const i = d.data(); csv += `${i.data},${i.scooteira},${i.squad},${i.entrada},${i.saida},${i.horas},${i.turno}\n`; });
             const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `atuacao_${mes}.csv`;
             document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        const updateStats = (list) => {
            const squads = {};
            list.forEach(i => { if(!squads[i.squad]) squads[i.squad] = 0; squads[i.squad] += i.horas; });
            document.getElementById('resumo-squads').innerHTML = Object.keys(squads).map(s => `
                <div class="bg-white p-4 rounded-lg border shadow-sm">
                    <span class="text-xs text-gray-500 uppercase">Squad ${s}</span>
                    <p class="text-2xl font-bold text-indigo-600">${squads[s].toFixed(1)}h</p>
                </div>`).join('');
        };
        
        window.loadRelatorioIndividual = async () => {
             const nome = document.getElementById('relatorio-agente-select').value;
             const mes = document.getElementById('relatorio-mes-select').value;
             if(!nome || !mes) return;
             const q = query(collection(db, logsCol), where("mes", "==", mes), where("scooteira", "==", nome));
             const snap = await getDocs(q);
             const list = [];
             snap.forEach(d => list.push(d.data()));
             list.sort((a,b) => a.data.localeCompare(b.data));
             const tbody = document.getElementById('relatorio-body');
             tbody.innerHTML = '';
             let totalH = 0;
             list.forEach(i => {
                 totalH += i.horas;
                 tbody.innerHTML += `<tr class="border-b"><td class="px-6 py-4">${i.data.split('-').reverse().join('/')}</td><td class="px-6 py-4">${i.squad}</td><td class="px-6 py-4">${i.entrada}</td><td class="px-6 py-4">${i.saida}</td><td class="px-6 py-4">${i.horas}h</td></tr>`;
             });
             document.getElementById('relatorio-resumo-cards').classList.remove('hidden');
             document.getElementById('resumo-total-dias').innerText = list.length;
             document.getElementById('resumo-total-horas').innerText = totalH.toFixed(2) + 'h';
        };
        
        const renderRelatorioSelect = () => {
             document.getElementById('relatorio-agente-select').innerHTML = '<option value="" disabled selected>Selecione...</option>' + currentAgents.map(a => `<option value="${a.nome}">${a.nome}</option>`).join('');
        };
        
        window.exportIndividualCsv = async () => {
            const nome = document.getElementById('relatorio-agente-select').value;
            const mes = document.getElementById('relatorio-mes-select').value;
            if(!nome || !mes) { showMessage('Selecione uma scooteira e m√™s.', 'error'); return; }
            const q = query(collection(db, logsCol), where("mes", "==", mes), where("scooteira", "==", nome));
            const snap = await getDocs(q);
            if(snap.empty) { showMessage('Sem dados para exportar.', 'error'); return; }
            let csvContent = "data:text/csv;charset=utf-8,Data,Squad,Entrada,Saida,Horas\n";
            snap.forEach(doc => { const d = doc.data(); csvContent += `${d.data},${d.squad},${d.entrada},${d.saida},${d.horas}\n`; });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `relatorio_${nome.split(' ')[0]}_${mes}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        
        window.analyzeMonthlyData = () => { document.getElementById('ai-analysis-content').innerHTML = "<h3>An√°lise</h3><p>Dados est√°veis.</p>"; window.openModal('ai-analysis-modal'); };
        window.analyzeIndividualData = () => { document.getElementById('ai-analysis-content').innerHTML = "<h3>Performance</h3><p>Regular.</p>"; window.openModal('ai-analysis-modal'); };

        window.onload = () => {
            const d = new Date();
            const m = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('mes-select').value = m;
            document.getElementById('relatorio-mes-select').value = m;
        };
    </script>
</body>
</html>
