<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dash Atuação - Scooto</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚜️</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; color: #334155; }
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        
        .cap-cell { font-size: 0.75rem; padding: 6px; text-align: center; border: 1px solid #e2e8f0; }
        .cap-header { font-size: 0.7rem; font-weight: 700; background-color: #f8fafc; padding: 8px; border: 1px solid #e2e8f0; color: #64748b; text-transform: uppercase; }
        .cap-warn-low { background-color: #fee2e2; color: #991b1b; }
        .cap-warn-high { background-color: #ffedd5; color: #9a3412; }
        .cap-ok { background-color: #dcfce7; color: #166534; }

        .week-group-header { cursor: pointer; background: #ffffff; border: 1px solid #e2e8f0; padding: 16px; border-radius: 12px; margin-bottom: 8px; transition: all 0.2s; }
        .week-group-header:hover { border-color: #4f46e5; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .week-content { display: none; margin-bottom: 20px; border: 1px solid #e2e8f0; border-radius: 0 0 12px 12px; overflow-x: auto; background: white; }
        .week-content.active { display: block; border-top: none; margin-top: -12px; }
        
        .squad-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-right: 4px; border: 1px solid currentColor; }
        .exchange-card { border-left: 4px solid #4f46e5; background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0; border-left-width: 4px; }
        .exchange-text { font-size: 0.85rem; line-height: 1.4; }
        .status-active { color: #166534; background: #dcfce7; }
        .status-inactive { color: #991b1b; background: #fee2e2; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8 pb-24">

    <div id="app" class="w-full max-w-full sm:max-w-7xl bg-white rounded-2xl shadow-xl overflow-hidden relative">

        <header class="bg-indigo-600 p-6 sm:p-10 text-white">
            <div class="flex justify-between items-center">
                <div>
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">⚜️</span>
                        <h1 class="text-3xl font-bold tracking-tight">Dash Atuação - Scooto</h1>
                    </div>
                    <p class="text-indigo-100 text-sm mt-1 ml-11">Gestão de Horas x Squads</p>
                </div>
                <div id="auth-status" class="bg-indigo-800 py-1 px-3 rounded text-xs font-mono">Conectando...</div>
            </div>
        </header>

        <div class="flex border-b border-gray-200 bg-gray-50 px-6 overflow-x-auto">
            <button id="tab-registro" class="py-4 px-6 text-sm font-semibold transition-all tab-active whitespace-nowrap" onclick="window.switchTab('registro')">Registro Diário</button>
            <button id="tab-capacidade" class="py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('capacidade')">Capacidade & Metas</button>
            <button id="tab-trocas" class="py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('trocas')">Trocas entre Scooteiras</button>
            <button id="tab-relatorio" class="py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('relatorio')">Relatórios</button>
            <button id="tab-cadastro" class="py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap" onclick="window.switchTab('cadastro')">Equipe</button>
        </div>

        <div class="p-6 sm:p-8 min-h-[500px]">

            <div id="content-registro" class="animate-fade-in">
                <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-3">
                            <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Data Atuação</label>
                            <input type="date" id="data-atuacao" class="w-full p-2.5 border-gray-300 rounded-lg text-sm">
                        </div>
                        <div class="md:col-span-6">
                            <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Quem trabalhou?</label>
                            <button onclick="window.openModal('selection-modal')" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-left text-sm flex justify-between items-center">
                                <span id="selected-count-label">Selecionar Scooteiras...</span>
                                <i data-lucide="users" class="w-4 h-4 text-gray-400"></i>
                            </button>
                        </div>
                        <div class="md:col-span-3">
                            <button onclick="window.handleEntrySubmission()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg font-bold shadow-md">Lançar Horas</button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Histórico</h2>
                    <input type="month" id="mes-select" onchange="window.loadHistorico()" class="border-gray-300 rounded-md text-sm">
                </div>
                <div id="resumo-squads" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8"></div>
                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3">Data</th>
                                <th class="px-6 py-3">Nome</th>
                                <th class="px-6 py-3">Squad</th>
                                <th class="px-6 py-3 text-center">Horário</th>
                                <th class="px-6 py-3 font-bold text-center">Total (Real x Contratado)</th>
                                <th class="px-6 py-3 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="historico-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-capacidade" class="hidden animate-fade-in">
                <div id="capacity-accordion-container" class="space-y-4"></div>
            </div>

            <div id="content-trocas" class="hidden animate-fade-in">
                <div id="trocas-accordion-container" class="space-y-4"></div>
            </div>

            <div id="content-relatorio" class="hidden animate-fade-in">
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Scooteira</label>
                            <select id="relatorio-agente-select" class="w-full p-2.5 border-gray-300 rounded-lg text-sm" onchange="window.loadRelatorioIndividual()"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Mês</label>
                            <input type="month" id="relatorio-mes-select" class="w-full p-2.5 border-gray-300 rounded-lg text-sm" onchange="window.loadRelatorioIndividual()">
                        </div>
                    </div>
                </div>
                <div id="relatorio-resumo-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 hidden"></div>
                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                            <tr><th class="px-6 py-3">Data</th><th class="px-6 py-3">Squad</th><th class="px-6 py-3">Entrada</th><th class="px-6 py-3">Saída</th><th class="px-6 py-3 font-bold">Total</th></tr>
                        </thead>
                        <tbody id="relatorio-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="content-cadastro" class="hidden animate-fade-in">
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-8">
                    <form id="add-agent-form" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <input type="text" id="new-nome" placeholder="Nome Completo" class="p-2 border rounded text-sm" required>
                        <input type="text" id="new-pseudo" placeholder="Pseudo" class="p-2 border rounded text-sm" required>
                        <select id="new-squad" class="p-2 border rounded text-sm"></select>
                        <input type="text" id="new-turno" placeholder="Ex: Seg-Sex" class="p-2 border rounded text-sm">
                        <input type="time" id="new-entrada" value="08:00" class="p-2 border rounded text-sm">
                        <input type="time" id="new-saida" value="14:00" class="p-2 border rounded text-sm">
                        <button type="submit" class="bg-indigo-600 text-white py-2 rounded font-bold lg:col-span-6">Salvar</button>
                    </form>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                            <tr><th class="px-6 py-3">Nome / Pseudo</th><th class="px-6 py-3 text-center">Status</th><th class="px-6 py-3 text-right">Ações</th></tr>
                        </thead>
                        <tbody id="cadastro-list-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="selection-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Seleção</h3>
            <div id="agentes-checkbox-list" class="space-y-2 max-h-96 overflow-y-auto mb-6"></div>
            <button onclick="window.closeModal('selection-modal')" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Concluir</button>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-3xl w-full max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-6 bg-indigo-600 text-white font-bold flex justify-between">
                <span>Confirmar Dados</span>
                <button onclick="window.closeModal('details-modal')"><i data-lucide="x"></i></button>
            </div>
            <form id="details-form" class="overflow-y-auto p-6 space-y-4 flex-1 bg-gray-50">
                <div id="agentes-detalhes-container" class="space-y-4"></div>
            </form>
            <div class="p-4 bg-white border-t flex justify-end">
                <button type="submit" form="details-form" class="bg-emerald-600 text-white px-8 py-2 rounded-xl font-bold shadow-lg">Salvar Tudo</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs, deleteDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBgKe2n4c6vL4-B0hSAGT16ELDUQLW0OTQ", authDomain: "atuacao2026.firebaseapp.com", projectId: "atuacao2026", storageBucket: "atuacao2026.firebasestorage.app", messagingSenderId: "563632231622", appId: "1:563632231622:web:ce3e04e43cc647614214f5" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const logsCol = `artifacts/atuacao2026/public/data/scooteiras_atividades`;
        const agentsCol = `artifacts/atuacao2026/public/data/scooteiras_cadastro`;

        const SQUADS_ATIVAS = ["SC", "CB", "Rec. Crédito", "OJR", "Monitoria"];
        const squadColorMap = { "SC": "emerald", "CB": "indigo", "Rec. Crédito": "amber", "OJR": "purple", "Monitoria": "cyan", "Outro": "slate" };
        const METAS_SQUAD = {
            "SC": { 1: 54, 2: 60, 3: 60, 4: 54, 5: 54, 6: 18, 0: 18 },
            "CB": { 1: 54, 2: 54, 3: 54, 4: 54, 5: 42, 6: 12, 0: 12 },
            "Rec. Crédito": { 1: 5, 2: 5, 3: 5, 4: 5, 5: 4, 6: 0, 0: 0 },
            "OJR": { 1: 5, 2: 5, 3: 5, 4: 5, 5: 4, 6: 0, 0: 0 }
        };

        let currentAgents = [];
        let currentHistoryList = [];

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        const normalizarSquad = (s) => {
            if (!s) return "Outro";
            const val = s.toUpperCase().trim();
            if (val.includes("REC") || val.includes("CRED")) return "Rec. Crédito";
            if (val.includes("SC") || val.includes("SPECIAL")) return "SC";
            if (val.includes("CB") || val.includes("BLOQUEADO")) return "CB";
            if (val.includes("OJR") || val.includes("JURIDICO")) return "OJR";
            return s;
        };

        signInAnonymously(auth).then(() => {
            document.getElementById('auth-status').innerText = "ONLINE";
            loadInitialData();
        });

        async function loadInitialData() {
            const d = new Date();
            const mesAtual = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('mes-select').value = mesAtual;
            document.getElementById('relatorio-mes-select').value = mesAtual;
            document.getElementById('new-squad').innerHTML = SQUADS_ATIVAS.map(s => `<option value="${s}">${s}</option>`).join('');
            await loadAgents();
            await loadHistorico();
        }

        window.switchTab = (tabId) => {
            ['registro', 'capacidade', 'relatorio', 'cadastro', 'trocas'].forEach(t => {
                const el = document.getElementById(`content-${t}`);
                if(el) el.classList.add('hidden');
                const btn = document.getElementById(`tab-${t}`);
                if(btn) btn.className = "py-4 px-6 text-sm font-semibold transition-all tab-inactive whitespace-nowrap";
            });
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).className = "py-4 px-6 text-sm font-semibold transition-all tab-active whitespace-nowrap";
            if (tabId === 'capacidade') renderCapacityAccordion();
            if (tabId === 'trocas') renderTrocasAccordion();
            lucide.createIcons();
        };

        const loadAgents = async () => {
            const snap = await getDocs(collection(db, agentsCol));
            currentAgents = [];
            snap.forEach(d => {
                const a = d.data();
                a.squadPadrao = normalizarSquad(a.squadPadrao);
                a.status = a.status || 'Ativa';
                currentAgents.push(a);
            });
            renderAgentsTable();
            renderSelectionList();
            renderRelatorioSelect();
        };

        const renderAgentsTable = () => {
            document.getElementById('cadastro-list-body').innerHTML = currentAgents.sort((a,b) => a.nome.localeCompare(b.nome)).map(a => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="px-6 py-4 font-medium">${a.nome} <br><small class="text-gray-400">Pseudo: ${a.pseudo}</small></td>
                    <td class="px-6 py-4 text-center">
                        <select onchange="window.toggleStatus('${a.nome}', this.value)" class="text-[10px] font-bold uppercase rounded-full px-2 py-1 ${a.status === 'Ativa' ? 'status-active' : 'status-inactive'}">
                            <option value="Ativa" ${a.status === 'Ativa' ? 'selected' : ''}>Ativa</option>
                            <option value="Distrato" ${a.status === 'Distrato' ? 'selected' : ''}>Distrato</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 text-right"><button onclick="window.deleteAgent('${a.nome}')" class="text-red-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                </tr>`).join('');
            lucide.createIcons();
        };

        window.toggleStatus = async (nome, novoStatus) => {
            await updateDoc(doc(db, agentsCol, nome), { status: novoStatus });
            loadAgents();
        };

        const renderSelectionList = () => {
            const ativas = currentAgents.filter(a => a.status === 'Ativa');
            document.getElementById('agentes-checkbox-list').innerHTML = ativas.map(a => `<label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" value="${a.nome}" class="agent-checkbox w-5 h-5 text-indigo-600 rounded"><span class="text-sm font-medium text-gray-700">${a.nome}</span></label>`).join('');
        };

        const renderRelatorioSelect = () => {
            document.getElementById('relatorio-agente-select').innerHTML = '<option value="" disabled selected>Escolher...</option>' + 
                currentAgents.sort((a,b) => a.nome.localeCompare(b.nome)).map(a => `<option value="${a.nome}">${a.nome}</option>`).join('');
        };

        window.handleEntrySubmission = () => {
            const data = document.getElementById('data-atuacao').value;
            const selected = Array.from(document.querySelectorAll('.agent-checkbox:checked')).map(cb => cb.value);
            if (!data || selected.length === 0) return alert("Selecione data e equipe.");
            document.getElementById('agentes-detalhes-container').innerHTML = selected.map(nome => {
                const a = currentAgents.find(x => x.nome === nome);
                return `<div class="confirm-row p-4 border rounded-lg bg-white relative" data-nome="${a.nome}"><button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button><div class="font-bold text-indigo-600 mb-2">${a.nome}</div><div class="grid grid-cols-2 lg:grid-cols-4 gap-3"><input type="time" value="${a.entradaPadrao}" class="confirm-ent border p-1 rounded text-sm"><input type="time" value="${a.saidaPadrao}" class="confirm-sai border p-1 rounded text-sm"><select class="confirm-squad border p-1 rounded text-sm">${SQUADS_ATIVAS.map(s => `<option value="${s}" ${s === a.squadPadrao ? 'selected' : ''}>${s}</option>`).join('')}</select><input type="text" value="${a.turnoPadrao}" class="confirm-turno border p-1 rounded text-sm"></div></div>`;
            }).join('');
            window.openModal('details-modal');
            lucide.createIcons();
        };

        document.getElementById('details-form').onsubmit = async (e) => {
            e.preventDefault();
            const dataStr = document.getElementById('data-atuacao').value;
            const rows = document.querySelectorAll('.confirm-row');
            for (const row of rows) {
                const nome = row.dataset.nome;
                const ent = row.querySelector('.confirm-ent').value;
                const sai = row.querySelector('.confirm-sai').value;
                const sq = row.querySelector('.confirm-squad').value;
                const d1 = new Date(`2000-01-01T${ent}`);
                const d2 = new Date(`2000-01-01T${sai}`);
                let diff = (d2 - d1) / 3600000;
                if (diff < 0) diff += 24;
                await addDoc(collection(db, logsCol), { data: dataStr, mes: dataStr.substring(0, 7), scooteira: nome, squad: sq, entrada: ent, saida: sai, horas: parseFloat(diff.toFixed(2)), timestamp: new Date() });
            }
            window.closeModal('details-modal');
            loadHistorico();
        };

        window.loadHistorico = async () => {
            const mes = document.getElementById('mes-select').value;
            const snap = await getDocs(query(collection(db, logsCol), where("mes", "==", mes)));
            currentHistoryList = [];
            snap.forEach(d => {
                const item = { id: d.id, ...d.data() };
                item.squad = normalizarSquad(item.squad);
                currentHistoryList.push(item);
            });
            currentHistoryList.sort((a,b) => b.data.localeCompare(a.data) || b.entrada.localeCompare(a.entrada));
            
            document.getElementById('historico-body').innerHTML = currentHistoryList.map(item => {
                const agente = currentAgents.find(a => a.nome === item.scooteira || a.pseudo === item.scooteira);
                let contratado = 0;
                if (agente) {
                    const h1 = new Date(`2000-01-01T${agente.entradaPadrao}`);
                    const h2 = new Date(`2000-01-01T${agente.saidaPadrao}`);
                    contratado = (h2 - h1) / 3600000;
                    if (contratado < 0) contratado += 24;
                }
                let corTotal = item.horas < contratado ? "text-red-500" : (item.horas > contratado ? "text-amber-600" : "text-emerald-600");
                return `<tr class="hover:bg-gray-50 border-b"><td class="px-6 py-4 text-xs">${item.data.split('-').reverse().join('/')}</td><td class="px-6 py-4 font-bold text-gray-800">${item.scooteira}</td><td class="px-6 py-4"><span class="squad-tag text-${squadColorMap[item.squad]}-600 border-${squadColorMap[item.squad]}-600">${item.squad}</span></td><td class="px-6 py-4 text-xs text-center">${item.entrada} - ${item.saida}</td><td class="px-6 py-4 font-bold text-center ${corTotal}">${item.horas.toFixed(1)}h <small class="text-gray-300 font-normal">/ ${contratado.toFixed(1)}h</small></td><td class="px-6 py-4 text-right"><button onclick="window.deleteLog('${item.id}')" class="text-red-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`;
            }).join('');
            lucide.createIcons();
            updateStats();
        };

        const updateStats = () => {
            const totals = {};
            currentHistoryList.forEach(i => { totals[i.squad] = (totals[i.squad] || 0) + i.horas; });
            document.getElementById('resumo-squads').innerHTML = SQUADS_ATIVAS.map(s => `<div class="bg-white p-4 rounded-xl border-t-4 border-${squadColorMap[s]}-500 shadow-sm"><div class="text-[10px] text-gray-400 uppercase font-bold mb-1">${s}</div><div class="text-xl font-bold text-gray-700">${(totals[s] || 0).toFixed(1)}h</div></div>`).join('');
        };

        window.renderCapacityAccordion = () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;
            const [ano, mesNum] = mes.split('-').map(Number);
            const container = document.getElementById('capacity-accordion-container');
            container.innerHTML = "";
            const dataMap = {};
            currentHistoryList.forEach(log => {
                if(!dataMap[log.data]) dataMap[log.data] = {};
                dataMap[log.data][log.squad] = (dataMap[log.data][log.squad] || 0) + log.horas;
            });
            const weeks = {};
            const first = new Date(ano, mesNum - 1, 1);
            const last = new Date(ano, mesNum, 0);
            for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
                const w = getISOWeek(new Date(d));
                if (!weeks[w]) weeks[w] = [];
                weeks[w].push(new Date(d));
            }
            Object.keys(weeks).forEach(wNum => {
                const days = weeks[wNum];
                const weekId = `week-${wNum}`;
                const header = document.createElement('div');
                header.className = "week-group-header shadow-sm flex justify-between items-center";
                header.innerHTML = `<div><span class="font-bold text-indigo-700">Meta Semana ${wNum}</span></div>`;
                header.onclick = () => document.getElementById(weekId).classList.toggle('active');
                const content = document.createElement('div');
                content.id = weekId;
                content.className = "week-content";
                let tableHtml = `<table class="w-full"><thead><tr><th class="cap-header text-left">Dia</th>`;
                SQUADS_ATIVAS.forEach(s => tableHtml += `<th class="cap-header">${s}</th>`);
                tableHtml += `</tr></thead><tbody>`;
                days.forEach(dateObj => {
                    const dateKey = dateObj.toISOString().split('T')[0];
                    const dow = dateObj.getDay();
                    tableHtml += `<tr><td class="cap-cell font-bold bg-gray-50 text-left px-4">${dateObj.toLocaleDateString('pt-BR', {day:'2-digit', weekday:'short'})}</td>`;
                    SQUADS_ATIVAS.forEach(squad => {
                        const actual = (dataMap[dateKey] && dataMap[dateKey][squad]) ? dataMap[dateKey][squad] : 0;
                        const target = (METAS_SQUAD[squad] && METAS_SQUAD[squad][dow] !== undefined) ? METAS_SQUAD[squad][dow] : 0;
                        let cellClass = target > 0 ? (actual < target ? "cap-cell cap-warn-low" : (actual > target ? "cap-cell cap-warn-high" : "cap-cell cap-ok")) : "cap-cell";
                        tableHtml += `<td class="${cellClass}">${actual.toFixed(1)}h <br><small class="opacity-40 text-[9px]">Meta: ${target}</small></td>`;
                    });
                    tableHtml += `</tr>`;
                });
                content.innerHTML = tableHtml + `</tbody></table>`;
                container.appendChild(header);
                container.appendChild(content);
            });
        };

        window.renderTrocasAccordion = () => {
            const mes = document.getElementById('mes-select').value;
            if(!mes) return;
            const container = document.getElementById('trocas-accordion-container');
            container.innerHTML = "";
            const dailyLogs = {};
            currentHistoryList.forEach(log => { if(!dailyLogs[log.data]) dailyLogs[log.data] = []; dailyLogs[log.data].push(log); });
            const [ano, mesNum] = mes.split('-').map(Number);
            const weeks = {};
            const first = new Date(ano, mesNum - 1, 1);
            const last = new Date(ano, mesNum, 0);
            for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
                const w = getISOWeek(new Date(d));
                if (!weeks[w]) weeks[w] = [];
                weeks[w].push(new Date(d));
            }
            Object.keys(weeks).forEach(wNum => {
                const days = weeks[wNum];
                const weekId = `trocas-week-${wNum}`;
                const header = document.createElement('div');
                header.className = "week-group-header shadow-sm flex justify-between items-center";
                header.innerHTML = `<div><span class="font-bold text-indigo-700">Trocas Semana ${wNum}</span></div>`;
                header.onclick = () => document.getElementById(weekId).classList.toggle('active');
                const content = document.createElement('div');
                content.id = weekId;
                content.className = "week-content p-4";
                let trocasHtml = "";
                days.forEach(dateObj => {
                    const dateKey = dateObj.toISOString().split('T')[0];
                    const logsDia = dailyLogs[dateKey] || [];
                    const diaSeman = dateObj.toLocaleDateString('pt-BR', { weekday: 'short' }).toLowerCase();
                    const extras = logsDia.filter(l => {
                        const a = currentAgents.find(ag => ag.nome === l.scooteira || ag.pseudo === l.scooteira);
                        return a && !(a.turnoPadrao.toLowerCase().includes(diaSeman) || a.turnoPadrao.toLowerCase().includes("seg-sex"));
                    });
                    const ausentes = currentAgents.filter(a => {
                        const devia = a.status !== 'Distrato' && (a.turnoPadrao.toLowerCase().includes(diaSeman) || a.turnoPadrao.toLowerCase().includes("seg-sex"));
                        const estava = logsDia.some(l => l.scooteira === a.nome || l.scooteira === a.pseudo);
                        return devia && !estava;
                    });
                    if(extras.length > 0 && ausentes.length > 0) {
                        let diaHtml = "";
                        extras.forEach(ex => {
                            const exSq = normalizarSquad(ex.squad);
                            const par = ausentes.find(au => normalizarSquad(au.squadPadrao) === exSq);
                            if(par) diaHtml += `<div class="exchange-card"><p class="exchange-text"><strong class="text-indigo-700">${ex.scooteira}</strong> atuou na cadeira de <strong class="text-gray-700">${par.nome}</strong>.</p></div>`;
                        });
                        if(diaHtml) trocasHtml += `<div class="mb-4 border-b pb-2"><h4 class="font-bold text-xs text-indigo-900 mb-2">${dateObj.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'})}</h4>${diaHtml}</div>`;
                    }
                });
                content.innerHTML = trocasHtml || `<p class="text-xs text-gray-400 italic text-center py-2">Nenhuma troca encontrada.</p>`;
                container.appendChild(header);
                container.appendChild(content);
            });
            lucide.createIcons();
        };

        window.loadRelatorioIndividual = async () => {
            const nome = document.getElementById('relatorio-agente-select').value;
            const mes = document.getElementById('relatorio-mes-select').value;
            const table = document.getElementById('relatorio-body');
            const cards = document.getElementById('relatorio-resumo-cards');
            if(!nome || !mes) return;
            table.innerHTML = '<tr><td colspan="5" class="text-center py-4">Buscando...</td></tr>';
            const agente = currentAgents.find(a => a.nome === nome);
            const pseudo = agente ? agente.pseudo : "";
            const snap = await getDocs(query(collection(db, logsCol), where("mes", "==", mes)));
            const list = [];
            let total = 0;
            const sqTotal = {};
            snap.forEach(d => {
                const data = d.data();
                if(data.scooteira === nome || data.scooteira === pseudo) {
                    const sq = normalizarSquad(data.squad);
                    list.push({ ...data, squad: sq });
                    total += data.horas;
                    sqTotal[sq] = (sqTotal[sq] || 0) + data.horas;
                }
            });
            list.sort((a,b) => b.data.localeCompare(a.data));
            cards.classList.remove('hidden');
            let sqHtml = "";
            Object.keys(sqTotal).forEach(s => { sqHtml += `<div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-${squadColorMap[s] || 'gray'}-500"><div class="text-xs text-gray-400 uppercase font-bold">${s}</div><div class="text-xl font-bold text-gray-700">${sqTotal[s].toFixed(1)}h</div></div>`; });
            cards.innerHTML = `<div class="bg-indigo-600 p-5 rounded-xl shadow-md text-white"><div class="text-xs opacity-80 uppercase font-bold">Total Mês</div><div class="text-3xl font-bold">${total.toFixed(1)}h</div></div>${sqHtml}`;
            table.innerHTML = list.length === 0 ? '<tr><td colspan="5" class="text-center py-8">Vazio.</td></tr>' : list.map(i => `<tr class="border-b"><td class="px-6 py-4">${i.data.split('-').reverse().join('/')}</td><td class="px-6 py-4">${i.squad}</td><td class="px-6 py-4 text-center">${i.entrada}</td><td class="px-6 py-4 text-center">${i.saida}</td><td class="px-6 py-4 font-bold text-center text-indigo-600">${i.horas.toFixed(1)}h</td></tr>`).join('');
        };

        function getISOWeek(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        document.getElementById('add-agent-form').onsubmit = async (e) => {
            e.preventDefault();
            const nome = document.getElementById('new-nome').value;
            await setDoc(doc(db, agentsCol, nome), {
                nome: nome, pseudo: document.getElementById('new-pseudo').value,
                squadPadrao: document.getElementById('new-squad').value, turnoPadrao: document.getElementById('new-turno').value,
                entradaPadrao: document.getElementById('new-entrada').value, saidaPadrao: document.getElementById('new-saida').value,
                status: 'Ativa'
            });
            document.getElementById('add-agent-form').reset();
            loadAgents();
        };

        window.deleteLog = async (id) => { if(confirm("Excluir?")) { await deleteDoc(doc(db, logsCol, id)); loadHistorico(); } };
        window.deleteAgent = async (id) => { if(confirm("Excluir?")) { await deleteDoc(doc(db, agentsCol, id)); loadAgents(); } };
    </script>
</body>
</html>
